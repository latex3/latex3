% \iffalse
%% File xo-page.dtx (C) Copyright 1999-2000 Frank Mittelbach, David Carlisle, Chris Rowley
%%                  (C) Copyright 2004-2007 Frank Mittelbach, LaTeX3 Project
%%
%% It may be distributed and/or modified under the conditions of the
%% LaTeX Project Public License (LPPL), either version 1.3c of this
%% license or (at your option) any later version.  The latest version
%% of this license is in the file
%%
%%    http://www.latex-project.org/lppl.txt
%%
%% This file is part of the ``xor bundle'' (The Work in LPPL)
%% and all files in that bundle must be distributed together.
%%
%% The released version of this bundle is available from CTAN.
%%
%% -----------------------------------------------------------------------
%%
%% The development version of the bundle can be found at
%%
%%    http://www.latex-project.org/cgi-bin/cvsweb.cgi/
%%
%% for those people who are interested.
%%
%%%%%%%%%%%
%% NOTE: %%
%%%%%%%%%%%
%%
%%   Snapshots taken from the repository represent work in progress and may
%%   not work or may contain conflicting material!  We therefore ask
%%   people _not_ to put them into distributions, archives, etc. without
%%   prior consultation with the LaTeX Project Team.
%%
%% -----------------------------------------------------------------------
%%
\RequirePackage{l3names}
\GetIdInfo $Id$
          {xo-page}
\ProvidesExplPackage{\filename}
  {\filedate}{\fileversion}{\filedescription}
% \fi
%
%
%
%
%
% \subsection{Footnote setup}
%
%
%
%  \begin{macro}{\g_xor_footins_box}
%    We hide the fact that the insertion registers are all tied together. This
%    needs some further cleanup as it should not be done via |\def_...| and
%    the reference to |\footins| should comepletely vanish.\footnote{fix}
%    \begin{macrocode}
\let_new:NN  \g_xor_footins_box \footins
\def_new:Npn \g_xor_footins_int  {\count\footins}  
\def_new:Npn \g_xor_footins_dim  {\dimen\footins}  
\def_new:Npn \g_xor_footins_skip {\skip\footins}  
\def_new:Npn \g_xor_footins_toks {\toks\footins}  
%    \end{macrocode}
%  \end{macro}
%
%
%  \begin{macro}{\g_xor_extrains_box}
%
%    \begin{macrocode}
\newinsert\g_xor_extrains_box

\def_new:Npn \g_xor_extrains_int  {\count\g_xor_extrains_box}  
\def_new:Npn \g_xor_extrains_dim  {\dimen\g_xor_extrains_box}  
\def_new:Npn \g_xor_extrains_skip {\skip\g_xor_extrains_box}  
\def_new:Npn \g_xor_extrains_toks {\toks\g_xor_extrains_box}  

\g_xor_extrains_skip=10pt plus 10pt\relax
\g_xor_extrains_int=1000 \relax
\g_xor_extrains_dim=\textheight \relax

\def \@reinserts{%
  \ifvoid\footins\else\insert\footins{\unvbox\footins}\fi
  \ifvbox\@kludgeins\insert\@kludgeins
                      {\unvbox\@kludgeins}\fi
  \ifvoid\g_xor_extrains_box\else
      \insert\g_xor_extrains_box{\unvbox\g_xor_extrains_box}\fi
}
%    \end{macrocode}
%  \end{macro}
%
%
%
%
%
% \begin{macro}{\xor_initialize_column_footins_action:}
%    The |\xor_initialize_column_footins_action:| is a hook to add code to the
%    column initialisation phase related to the footnote insertions. For
%    example, when all footnotes are accumulated in the last column we
%    need to make footnote insertions invisible when gathering
%    material for the first columns.
%    \begin{macrocode}
\let:NN \xor_initialize_column_footins_action:\do_nothing:
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\xor_initialize_page_footins_action:}
%    The |\xor_initialize_page_footins_action:| is a hook to add code when
%    we start a new page
%    \begin{macrocode}
\let:NN \xor_initialize_page_footins_action:\do_nothing:
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\xor_initialize_balance_footins_action:}
%    The |\xor_initialize_balance_footins_action:| is a hook to add code to the
%    balance initialisation phase related to the footnote insertions.
%    \begin{macrocode}
\let:NN \xor_initialize_balance_footins_action:\do_nothing:
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\xor_column_end_footins_action:}
%    The |\xor_column_end_footins_action:| hook is called in the
%    |\xor_OR_grab_trial_cols:| and the |xor_OR_grab_best_cols:| output routine to do
%    something to the accumulated footnote insertions if
%    necessary. I.e., it is called for every column.
%    \begin{macrocode}
\let:NN \xor_column_end_footins_action:\do_nothing:
%    \end{macrocode}
% \end{macro}
%
%
%
%    \begin{macrocode}
\DeclareTemplateType{footnotesetup}{0}
%    \end{macrocode}
%
%
%
%
%
% \subsubsection{Helper stuff}
%
%
%
% \begin{macro}{\g_xor_final_footins_skip}
%    \begin{macrocode}
\skip_new:N \g_xor_final_footins_skip
%    \end{macrocode}
% \end{macro}
%
%  \begin{macro}{\g_xor_saved_footins_box}
%  \begin{macro}{\g_xor_saved_footins_dim}
%    
%    \begin{macrocode}
\box_new:N \g_xor_saved_footins_box
\dim_new:N \g_xor_saved_footins_dim
%    \end{macrocode}
%  \end{macro}
%  \end{macro}
%
%
%
%  \begin{macro}{\g_xor_footins_hsize_dim}
%    Horizontal size for footnotes needs to be set depending on style used.
%    \begin{macrocode}
\dim_new:N \g_xor_footins_hsize_dim
%    \end{macrocode}
%  \end{macro}
%



%  \begin{macro}{\g_xor_footins_col_num}
%    
%    \begin{macrocode}
\num_new:N \g_xor_footins_col_num
%    \end{macrocode}
%  \end{macro}

%  \begin{macro}{\g_xor_footins_multicolumn_final_run_bool}
%    
%    \begin{macrocode}
\bool_new:N \g_xor_footins_multicolumn_final_run_bool
%    \end{macrocode}
%  \end{macro}



%
% \subsubsection{Footnote setup standard}
%
%
% \begin{macro}{std (footnotesetup)}
%    \begin{macrocode}
\DeclareTemplate{footnotesetup}{std}{0}{
   text-sep    =+l \g_xor_footins_skip,
   max-height  =+l \g_xor_footins_dim,
 }
 {
  \skip_gset:Nn \g_xor_footins_skip {10pt plus 5pt}
  \dim_gset:Nn  \g_xor_footins_dim  {.7\textheight}


  \DoParameterAssignments
%    \end{macrocode}
%    One could make the width of the footnotes configurable (within
%    limits). Also, need to check when it actually gets assigned. This may not
%    be the right place
%    \begin{macrocode}
  \dim_gset:Nn \g_xor_footins_hsize_dim \columnwidth
  \int_gset:Nn \g_xor_footins_int       \c_thousand
%    \end{macrocode}
%    
%    \begin{macrocode}
  \let:NN \xor_initialize_page_footins_action:    \do_nothing:
  \let:NN \xor_initialize_column_footins_action:  \do_nothing:
  \let:NN \xor_initialize_balance_footins_action: \do_nothing:
  \let:NN \xor_column_end_footins_action:         \do_nothing:
 }
%    \end{macrocode}
%  \end{macro}
%
%
%
% \subsubsection{Footnote setup ftnright}
%
% In this section we provide the code for running all footnotes in the
% last column.
%
% \begin{macro}{ftnright (footnotesetup)}
%
%    \begin{macrocode}
\DeclareTemplate{footnotesetup}{ftnright}{0}{
   text-sep    =+l \g_xor_final_footins_skip,
   max-height  =+l \g_xor_footins_dim,
 }
 {

  \skip_gset:Nn \g_xor_final_footins_skip {10pt plus 5pt}
  \dim_gset:Nn  \g_xor_footins_dim \textheight

  \dim_gset:Nn  \g_xor_footins_hsize_dim \columnwidth

  \DoParameterAssignments

  \let:NN \xor_initialize_page_footins_action:   \xor_initialize_page_footins_ftnright:
  \let:NN \xor_initialize_column_footins_action: \xor_initialize_column_footins_ftnright:
  \let:NN \xor_initialize_balance_footins_action:\do_nothing: 
  \let:NN \xor_column_end_footins_action:        \xor_deal_with_footins_ftnright:

 }
%    \end{macrocode}
% \end{macro}
%
%
%
%
%
%
% \begin{macro}{\xor_initialize_page_footins_ftnright:}
%    \begin{macrocode}
\def_new:Npn \xor_initialize_page_footins_ftnright: {
%<*trace>
  \trace_push:n{xor_initialize_page_footins_ftnright:}
%</trace>
  \box_gclear:N \g_xor_footins_box
  \skip_gset:Nn \g_xor_footins_skip \c_zero_skip
  \int_gzero:N  \g_xor_footins_int
  \dim_gset:Nn  \g_xor_footins_dim \textheight
%<*trace>
  \trace_pop:n{xor_initialize_page_footins_ftnright:}
%</trace>
}
%    \end{macrocode}
% \end{macro}
%
%
%  \begin{macro}{\xor_initialize_column_footins_ftnright:}
%    
%    \begin{macrocode}
\def_new:Npn \xor_initialize_column_footins_ftnright: { 
%<*trace>
  \trace:n{ftnspread:~ page =~ \num_use:N\g_xor_page_absolute_num}
  \trace:n{ftnspread:~ col~ =~ \int_use:N\g_xor_curr_col_int}
  \trace:n{ftnspread:~ int~ =~ \skip_use:N\g_xor_footins_int}
  \trace:n{ftnspread:~ skip =~ \skip_use:N\g_xor_footins_skip}
%</trace>
}
%    \end{macrocode}
%  \end{macro}
%
%
%
% \begin{macro}{\xor_deal_with_footins_ftnright:}
%    \begin{macrocode}
\def_new:Npn \xor_deal_with_footins_ftnright: {
%<*trace>
  \trace_push:n{xor_deal_with_footins_ftnright:}
%</trace>
%    \end{macrocode}
%    If we are not in the last column we save any footnotes accumulated in
%    |\g_xor_footins_box| in a separate |\g_xor_saved_footins_box| box. This
%    way any later code that checks |\g_xor_footins_box| for constraints will
%    not fire incorrectly.
%    \begin{macrocode}
     \int_compare:nNnTF \g_xor_curr_col_int < \g_xor_cols_int
      {
%<*trace>
       \trace:n{ftnspread:~not~ last~ col}
%</trace>
%    \end{macrocode}
%    For any column other than the last we simply return the footnotes so that
%    they show up in the next column.
%    \begin{macrocode}
 	  \box_if_empty:NF \g_xor_footins_box
             {
	      \insert\g_xor_footins_box
                     { \vbox_unpack_clear:N \g_xor_footins_box }
             }
%    \end{macrocode}
%    If we are in the second last column we also have to change the
%    procedure: we now have to modify the insertion register values so that from now on
%    footnotes need space in the column.\footnote{Not correctly
%    handled is the case that we have accumulated more than a full
%    column of footnotes before!}
%    \begin{macrocode}
       \int_set:Nn \l_tmpa_int \g_xor_cols_int
       \int_decr:N \l_tmpa_int
       \int_compare:nNnT \g_xor_curr_col_int = \l_tmpa_int % cur col = second
                                                           %           last col
         {
%<*trace>
       \trace:n{ftnspread:~second~ last~ col~ preparing~ typesetting}
%</trace>
	  \int_gset:Nn  \g_xor_footins_int  \c_thousand
	  \skip_gset:Nn \g_xor_footins_skip \g_xor_final_footins_skip
         }
      }
      {
%<*trace>
          \trace:n{ftnspread:~  last~ col}
          \box_if_empty:NF \g_xor_footins_box
            {
             \trace:n{ftnspread:~ footnotes~ not~ empty}
%    \end{macrocode}
%    Perhaps one can do something about the situation that a footnote got
%    split (other than prevent it), e.g., allowing it to get typeset on the
%    next column in that case \ldots
%    \begin{macrocode}
             \int_compare:nNnT \insertpenalties > 0
               { \trace:n{ftnspread:~ footnote~ got~ split} }
            }
%</trace>
      }
%<*trace>
  \trace_pop:n{xor_deal_with_footins_ftnright:}
%</trace>
}
%    \end{macrocode}
% \end{macro}
%
%
%
%
% \subsubsection{Footnote setup ftnrightspread}
%
% In this section we provide the code for running all footnotes in the
% last column.
%
% \begin{macro}{ftnrightspread (footnotesetup)}
%
%    \begin{macrocode}
\DeclareTemplate{footnotesetup}{ftnrightspread}{0}{
   text-sep    =+l \g_xor_final_footins_skip,
   max-height  =+l \g_xor_footins_dim,
 }
 {

  \skip_gset:Nn \g_xor_final_footins_skip {10pt plus 5pt}
  \dim_gset:Nn  \g_xor_footins_dim \textheight

  \dim_gset:Nn  \g_xor_footins_hsize_dim \columnwidth

  \DoParameterAssignments

  \let:NN \xor_initialize_page_footins_action:   \xor_initialize_page_footins_ftnrightspread:
  \let:NN \xor_initialize_column_footins_action: \xor_initialize_column_footins_ftnrightspread:
  \let:NN \xor_initialize_balance_footins_action:\xor_initialize_balance_footins_ftnrightspread:
  \let:NN \xor_column_end_footins_action:        \xor_deal_with_footins_ftnrightspread:

 }
%    \end{macrocode}
% \end{macro}
%
%


%
% \begin{macro}{\xor_initialize_balance_footins_ftnrightspread:}
%    \begin{macrocode}
\def_new:Npn \xor_initialize_balance_footins_ftnrightspread: {}
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\xor_initialize_column_footins_ftnrightspread:}
%    \begin{macrocode}
\def_new:Npn \xor_initialize_column_footins_ftnrightspread: { 
  \xor_initialize_column_footins_ftnright:
}
%    \end{macrocode}
% \end{macro}
%
%
%
%
% \begin{macro}{\xor_initialize_page_footins_ftnrightspread:}
%    \begin{macrocode}
\def_new:Npn \xor_initialize_page_footins_ftnrightspread: {
%<*trace>
  \trace_push:n{ftnspread:~xor_initialize_page_footins_ftnrightspread:}
%</trace>
  \int_if_odd:nFT \g_xor_page_absolute_num
    { 
%<*trace>
  \trace:n{ftnspread:~even~ page}
%</trace>
     \box_gclear:N \g_xor_footins_box
     \skip_gset:Nn \g_xor_footins_skip \c_zero_skip
     \int_gzero:N  \g_xor_footins_int
     \dim_gset:Nn  \g_xor_footins_dim \textheight
    }
    {
%<*trace>
  \trace:n{ftnspread:~odd~ page}
%</trace>
     \int_compare:nNnTF \g_xor_cols_int = 1
        {
%<*trace>
         \trace:n{ftnspread:~single~ column~ prepare~ typesetting}
%</trace>
         \int_gset:Nn  \g_xor_footins_int  \c_thousand
         \skip_gset:Nn \g_xor_footins_skip \g_xor_final_footins_skip
        }
        {
         \skip_gset:Nn \g_xor_footins_skip \c_zero_skip
         \int_gzero:N  \g_xor_footins_int
         \dim_gset:Nn  \g_xor_footins_dim \textheight                   %%%% ????
       }
    }
%<*trace>
  \trace_pop:n{ftnspread:~xor_initialize_page_footins_ftnrightspread:}
%</trace>
}
%    \end{macrocode}
% \end{macro}
%
%
%
%
%
% \begin{macro}{\xor_deal_with_footins_ftnrightspread:}
%    \begin{macrocode}

\def_new:Npn \xor_deal_with_footins_ftnrightspread: {
%<*trace>
  \trace_push:n{ftnspread:~xor_deal_with_footins_ftnrightspread:}
%</trace>
  \int_if_odd:nFT \g_xor_page_absolute_num
    {
     \box_if_empty:NF \g_xor_footins_box
	{
%<*trace>
         \trace:n{ftnspread:~use~ saved~ footins}
%</trace>
         \insert\g_xor_footins_box
            { \vbox_unpack_clear:N \g_xor_footins_box }
        }
    }
    { \xor_deal_with_footins_ftnright: }
%<*trace>
  \trace_pop:n{ftnspread:~xor_deal_with_footins_ftnrightspread:}
%</trace>
}
%    \end{macrocode}
% \end{macro}
%
%
%
%
% \subsubsection{Footnote setup multicolumn}
%
% In this section we provide the code for running the footnotes in multiple
% columns across the bottom of the page.
%
% \begin{macro}{multicolumn (footnotesetup)}
%
%    \begin{macrocode}
\DeclareTemplate{footnotesetup}{multicolumn}{0}{
   column-num  =+C \g_xor_footins_col_num,
   text-sep    =+l \g_xor_final_footins_skip,
   max-height  =+l \g_xor_footins_dim,
 }
 {
  \num_gset:Nn  \g_xor_footins_col_num {3}
  \skip_gset:Nn \g_xor_final_footins_skip {10pt plus 5pt}
  \dim_gset:Nn  \g_xor_footins_dim  {.5\textheight}

  \DoParameterAssignments

  \int_gset:Nn  \g_xor_footins_int  
                { \c_thousand / \g_xor_footins_col_num }

  \let:NN \xor_initialize_page_footins_action:   \xor_initialize_page_footins_multicolumn:
  \let:NN \xor_initialize_column_footins_action: \xor_initialize_column_footins_multicolumn:
  \let:NN \xor_initialize_balance_footins_action:\do_nothing: 
  \let:NN \xor_column_end_footins_action:        \xor_deal_with_footins_multicolumn:

  \dim_gset:Nn \g_xor_footins_hsize_dim
               {\textwidth / \g_xor_footins_col_num - \columnsep}
  \skip_gset:Nn \g_xor_footins_skip {\g_xor_final_footins_skip}
 }
%    \end{macrocode}
% \end{macro}
%
%
%


%  \begin{macro}{\xor_initialize_page_footins_multicolumn:}
%    
%    \begin{macrocode}
\def_new:Npn \xor_initialize_page_footins_multicolumn: {
%<*trace>
  \trace_push:n{xor_initialize_page_footins_multicolumn:}
%</trace>
  \box_gclear:N \g_xor_footins_box
  \box_gclear:N \g_xor_saved_footins_box
  \box_gclear:N \g_xor_extrains_box
%    \end{macrocode}
%    
%    \begin{macrocode}
  \bool_if:NFT \g_xor_footins_multicolumn_final_run_bool
    {
%<*trace>
     \trace:n{ftnmult:~ trial~ run}
%</trace>
     \int_gset:Nn  \g_xor_footins_int  
                   { \g_xor_cols_int * \c_thousand / \g_xor_footins_col_num }
     \skip_gset:Nn \g_xor_footins_skip {\g_xor_final_footins_skip}

     \dim_gzero:N \g_xor_saved_footins_dim 
    }
%    \end{macrocode}
%    
%    \begin{macrocode}
    {
%<*trace>
     \trace:n{ftnmult:~ final~ run}
%</trace>
     \skip_gset:Nn \g_xor_footins_skip \c_zero_skip
     \int_gzero:N  \g_xor_footins_int
    }
%<*trace>
  \trace_pop:n{xor_initialize_page_footins_multicolumn:}
%</trace>
}
%    \end{macrocode}
%  \end{macro}



%  \begin{macro}{\xor_initialize_column_footins_multicolumn:}
%    
%    \begin{macrocode}
\def:Npn \xor_initialize_column_footins_multicolumn: {
%<*trace>
  \trace_push:n{xor_initialize_column_footins_multicolumn:}
%</trace>

  \box_gclear:N \g_xor_extrains_box
  \dim_compare:nNnT \g_xor_saved_footins_dim > \c_zero_dim
    { \insert\g_xor_extrains_box{\floatingpenalty \@MM
                                 \hrule width  \c_zero_dim 
                                        height \g_xor_saved_footins_dim} }
%<*trace>
  \trace_pop:n{xor_initialize_column_footins_multicolumn:}
%</trace>
}
%    \end{macrocode}
%  \end{macro}



%  \begin{macro}{\xor_deal_with_footins_multicolumn:}
%    
%    \begin{macrocode}
\def_new:Npn \xor_deal_with_footins_multicolumn: {
%<*trace>
  \trace_push:n{xor_deal_with_footins_multicolumn:}
%</trace>
  \box_if_empty:NF\g_xor_footins_box
        {
	 \vbox_gset:Nn \g_xor_saved_footins_box
	      {\vbox_unpack_clear:N\g_xor_saved_footins_box
	       \vbox_unpack_clear:N\g_xor_footins_box}
	}
%    \end{macrocode}
%    
%    \begin{macrocode}
  \int_compare:nNnT \g_xor_curr_col_int = \g_xor_cols_int
    {
     \xor_format_footins_multicolumn:NN 
	\g_xor_saved_footins_box
	\g_xor_footins_col_num

     \bool_if:NFT \g_xor_footins_multicolumn_final_run_bool
      {
%<*trace>
       \trace:n{ftnmult:~ trial~ run}
       \trace:n{g_xor_trial_rerun_requested_bool ~<-~ true}
%</trace>
       \bool_gset_true:N \g_xor_footins_multicolumn_final_run_bool
       \bool_gset_true:N \g_xor_trial_rerun_requested_bool

       \dim_gset:Nn \g_xor_saved_footins_dim {\ht \g_xor_saved_footins_box }
%<*trace>
       \trace:n{calculated~footnote~ space:~ 
                     \dim_use:N \g_xor_saved_footins_dim }
%</trace>
      }
      {
%<*trace>
       \trace:n{ftnmult:~ do~ final~ typesetting}
%</trace>
%    \end{macrocode}
%    If the result of formatting all footnotes changed from last trial to this
%    one, we have to do another run or might end up with overprinting
%    text. The solution below is too trivial though sice a footnote near the
%    bottom of the last column may get pushed to the next page in which case
%    the space requirement may get less again. Some more fine-grain
%    approximation is probbly needed one day.
%    \begin{macrocode}
       \dim_compare:nNnTF \g_xor_saved_footins_dim < {\ht \g_xor_saved_footins_box }
         {
%<*trace>
          \trace:n{Ooops~ footnote~ space~ needed~ changed:~
                   before~ \dim_use:N \g_xor_saved_footins_dim \space 
                   now~ \dim_use:N \ht \g_xor_saved_footins_box }
          \trace:n{g_xor_trial_rerun_requested_bool ~<-~ true}
%</trace>
          \dim_gset:Nn \g_xor_saved_footins_dim {\ht \g_xor_saved_footins_box }
          \bool_gset_true:N \g_xor_trial_rerun_requested_bool
         }
         {
          \bool_gset_false:N \g_xor_footins_multicolumn_final_run_bool
         }
%    \end{macrocode}
%    We don't actually have to set |\g_xor_trial_rerun_requested_bool| back to
%    false since that is done already by the general loop.
%    \begin{macrocode}
      }
    }
%<*trace>
  \trace_pop:n{xor_deal_with_footins_multicolumn:}
%</trace>
}
%    \end{macrocode}
%  \end{macro}
%
%
%
%  \begin{macro}{\xor_format_footins_multicolumn:NN}
%    
%    \begin{macrocode}
\def_new:Npn \xor_format_footins_multicolumn:NN #1 #2 {
      \box_if_empty:NF #1
           { \vbox_gset:Nn #1
		 {
		  \rigidbalance #1 {#2} {1pt}
		 }
	    }
}
%    \end{macrocode}
%  \end{macro}



%  \begin{macro}{\rigidbalance}
%    Straight stolen out of the \TeX book. Something more configurable etc
%    needs to be used one day but this gets us off the ground \ldots
%    \begin{macrocode}
\newcount\k \newdimen\h
\def\rigidbalance#1#2#3{\setbox0=\box#1\relax \k=#2\relax \h=#3\relax
  \hbox to\textwidth{\splittopskip=\h \vbadness=10000~ \hfilneg
  \valign{##\vfil\cr\dosplits}}}
\def\dosplits{\ifnum\k>0 \noalign{\hfil}\splitoff
  \global\advance\k-1\cr\dosplits\fi}
\def\splitoff{\dimen0=\ht0\relax \divide\dimen0 by\k\relax  \advance\dimen0 by\h
  \vsplit0 to \dimen0\relax }
%    \end{macrocode}
%  \end{macro}




%  \begin{macro}{\@footnotetext}
%    Of course we also have to adjust the generation of footnotes itself. At
%    the moment  we simply use the standard \LaTeXe{} interface any only
%    adjust it a little bit to support different line sizes (using
%    |\g_xor_footins_hsize_dim|). Eventually this needs a complete rewirte to
%    allow setting other characteristics.
%    \begin{macrocode}
\long\def\@footnotetext#1{\insert\footins{%
    \reset@font\footnotesize
    \interlinepenalty\interfootnotelinepenalty
    \splittopskip\footnotesep
    \splitmaxdepth \dp\strutbox \floatingpenalty \@MM
    \hsize\g_xor_footins_hsize_dim \@parboxrestore
    \protected@edef\@currentlabel{%
       \csname p@footnote\endcsname\@thefnmark
    }%
    \color@begingroup
      \@makefntext{%
        \rule\z@\footnotesep\ignorespaces#1\@finalstrut\strutbox}%
    \color@endgroup
\par\penalty-5\relax}}
%    \end{macrocode}
%  \end{macro}
%
%
%
%
%
%
%
%
% \subsubsection{Footnote setup margin}
%
%
%    Setting |max-height| as done below has not the desired effect and
%    needs investigation.\footnote{FIX!}
%
%    Probably broken since I added the new method for dealing with
%    footnotes.\footnote{check/fix}
%
%  \begin{macro}{margin (footnotesetup)}
%    \begin{macrocode}
\DeclareTemplate{footnotesetup}{margin}{0}{
   max-height  =+l \g_xor_footins_dim,
 }
 {

  \dim_gset:Nn \g_xor_footins_dim {.7\textheight}

  \DoParameterAssignments

  \dim_gset:Nn  \g_xor_footins_hsize_dim \marginparwidth

  \let:NN \xor_initialize_page_footins_action:   \xor_initialize_footins_margin:
  \let:NN \xor_initialize_column_footins_action: \do_nothing:
  \let:NN \xor_initialize_balance_footins_action:\do_nothing:
  \let:NN \xor_column_end_footins_action:        \xor_deal_with_footins_margin:

%    \end{macrocode}
%    If the footnote do not appear within the columns we have to
%    ensure that the |\insert| does not change the page
%    calculations. This needs changes in two places:
%    \begin{macrocode}
  \int_gzero:N  \g_xor_footins_int
  \skip_gset:Nn \g_xor_footins_skip \c_zero_skip

 }
%    \end{macrocode}
%  \end{macro}
%
%
%
%
% \begin{macro}{\xor_deal_with_footins_margin:}
%    \begin{macrocode}
\def_new:Npn \xor_deal_with_footins_margin: {
%<*trace>
  \trace_push:n{xor_deal_with_footins_margin:}
%</trace>
  \box_if_empty:NF\g_xor_footins_box
     {
      \vbox_gset:Nn \g_xor_saved_footins_box
           {\vbox_unpack_clear:N\g_xor_saved_footins_box
            \vbox_unpack_clear:N\g_xor_footins_box}
     }
%<*trace>
  \trace_pop:n{xor_deal_with_footins_margin:}
%</trace>
}
%    \end{macrocode}
% \end{macro}
%
%
%
%
% \begin{macro}{\xor_initialize_footins_margin:}
%    \begin{macrocode}
\def_new:Npn \xor_initialize_footins_margin: {
  \box_gclear:N \g_xor_saved_footins_box
}
%    \end{macrocode}
% \end{macro}
%
%
%
%
% \subsection{Declaring Float areas}
%
%
%
% \begin{macro}{\DeclareFloatArea}
%    We declare new float areas and (for the moment) internally use the
%    template mechanism. But this is more or less overkill and should
%    probably be replaced in the end.
%    \begin{macrocode}
\def_new:Npn \DeclareFloatArea#1#2{
  \clist_put_right:Nn \g_xor_areas_known_clist{#1}
  \DeclareInstance{floatareasetup}{#1}{std}
    { name = #1,  #2 }
%    \end{macrocode}
%    We need to do some intialisation here in case the area isn't
%    really used. (Since it is added to |\g_xor_areas_known_clist| it will be
%    considered and that will die if the initialisation isn't done)
%    \begin{macrocode}
  \UseInstance{floatareasetup}{#1}
}
%    \end{macrocode}
% \end{macro}
%
%
%
%    \begin{macrocode}
\DeclareTemplateType{floatareasetup}{0}
%    \end{macrocode}
%
%    \begin{macrocode}
\DeclareTemplate{floatareasetup}{std}{0}{
   name            =n \l_floatareasetup_name_tlp,
   class-close-list=n \l_floatareasetup_class_close_tlp,
   all-close-list  =n \l_floatareasetup_all_close_tlp,
   max-float-num   =C \l_floatareasetup_max_float_num,
 }
 {

  \DoParameterAssignments
%    \end{macrocode}
%
%    Declare area data structures if necessary\ldots
%    \begin{macrocode}
  \cs_free:cT {g_xor_area_ \l_floatareasetup_name_tlp _float_int}
              { \int_new:c {g_xor_area_ \l_floatareasetup_name_tlp _float_int} }
%    \end{macrocode}
%    \ldots and initialize them
%    \begin{macrocode}
  \num_gset_eq:cN {g_xor_area_ \l_floatareasetup_name_tlp _max_float_num}
                  \l_floatareasetup_max_float_num
  \clist_gset_eq:cN
        {g_xor_area_ \l_floatareasetup_name_tlp _class_close_clist}
        \l_floatareasetup_class_close_tlp
  \clist_gset_eq:cN
        {g_xor_area_ \l_floatareasetup_name_tlp _all_close_clist}
        \l_floatareasetup_all_close_tlp
%    \end{macrocode}
%    Let's not forget that area itself (some macros wouldn't like if
%    this is |\relax| rather than |\c_empty_tlp|.
%    \begin{macrocode}
  \seq_gclear:c {g_xor_area_ \l_floatareasetup_name_tlp _float_seq}
}
%    \end{macrocode}
%
%
%
%
% \subsection{A basic page setup template}
%
%
% \begin{macro}{\xor_test_named_key:Ncnn}
%    This should perhaps be made more general
%    \begin{macrocode}
\def_new:Npn \xor_test_named_key:Ncnn #1#2#3#4 {
  \glet:Nc #1{#2}
  \cs_free:NT #1
  {
    \PackageError{template}{#3~ unknown}
    {#3~ can~ be~ either~ #4}
  }
}
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{pagesetup2 (template)}
%    \begin{macrocode}
\DeclareTemplateType{pagesetup2}{0}
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{std (pagesetup2)}
%    \begin{macrocode}
\DeclareTemplate{pagesetup2}{std}{0}{
   column-num    =+c \g_xor_cols_int,
   column-width  =+l \columnwidth,
   column-height =+l \textheight,          % FMi tmp
   column-sep    =+l \columnsep,
   max-float-num =+C \g_pagesetup_max_float_num,
   float-callout-constraint            =n \l_pagesetup_float_callout_constraint_tlp,
   float-callout-span-constraint       =n \l_pagesetup_float_callout_span_constraint_tlp,
   bottom-float-footnote-constraint    =n \l_pagesetup_float_footnote_constraint_tlp,
   flush-float-callout-constraint      =n \l_pagesetup_flush_float_callout_constraint_tlp,
   flush-float-callout-span-constraint =n \l_pagesetup_flush_float_callout_span_constraint_tlp,
   flush-bottom-float-footnote-constraint =n
                                          \l_pagesetup_flush_float_footnote_constraint_tlp,
%
%    \end{macrocode}
%
%    \begin{macrocode}
   area-list             =+n \g_xor_areas_used_clist,
%    \end{macrocode}
%    \begin{macrocode}
   defer-class-close-list=+n \g_xor_area_DDD_class_close_clist,
   defer-all-close-list  =+n \g_xor_area_DDD_all_close_clist,
%    \end{macrocode}
%
%    \begin{macrocode}
   footnote-setup =i {footnotesetup} \pagesetup_footnote_setup:,
%    \end{macrocode}
%
%    \begin{macrocode}
   float-float-sep        =+l \g_xor_float_float_skip,
   float-area-sep         =+l \g_xor_float_area_skip,
   float-text-sep         =+l \g_xor_float_text_skip,
   float-inline-sep       =+l \g_xor_float_inline_skip,
%    \end{macrocode}
%
%    \begin{macrocode}
   grid-point-sep   =+l \g_xor_grid_point_sep_dim,
  }
  {
%    \end{macrocode}
%    We start off with ensuring that we are at the top of a page. This
%    is a temporary solution until after pagesetup is more settled and
%    those bits which are only possible if there is nothing left on
%    recent contributions are properly separated from those things
%    which can be changed midway.
%    \begin{macrocode}
    \newpage

    \int_gset:Nn \g_xor_cols_int \c_one
    \num_gset:Nn \g_pagesetup_max_float_num{3}
    \tlp_set:Nn \l_pagesetup_float_callout_constraint_tlp {column}
    \tlp_set:Nn \l_pagesetup_float_footnote_constraint_tlp {none}
    \tlp_set:Nn \l_pagesetup_flush_float_callout_constraint_tlp 
                {\l_pagesetup_float_callout_constraint_tlp}
    \tlp_set:Nn \l_pagesetup_flush_float_footnote_constraint_tlp 
                {\l_pagesetup_float_footnote_constraint_tlp}
    \tlp_set:Nn \l_pagesetup_float_callout_span_constraint_tlp {flexible}
    \tlp_set:Nn \l_pagesetup_flush_float_callout_span_constraint_tlp
                {\l_pagesetup_float_callout_span_constraint_tlp}
%    \end{macrocode}
%
%    \begin{macrocode}
    \TP_unset_key:N \g_xor_area_DDD_class_close_clist  % impossible value
    \clist_gclear:N \g_xor_area_DDD_all_close_clist
%    \end{macrocode}
%
%    \begin{macrocode}
% tmp:
    \def:Npn \pagesetup_footnote_setup:{\UseTemplate{footnotesetup}{std}{}}
%    \end{macrocode}
%
%    \begin{macrocode}
    \dim_gset:Nn \g_xor_grid_point_sep_dim \c_zero_dim  % no grid points by default

    \DoParameterAssignments
%    \end{macrocode}
%
%    \begin{macrocode}
     \dim_compare:nNnTF \g_xor_grid_point_sep_dim = \c_zero_dim
     {
       \glet:NN \xor_snap_to_grid:nn \xor_snap_to_grid_dummy:nn
%    \end{macrocode}
%    Next two lines need some refinement, we need some mechanism to
%    fully disable those grid points. |\IgnoreAlignToGrid| doesn't do
%    the trick.\footnote{FIX!}
%    \begin{macrocode}
       \IgnoreAlignToGrid
       \glet:NN\AlignToGrid_std: \do_nothing:
     }
     {
       \glet:NN \xor_snap_to_grid:nn \xor_snap_to_grid_std:nn
       \ObeyAlignToGrid
     }
%    \end{macrocode}
%    Split the |\g_xor_float_text_skip| specification and store the
%    minus part in |\g_xor_float_text_shrink_dim|. Right now the plus
%    part is not used. Actually this is only really necessary if we do
%    grid typesetting but we do it anyway so that the spec is always
%    checked for offending infinite stretch.
%    \begin{macrocode}
     \TP_split_finite_skip_value:nnNN
       \g_xor_float_text_skip
       {float-text-sep}
       \l_tmpa_dim
       {\global\g_xor_float_text_shrink_dim}
%    \end{macrocode}
%
%    \begin{macrocode}
     \TP_split_finite_skip_value:nnNN
       \g_xor_float_inline_skip
       {float-inline-sep}
       \l_tmpa_dim
       {\global\g_xor_float_inline_shrink_dim}
    \skip_gset:Nn \g_xor_float_inline_skip {\c_one \g_xor_float_inline_skip}
%    \end{macrocode}
%
%    \begin{macrocode}
    \dim_gset:Nn \hsize     \columnwidth
    \dim_gset:Nn \linewidth \columnwidth

% all taken away from AtBeginDocument (where it is was added in xo-final)
  \dim_set:Nn \l_tmpa_dim {\headheight + \headsep}
  \gdef:Npx \pagebodytopvpos {\dim_use:N \l_tmpa_dim}

  \dim_set:Nn \l_tmpa_dim {\l_tmpa_dim + \textheight}
  \gdef:Npx \pagebodybotvpos {\dim_use:N \l_tmpa_dim}

%% horiz
  \dim_set:Nn \l_tmpa_dim {\columnwidth + \columnsep}
  \gdef:Npx \columndisplacement {\dim_use:N \l_tmpa_dim}

% Also record total width of textarea (used for header/footer
% placement

  \dim_gset:Nn \textwidth {\columndisplacement * \g_xor_cols_int -
                           \columnsep}
%    \end{macrocode}
%
%    Perhaps we could use |\g_xor_areas_known_clist| instead and save the
%    test (would need a change in xo-place as well!).\footnote{Check!}
%    \begin{macrocode}
    \if_TP_key_unset:NT \g_xor_area_DDD_class_close_clist
       { \clist_gset_eq:NN \g_xor_area_DDD_class_close_clist \g_xor_areas_used_clist }
%    \end{macrocode}
%
%    \begin{macrocode}
    \xor_test_named_key:Ncnn
        \xor_std_check_callout_constraints:n
        {xor_check_callout_ \l_pagesetup_float_callout_constraint_tlp :n}
        {float-callout-constraint}
        {`none',~ `page',~ `column',~ or~ `after'}
%    \end{macrocode}
%
%    \begin{macrocode}
    \xor_test_named_key:Ncnn
        \xor_check_callout_constraints_relaxed:n
        {xor_check_callout_ \l_pagesetup_flush_float_callout_constraint_tlp :n}
        {flush-float-callout-constraint}
        {`none',~ `page',~ `column',~ or~ `after'}
%    \end{macrocode}
%
%    \begin{macrocode}
    \xor_test_named_key:Ncnn
        \xor_check_some_constraints_std:
        {xor_check_float_footnote_ \l_pagesetup_float_footnote_constraint_tlp :}
        {bottom-float-footnote-constraint}
        {`none'~ or~ `forbidden'}
%    \end{macrocode}
%
%    \begin{macrocode}
    \xor_test_named_key:Ncnn
        \xor_check_some_constraints_relaxed:
        {xor_check_float_footnote_ \l_pagesetup_flush_float_footnote_constraint_tlp :}
        {flush-bottom-float-footnote-constraint}
        {`none'~ or~ `forbidden'}
%    \end{macrocode}
%
%    \begin{macrocode}
    \xor_test_named_key:Ncnn
        \xor_calculate_float_col_std:
        {xor_calculate_float_col_ \l_pagesetup_float_callout_span_constraint_tlp :}
        {float-callout-span-constraint}
        {`strict'~ or~ `flexible'}
%    \end{macrocode}
%
%    \begin{macrocode}
    \xor_test_named_key:Ncnn
        \xor_calculate_float_col_relaxed:
        {xor_calculate_float_col_ \l_pagesetup_flush_float_callout_span_constraint_tlp :}
        {flush-float-callout-span-constraint}
        {`strict'~ or~ `flexible'}
%    \end{macrocode}
%
%    \begin{macrocode}
    \glet:NN \xor_check_float_constraints:    \xor_check_some_constraints_std:
    \glet:NN \xor_check_callout_constraints:n \xor_std_check_callout_constraints:n
    \glet:NN \xor_calculate_float_col: \xor_calculate_float_col_std:
%    \end{macrocode}
%
%    \begin{macrocode}
    \clist_map_inline:Nn \g_xor_areas_used_clist
    {
%    \end{macrocode}
%    Perhaps the instance  should be called the moment we declare the
%    area. On the other hand calling it within the page setup would
%    allow to use collections!\footnote{Think and decide}
%    \begin{macrocode}
     \UseInstance{floatareasetup}{##1}
    }
%    \end{macrocode}
%
%    \begin{macrocode}
    \pagesetup_footnote_setup:
%    \end{macrocode}
%
%    Finally another bit of the initalisation that we have to redo at
%    this point since now some of the values may have
%    changed.\footnote{Temporary solution until the initialisation bit
%    and the pagesetup is properly sorted out.}
%    \begin{macrocode}
    \xor_next_page_setup:
%    \end{macrocode}
%
%    \begin{macrocode}
    \xor_collect_setup:
  }
%    \end{macrocode}
% \end{macro}
%
%
%
%  \begin{macro}{\g_pagesetup_max_float_num}
%    
%    \begin{macrocode}
\num_new:N \g_pagesetup_max_float_num
%    \end{macrocode}
%  \end{macro}
%
%
%
%
%    \begin{macrocode}
\endinput
%    \end{macrocode}
%
% \endinput
%
% $Log$
% Revision 1.12  2005/03/01 22:53:50  morten
% Small updates, more expl3 conversion
%
% Revision 1.10  2004/12/04 22:54:08  mittelba
% starting to define a box module ... unfinished and names not yet right!
%
% Revision 1.9  2004/11/28 18:10:26  mittelba
% added Björn's suggestions as comment
%
% Revision 1.8  2004/11/13 10:04:06  mittelba
% new license (LPPL)
%
% Revision 1.7  2004/10/30 18:46:10  mittelba
% further cleanup using expl3 concepts
% first attempt at balancing (unfinished)
%
% Revision 1.6  2004/10/12 21:40:50  mittelba
% updates up to p29
%
% Revision 1.5  2004/10/03 15:36:07  mittelba
% more cleanup ... tedious ...
%
% Revision 1.4  2004/10/01 21:46:44  mittelba
% many further updates, still a lot to do
%
% Revision 1.3  2004/09/27 20:06:24  mittelba
% in the middle of normalizing to expl3 syntax
%
% Revision 1.2  2004/09/18 10:00:10  mittelba
% using \_for (temp)
%
% Revision 1.1  2001/07/26 19:55:12  latex3
% original web distrib
%
% Revision 1.34  2000/08/11 07:14:27  latex3
% added header
%
% Revision 1.33  2000/08/07 19:50:48  latex3
% setup the |\xor_OR_collect:| again when a pagesetup is selected since its
% parameter might have changed.
%
% Revision 1.32  2000/08/06 19:02:51  latex3
% move parts initialisation to \begin{document}
% move \newpage in pagesetup template first to ensure that previous page
% is finished with old values
%
% Revision 1.31  2000/08/06 09:02:57  latex3
% documented that footnotehandling needs fixing
%
% Revision 1.30  2000/08/04 10:23:24  latex3
% removed float-text-shrink and float-inline-shrink keys and instead
% used \split_get_parts:nnNN
%
% Revision 1.29  2000/07/26 20:45:51  latex3
% first implementation of grid point support
%
% Revision 1.28  2000/07/21 13:52:53  latex3
% more renaming for float sequence class concept
%
% Revision 1.27  2000/07/18 21:07:03  latex3
% introduced float sequence classes
%
% Revision 1.26  2000/07/12 16:47:44  latex3
% use grid points properly in template
%
% Revision 1.25  2000/07/10 21:04:30  latex3
% integration of float specing parameters in page setup
% support for grid typesetting in page setup
%
% Revision 1.24  2000/07/04 19:44:58  latex3
% fix marginal footnote template (did change column calculations)
%
% Revision 1.23  2000/06/26 15:01:29  latex3
% docu update
%
% Revision 1.22  2000/06/21 09:56:09  latex3
% update docu
%
% Revision 1.21  2000/06/18 15:00:35  latex3
% move "Bottom float footnote relation" to xo-place file
%
% Revision 1.20  2000/06/16 11:06:05  latex3
% support float-callout-span-constraint
%
% Revision 1.19  2000/06/15 17:49:55  latex3
% moved macros about placment checking to xo-place since they don't
% belong here
%
% Revision 1.18  2000/06/15 15:21:33  latex3
% implemented new semantics for area names
%
% Revision 1.17  2000/06/13 21:21:08  latex3
% added support for columnheight (tmp)
% define \pagebodytopvpos etc inside template so that it can change
%
% Revision 1.16  2000/05/03 18:48:42  latex3
% initialize float area data structure the moment the float area is
% declared (otherwise you can't declare areas if they are not used!)
%
% add keys defer-type-close-list and defer-all-close-list to pagesetup2
% template
%
% Revision 1.15  2000/04/21 19:03:58  latex3
% added footnote setup
% cleanup pagesetup code
%
% Revision 1.14  2000/04/08 10:48:42  latex3
% code cleanup
%
% Revision 1.13  2000/04/08 08:16:53  latex3
% default for \l_pagesetup_flush_float_callout_constraint_tlp changed
%
% Revision 1.12  2000/03/31 17:07:24  latex3
% don't fail in footnote/float test if there isn't any bottom area at
% all!
%
% Revision 1.11  2000/03/24 15:34:27  latex3
% version that starts supporting spans (still a hack yet)
%
% Revision 1.10  2000/03/22 15:51:51  latex3
% some normalisations of names
%
% Revision 1.9  2000/03/17 20:25:02  latex3
% initialize fl@0
% support relaxing constraints when flushing
%
% Revision 1.8  2000/03/15 19:58:00  latex3
% assigning values to \column@number should always be done globally
%
% Revision 1.7  2000/03/05 19:41:21  latex3
% support multiple columns (6 max right now)
%
% Revision 1.6  2000/02/26 18:21:16  david
% fixed footnote bottom constraint code
%
% Revision 1.5  2000/02/26 16:52:25  david
% *** empty log message ***
%
% Revision 1.4  2000/02/17 22:41:38  david
% *** empty log message ***
%
% Revision 1.4  2000/02/16  13:41:06  latex3
% added 3col support
%
% Revision 1.3  2000/02/13  14:38:53  latex3
% was 1.2.1.2
%
% Revision 1.2.1.2  2000/02/13  11:51:27  latex3
% fixed \xor_check_callout_after:n (hopefully correct now)
% added \xor_check_float_constraints: logic
%
