% \iffalse
%% File galley2.dtx (C) Copyright 1999-2000 Frank Mittelbach
%%                  (C) Copyright 2006 LaTeX3 Project
%%
%% It may be distributed and/or modified under the conditions of the
%% LaTeX Project Public License (LPPL), either version 1.3c of this
%% license or (at your option) any later version.  The latest version
%% of this license is in the file
%%
%%    http://www.latex-project.org/lppl.txt
%%
%% This file is part of the ``galley bundle'' (The Work in LPPL)
%% and all files in that bundle must be distributed together.
%%
%% The released version of this bundle is available from CTAN.
%%
%% -----------------------------------------------------------------------
%%
%% The development version of the bundle can be found at
%%
%%    http://www.latex-project.org/cgi-bin/cvsweb.cgi/
%%
%% for those people who are interested.
%%
%%%%%%%%%%%
%% NOTE: %%
%%%%%%%%%%%
%%
%%   Snapshots taken from the repository represent work in progress and may
%%   not work or may contain conflicting material!  We therefore ask
%%   people _not_ to put them into distributions, archives, etc. without
%%   prior consultation with the LaTeX Project Team.
%%
%% -----------------------------------------------------------------------
%%
%<*driver|package>
\RequirePackage{expl3}
%</driver|package>
%\fi
\GetIdInfo$Id$
          {Galley module}
%\iffalse
%<*driver>
%\fi
\ProvidesFile{\filename.\filenameext}
  [\filedate\space v\fileversion\space\filedescription]
%\iffalse
 \documentclass{ltxdoc}
 \typeout{********}
 \typeout{* Unpack with:}
 \typeout{* \string\generate{%
  \string\file{galley2.sty}{\string\from{galley2.dtx}{package,trace}}}
 }
 \typeout{********}
% \usepackage{ldcdoc}


 \newcommand\LaTeXplus{\LaTeXe$*$}

 \CodelineIndex \EnableCrossrefs
 \renewcommand\MakePrivateLetters{%
   \makeatletter\catcode`\:11\relax\catcode`\_11\relax}
 \begin{document}
 \DocInput{galley2.dtx}
 \end{document}
%</driver>
% \fi
%
% \CheckSum{0}
%
% \newcommand\PARM[1]{parameter \textbf{#1}}
% \newcommand\subsubsubsection{\paragraph}
%
%
%
% \title{The \textsf{galley} package\thanks{This file
%         has version number \fileversion, last
%         revised \filedate.}}
% \author{FMi}
% \date{\filedate}
% \maketitle
%
% \begin{abstract}
%   This module provides the data structure for galleys and contains
%   the low-level interfaces for direct manipulation of this data structure.
%   Higher-level templates for interfacing with the
%   galley mechanism are set up by the module
%   \texttt{xhj}.
%   The low-level interfaces of the current module are  geared
%   towards package writers having special needs which are not
%   fulfilled by the templates in the \texttt{xhj} module.
%   They are not intended to be used directly in class design.
% \end{abstract}
%
% \tableofcontents
%
% \section{Introduction}
%
% In \LaTeXplus{} terminology a galley is a rectangular area which
% receives text and other material filling it from
% top.\footnote{The predominant direction depends on the writing
% system and with extensions to \TeX{} such as Omega there are
% possibilities to define galleys with a different filling direction.}
% The vertically extend of a galley is normally not restricted
% (there are exceptions); instead certain chunks are taken off the top
% of an
% already partially filled galley to form columns or similar areas
% on a page. This process is typically asynchronous but there are ways
% to control or change its behavior.
%
% Examples for galleys are `the main galley', where the continuous
% document data gets formatted into  and from which columns and pages are
% constructed, and  `vbox galley's, such as the body of  a minipage
% environment or the body of a float (in \LaTeXe only---the new float
% mechanism for \LaTeXplus{} will employ horizontally oriented float
% bodies). The latter galleys are typically not being split after
% formatting though there can be exceptions.
%
% The data that is being formatted into a galley can be described as a
% sequence of paragraphs of text separated by vertical material such
% as vertical spaces, penalties, writes, specials, etc.
%
% There are two components that a mechanism for galleys has to provide:
% the framework for manipulating the shape and placement of paragraph
% text (this is provided with higher-level templates in the module
% \texttt{xhj}) and the framework for manipulating the inter-paragraph
% material.
%
%
%
% \subsection{Some problems with \LaTeXe{} galleys}
%
% The handling of inter-paragraph material poses the most difficult
% problems as it is typically influenced by various factors and
% information gained at different stages throughout the document
% processing. \LaTeXe{} provided a certain control over this material,
% e.g., headings would set a |@nobreak| flag to prevent paragraph
% breaking after them and other commands and environments would test
% for it; |\addvspace| and |\addpenalty| could be used several times
% in succession and still provide reasonable results, but all in all
% these have been adhoc solutions to the most pressing problem of that
% area---many others remained unsolved:
%
% The following is a list of document extracts which one can imagine
% to appear in ordinary documents. They all have in common that in
% \LaTeXe{} they produce surprising (and undesired) results:
% \begin{enumerate}
% \item
% \begin{verbatim}
% \end{itemize} \vspace{3pt} \begin{itemize} ...
%\end{verbatim}
% \ldots not three points of extra space but 13 (with
%       the \texttt{article} class)
%
% \item
% \begin{verbatim}
% \section{HEAD} {\sc ABC} ...
%\end{verbatim}
% \ldots page breaking restrictions apply to the
%       second paragraph after the heading not the first as they
%       should
% \item
% \begin{verbatim}
% \usepackage{hyperref}
%\end{verbatim}
% \ldots the danger of completely changed vertical spacing because
%       the |\special|s added by \texttt{hyperref} interfere with the
%       spacing and penalty mechanisms of \LaTeXe
%
%
% \item
% \begin{verbatim}
% {\section{HEAD}} para text \par \begin{itemize} ...
%\end{verbatim}
%   \ldots one gets an indentation after the heading; a page break might
%   happen after the first line in the paragraphs; and there will be no
%   space above the itemize environment (though there will be space
%   below) --- because of this \LaTeXe{} claims this is incorrect input
%   --- and then since \LaTeX\,2.09 uses the equivalent of
%   |\twocolumn[\chapter{HEAD}]| in certain circumstances in the report
%   and book class :-)
% \end{enumerate}
%
% All these pitfalls are due to the fact that \LaTeXe{} typesets the
% inter-paragraph material whenever it receives it and once it is
% typeset \TeX{} has only a limited power to modify the material
% already present on the galley.
%
% Thus to be able to do better one has to defer any typesetting until
% the very last moment (i.e., when the next paragraph starts) and
% instead collect such inter-paragraph material in a suitable data
% structure where it can be manipulated and examined.
% The present code in this module provides such a data structure. Of
% course, to be successful it is important that all functions that
% would normally produce inter-paragraph material (such as user
% commands like |\vspace|) obey the concepts behind the mechanism and
% refrain from directly adding to the galley.
% How this is achieved will be explained in the next sections.
%
%
% \section{The galley data structure}
%
% A galley is a \LaTeX{} object which contains (or receives)
% paragraphs and typesets them vertically below each other intermixed
% with material like vertical spaces and penalties, etc.\ which are
% placed between such paragraphs.
%
% Galleys can be nested and thus data structures associated with them
% need to be provided using a stack structure.
%
% Technical aspects of the implementation of this structure are
% discussed in section~\ref{sec:galley-concept-impl}.
%
%
% \subsection{Writes, marks, specials and inserts}
%
% Writes, marks, specials and inserts are internally represented by
% \TeX{} as invisible objects (nodes) within the horizontal or
% vertical lists of \TeX. The
% problem with this is that they interfere with other nodes, produce
% additional break points, etc.
%
% For this reason they should not appear on their own but need to be
% placed into precisely controlled places. They can either go directly
% after the last line of a paragraph (preceded and followed by
% |\nobreak|) or they can go directly in front of the next
% paragraph. Table~\ref{tab:vthing} lists the different nodes and
% their suggested handling.
% \begin{table}
% \begin{center}
% \begin{tabular}{ll}
% \hline
%   vthing & attach to \\
% \hline
%   insert & prev \\
%   write  & prev or next (flag) \\
%   mark   & prev or next (flag) \\
%   special (hyperref) & prev or next (different command) \\
%   special (others)   & next
% \end{tabular}
% \end{center}
% \small            ^^A well designed object :-)
% \begin{quote}
%   prev := just add to MVL followed by |\nobreak| \\
%   next := store tokens and put in a primitive ``in hmode at start of
%    next para''
% \end{quote}
% \caption{Invisible nodes and their handling}\label{tab:vthing}
% \end{table}
%
%
% \subsection{Individual parameters}
%
% Each parameter related to a galley exists in two incarnation:
% \begin{itemize}
% \item it has one value which is considered to be static for a
%   sequence of paragraphs (potentially for all paragraphs typeset on
%   this level); any change to it via some mutator command will
%   persist until a further change or the end of the level --- called
%   static galley parameter value (SGPV)
% \item it has one value which is reset after each use to the
%   corresponding static value --- called dynamic galley parameter
%   value (DGPV).
% \end{itemize}
%
% The actual processing routines always use the DGPVs. Thus to produce
% a paragraph sequence with a certain uniform setting of parameters
% one would set up (or modify) the SGPVs, and to locally overwrite
% individual values for one paragraph one would modify the relevant DGPVs.
%
%
% \subsubsection{Vertical (pre-paragraph) parameters}
%
% \begin{description}
% \item[nobreak flag (b)] a flag that signals how page breaking should
%   be handled
%   between the previous and the upcoming paragraph; it takes a number
%   between 0 and 3 with the following meaning: 0 means normal
%   breaking behavior (value of \PARM{penalty} is used), 1 means
%   prevent break between paragraphs (value of \PARM{penalty} is
%   discarded and replaced by 10000), 2 is like 1 but additionally
%   prevents\footnote{as far as possible with \TeX} a page break
%   within the first lines of the upcoming paragraph (by fiddling with
%   |\clubpenalty|), 3 is like 1 but also suppresses a page break for
%   the whole upcoming paragraph (by setting
%   |\interlinepenalty|)\footnote{One can actually implement something
%   even better: with e\TeX{} more control is possible and with normal
%   \TeX{} one could prevent a break for a minimum of X lines by
%   checking on the value of \texttt{\textbackslash prevgraf} and decreasing this for the next
%   time around}
%   At the moment it also supports negative numbers ($-3$ especially)
%   which have the same meaning as the positive counterparts except
%   that they only influence the breaking within the paragraph, e.g.,
%   $-3$ do not break within the next paragraph (which is useful for
%   initials etc). However this should probably be redesigned properly!
% \item[vpenalty (p)] penalty between paragraphs unless flag above is set
% \item[vspace (v)]   skip between paragraphs as set by class or package
%   commands, if -1sp then |\parskip| is used instead.\footnote{This
%   -1sp is a speedup measure to avoid the need for an additional flag
%   for suppressing or adding \texttt{\textbackslash parskip}, this way
%   between normal paragraphs  \texttt{\textbackslash parskip} is
%   added (as the default for this parameter is -1sp) but any setting
%   will result in suppressing it. Of course this means if some
%   environment requests some space it does get 1sp less, acceptable?
%   Using 0pt instead is not a good idea as it makes it difficult to
%   state for some environment that all space should be suppressed.}
% \item[user vpenalty (up)] penalty between paragraphs set by user level
%   commands
% \item[user vspace (uv)] additional space between paragraphs set by user level
%   commands. This space is always added and never suppressed or subject
%   to functions like using the maximum, since it is provided by
%   user commands like |\vspace| where we assume that the user intends
%   to correct the default result.
% \item[prev whatsits (pw)] whatsits that are supposed to get attached to
%   the previous paragraph
% \item[parshape (ps)] structured parameter that sets up a \TeX{}
%   |\parshape| declaration or empty; it replaces the next two parameters
%   in the current implementation. However for reasons of secure
%   programming it might be necessary to have all three. (Right now
%   |\linewidth| and |\@totalleftmargin| are locally set when
%   modifying the ps parameter and thus are in danger of getting out
%   of sync if setting happens not at group boundaries.
% \item[measure (m)] nominal width of the upcoming paragraph lines
%   (|\linewidth| is  set to this value)\footnote{Not used right now
%   see comment on ps parameter.}
% \item[hoffset (h)] offset for the upcoming paragraph lines from the left
%   margin (in \LaTeXe{} this was
%   |\@totalleftmargin|).\footnote{Not used right now, see comment on
%   ps parameter above.}
% \end{description}
%
%
% \subsubsection{Paragraph-start parameters}
%
% \begin{description}
% \item[indentation (i)] flag to suppress insertion of indentation
%    box. A value of 0 means insert indentation any other value suppresses
%    indentation.
% \item[next whatsits (nw)] whatsits that are supposed to get attached to
%   the next paragraph
% \item[object (o)]  typeset material at the start of the paragraph
% \item[queries (q)] information about previously seen objects/states
%   on the galley that can be queried by following code as necessary,
%   e.g., the fact that we just have processed an `item', or a
%   `heading', or \ldots
%
%   This parameter is not yet properly used and perhaps becomes
%   obsolete once there is a proper mechanism for handing such data.
% \end{description}
%
%
% \subsubsection{Paragraph-justification parameters}
%
% The following parameter is supposed to define the inner shape of a
% paragraph, e.g., adjusted, centered lines, ragged shapes, etc. It
% is not meant to define the measure (for this see the \PARM{parshape}).
% \begin{description}
% \item[justification (j)] This is a multivalued parameter consisting of
%      \begin{itemize}
%        \item the counterpart to |\parfillskip| at the
%              beginning of a paragraph
%        \item the \TeX{} |\leftskip|
%        \item the \TeX{} |\rightskip|
%        \item the \TeX{} |\parfillskip|
%        \item the \TeX{} |\spaceskip|
%        \item the \TeX{} |\xspaceskip|
%        \item glue specification to be put in front of a forced ``newline''
%        \item the \TeX{} |\parindent|\footnote{This parameter should
%           perhaps be taken out, there is some discussion related to
%           this elsewhere.}
%      \end{itemize}
% \end{description}
%
% \subsubsection{Line breaking parameters}
%
% Line breaking parameters are considered to be not related to
% individual paragraphs but to paragraphs sequences, i.e., they are
% not reset on each paragraph. Wrong? Instead they are initialized at
% start of galley and are otherwise only settable via templates. One
% could of course make them a multivalued parameter as well.
%
%
%
% \subsubsection{Paragraph-end parameters}
%
% None defined yet (but perhaps should)
%
%
%
% \subsection{Document level (user) commands}
%
% \subsubsection{Penalties}
%
%  To give the user a chance to actually overwrite a penalty setting
%  produced from environments or commands internally updating the
%  galley structure, user level document commands like |\nopagebreak|
%  do not modify the internal \PARM{penalty} but instead use a
%  \PARM{user penalty}. If that parameter is set (i.e., non-empty) it
%  will get used and the internal \PARM{penalty} that is normally
%  applied will be ignored. This way, even in situations where the
%  user request appears too early in the document (e.g., between
%  environments where the following environment would modify
%  \PARM{penalty} the desired outcome is ensured.
%
% \subsubsection{Vertical spaces}
%
% In contrast user commands for specifying vertical space will always
%  add to the existing space.\footnote{Always? i can image to have the
%  desire to explicitly set the space to a fixed value in which case i
%  would like to ensure that the internal value for \PARM{vspace} is
%  fully ignored. On the other hand this may not been sensible because
%   it might be difficult for the user to know how big the space should
%   be.}
%
%
% \subsection{Galley structure after lists/displays}\label{sec:endlist}
%
% After lists or a math display the continuation depends on whether
% the following text logically   is part of the previous material or
% starts a new  paragraph. This difference is coded in the source
% document by leaving or not leaving an empty line (|\par|).
%
% Depending on this the handling of the upcoming paragraph might
% differ in \PARM{penalty}, \PARM{vspace}, \PARM{indent} (and perhaps
% others)
%
% To allow for this a processing mechanism like this should be
% investigated\footnote{There is some concept code for this below but
% it is not finished!}:
% \begin{itemize}
% \item
%   The environment that intends to make use of the structure sets a flag
% \item
%   The values of parameters for the case of the paragraph continuing
%    the previous material are specified by modifying the DGPVs.
% \item
%   The values of parameters for the case that the next paragraph is
%    to be considered independent are specified in a third structure
%    (called XGPV for now) which is a plist like the SGPV (or part of
%    it if we don't allow to modify any odd rubbish in that case,
%    which is probably sensible)
% \item
%    The code for the |\par| command is augmented in a way that if it
%    is executed in vertical mode the following happens:
%    \begin{itemize}
%    \item
%      The values in the XGPV are added to the DGPV values to allow
%      for user level changes to be preserved.
%    \item
%      The flag above is reset so that following |\par| does not
%      modify the DGPV further.
%    \end{itemize}
% \end{itemize}
% The XGPV has to be stored away if a new galley level is initiated!
%
%
%
%
%
% \section{The low-level command interface}
%
% The commands described in this section are used to update the galley
% data structure. Their intended use is a) in kernel code, i.e., in
% parts that are already provided by the \LaTeXplus{} kernel such as
% the basic float mechanism and b) as building blocks for higher-level
% templates such as those defined by the module \texttt{xhj} or the
% module \texttt{xinitials}.
% They are not meant to be used directly when building classes.
%
% Their names are currently very strange and inconsistent and need to
% be normalized.
%
%
%
% \subsection{Manipulating the dynamic galley parameters values}
%
% To manipulate the dynamic parameter values of the galley structure a
% number of commands are available. As explained above changing the
% dynamic parameters effects the only next paragraph (or the next sequence
% of vertical objects between paragraphs) --- afterwards the
% parameters are reset to the values stored in their static counterparts.
%
% \noindent
% \DescribeMacro{\GAL_set_DGPV_thing:nn}\marg{id}\marg{value} \\
% The |\GAL_set_DGPV_thing:nn| command takes a parameter \meta{id} (or more
% exactly its letter or letter sequence such as `j' or `ps') and
% assigns the \meta{value} to it. No processing of the value is
% undertaken.
%
% \noindent
% \DescribeMacro{\GAL_appendto_DGPV_thing:nn}\marg{id}\marg{value} \\
% \DescribeMacro{\GAL_appendto_DGPV_thing:no}
% The |\GAL_appendto_DGPV_thing:nn| also leaves the \meta{value} unchanged
% but appends it to the current value of the parameter. This is, for
% example, used to build the list of whatsits nodes in the \PARM{next
% whatsits} parameter.
%
% \noindent
% \DescribeMacro{\GAL_set_DGPV_dimension:nn}\marg{id}\marg{value} \\
% \DescribeMacro{\GAL_add_DGPV_dimension:nn}
% \DescribeMacro{\GAL_max_DGPV_dimension:nn}
% In contrast the family of |\...DGPVdimension:nn| commands process the
% \meta{value} by interpreting it as a calc dimension expression. The
% result is then set (|\set...|), or added to the current value
% (|\add...|), or compared with the current value (|\max...|) and the
% maximum assigned.
%
% \noindent
% \DescribeMacro{\GAL_set_penalty:n}\marg{value} \\
% \DescribeMacro{\GAL_add_penalty:n}
% What is available for dimensions is also available for integer
% valued parameters. However, since there is only one such parameter
% (the \PARM{penalty}) at the moment, we provide a family of commands
% which take only a \meta{value} argument.
%
% \noindent
% \DescribeMacro{\GAL_set_object:n}\marg{value} \\
% \DescribeMacro{\GAL_set_break:n}
% The |\GAL_set_object:n| and |\GAL_set_break:n| are special variants of
% the |\GAL_set_DGPV_thing:nn| command for the \PARM{object} and
% \PARM{nobreak flag} parameters, respectively.\footnote{should
% probably vanish}
%
% \noindent
% \DescribeMacro{\GAL_set_left_parshape:nnn}\marg{\# of normal lines}
%   \marg{default width} \marg{delta offset list} \\
% \DescribeMacro{\GAL_set_right_parshape:nnn}
% Defines a special parshape (that is it sets the \PARM{parshape}
% taking into account its current setting with respect to the galley
% measure) at the left or the right starting with
% a number of normal lines (first arg) followed by a number of special
% lines which are constructed assuming a hole of a certain width
% (second argument). The number of lines this hole exists vertically is
% defined by the number of delta offsets in the in comma separated
% third argument. The width of each delta is added to the nominal
% width of the hole thus allowing for special corrections on a line by
% line basis.
%
%
%
% \subsection{Manipulating the static galley parameters values}
%
% Manipulating the static galley parameters essentially means changing
% the default values to which these parameters are restored to at the
% end of each paragraph. These commands always set the corresponding
% dynamic parameter as well.
%
% \noindent
% \DescribeMacro{\GAL_set_SGPV_thing:nn} \marg{id} \marg{value}\\
% Like |\GAL_set_DGPV_thing:nn| but for long-term changes, e.g., no
% processing of \meta{value} is undertaken.
%
% \noindent
% \DescribeMacro{\GAL_set_SGPV_dimension:nn} \marg{id} \marg{value} \\
% Like |\GAL_set_DGPV_dimension:nn| but for long-term changes, e.g., the
% \meta{value} is evaluated using calc prior to assigning it to the
% parameter.
%
% There are no commands for making long-term changes to other parts of
% the interface. Mostly because they seemed to be unnecessary. If
% needed they could be added without much problem.
%
%
%
% \subsection{Manipulating the galley measure}
%
% In the current implementation the galley measure, i.e., the width of
% text lines and their indentation from the left are not represented
% by a galley parameter directly. Instead they are internally stored
% as part of the \PARM{parshape} (see discussion above). For
% this reason that parameter can't be (or rather shouldn't be)
% modified directly but only through the commands below and commands
% like |\GAL_set_left_parshape:nnn| which know about those dependencies
% and handle the update accordingly.
%
% \noindent
% \DescribeMacro{\GAL_set_SGPV_measure:nn} \marg{left-margin}
%                                 \marg{line-width} \\
% This command make a long-term change to the measure by setting the
% width of
% the line to \meta{line-width} and the width of the left margin to
% \meta{left-margin}. In addition it sets the registers |\linewidth|
% and |\@totalleftmargin| to these values (for inspection).
%
% \noindent
% \DescribeMacro{\GAL_add_SGPV_measure:nn}
%           \marg{left-margin-increment} \marg{line-width-increment}\\
% This command make a long-term change to the measure by incrementing the
% width of the line with \meta{line-width-increment} and the width
% of the left margin with  \meta{left-margin-increment}. In addition
% it sets the registers |\linewidth|
% and |\@totalleftmargin| to the resulting values (for inspection).
%
%
%
%
%
% \subsection{Saving and restoring SGPV changes}
%
% \DescribeMacro{\GAL_save_galley_state:} \\
% \DescribeMacro{\GAL_restore_galley_state:} This pair of commands stores
% and retrieves the current state of the SGPVs and can be used with
% environments that want to make long term changes and revert to the
% old settings afterwards, i.e. use |\GAL_save_galley_state:| at the
% beginning, before doing any modification, and then
% |\GAL_restore_galley_state:| at the end. They should be called at the
% same level of grouping (as the saving is done locally) and with the
% current implementation they can't be called several times on the
% same level.\footnote{Or so i think; which is something we may not be
% able to leave as that}
%
%
% \subsection{Manipulating the behavior of \texttt{\textbackslash par}}
%
% The |\par| command in \TeX{} is perhaps the most troublesome item of
% the language for the simple reason that it can't be successfully
% trapped by the macro programmer and hidden from (mis)use.
% When \TeX{} sees an empty line it converts it into the token |\par|
% and this name is fixed and can't be changed. It is easy to provide
% special definitions for the action taken when this token is
% processed but there is no way to prevent somebody from overwriting
% those carefully designed interfaces by simply doing something like
% |\let\par\foo|. If this happens anything might go wrong and since
% |\par| is a name that can't be hidden from the user nor from the
% package designer the only thing one can do is to boldly state that
% \begin{center}
%  \bfseries Manual changes to |\par| are not supported!
% \end{center}
%
% Having said this we now present the interfaces that can be used to give
% |\par| a special meaning within \LaTeXplus. It should be stressed
% that |\par| always has a special meaning within the galley mechanism
% and that direct changes to it, at best lead to incorrect formatting,
% far more likely however will lead to disaster.
%
% \noindent
% \DescribeMacro{\GAL_set_normal_par:}\\
% This command defines |\par| to have its standard definition within
% the galley mechanism, i.e., if a paragraph is currently processed it
% will be finished (including all code necessary, e.g., execute end of
% paragraph hooks) and preparations are undertaken to initialize the
% data structure to be ready to processes inter-paragraph material
% and/or start a new paragraph.
%
% \noindent
% \DescribeMacro{\GAL_set_ignored_par:n} \marg{error text}\\
%    The
%    |\GAL_set_ignored_par:n| changes |\par| so that it does nothing for
%    a while, outputting the \meta{error text} after 3 successive
%    |\par|s.\footnote{That command should probably be replaced in favor
%    of the one below as it is quite dangerous if used in horizontal
%    mode (see comments in the code section, there may be no way to
%    gain control!)}
%
% \noindent
% \DescribeMacro{\GAL_set_endlist_par:}
%    A special definition for |\par| at the end of list like
%    structures. The code for this is currently not functional, some
%    ideas regarding this can be found in section~\ref{sec:endlist}
%    and in the code section.
%
% \noindent
% \DescribeMacro{\GAL_ignore_pars:n}\marg{error text} \\
%   A sort of |\ignorespaces| but for spaces and |\par|s. Should of
%   course only be used as the last command in expansion (and may need
%   support within |\end| handling---the latter is not done)
%
%
% \section{Open issues}
%
% In this section unresolved issues or ideas to think about and
% perhaps implement are collected. There is no particular order to
% them.
%
% \begin{itemize}
% \item
%   It seems advisable to change the way galleys are set up: don't
%   automatically start a new galley with each vbox but instead start
%   a galley only in dedicated ``galley-boxes'' such as the internal
%   form of |\parbox| etc. The advantage is much less overhead, the
%   disadvantage is that non-conforming packages (written without this
%   mechanism in mind) will 99\% fall over while with the current setup
%   they have a good chance to survive and produce more or less proper
%   formatting.
% \item
%   |\@totalleftmargin| and |\linewidth| need to be adequately dealt
%   with, probably by integrating them properly into the data structure
%   somehow at the parshape level.
% \item
%   It is quite likely that we need more granularity on the interfaces
%   for storing and restoring the galley state. There need to be a
%   full store and restore for cases where an unrelated galley is
%   started in the middle of some other galley (such as formatting a
%   marginal paragraph in the middle of the main galley) but it is not
%   appropriate to store and restore the whole galley state when
%   formatting a list inside a galley (what is wanted there is to
%   store and restore the outer measure, the outer parshape, etc.\ but
%   not any registers which deal with penalties, vertical spaces
%   between paragraphs and so on. So |\GAL_save_galley_state:| needs some
%   companion!
% \item
%   Not properly integrated into the whole scheme are math displays
%   (Michael Downes will hopefully come to rescue me here at some point).
% \end{itemize}
%
%
%
% \StopEventually{}
%
% \section{Implementation}
%
% Set up certain defaults including to ignore white space
% within the body of this package. \LaTeXe{} release needs to be
% recent because of changing some bits of the |\parbox| handling below.
%    \begin{macrocode}
%<*package>
\NeedsTeXFormat{LaTeX2e}[1998/12/01]
\ProvidesExplPackage
  {\filename}{\filedate}{\fileversion}{\filedescription}
%\RequirePackage{ldcsetup}
\RequirePackage{xparse}
%    \end{macrocode}
%
%    \begin{macrocode}
\RequirePackage{xhj} % taken out of this file
\RequirePackage{expl3}
\RequirePackage{l3calc} % currently used functions from this module
%    \end{macrocode}
%
% \begin{macro}{\penalty_set:n}
% Should be moved somewhere else.
%    \begin{macrocode}
\cs_set:Npn \penalty_set:n #1{\tex_penalty:D\int_eval:n{#1}}
%    \end{macrocode}
% \end{macro}
%
%
% \subsection{Tracing}
%
% \begin{macro}{\tracinggalleys}
% \begin{macro}{\GAL_tracinggalleys:}
%    A complicated mechanism like the galley interface needs some
%    tracing facilities. Here we provide some modeled after
%    \TeX's internal low-level tracing functions.
%    \begin{macrocode}
\cs_new_nopar:Npn \tracinggalleys{
  \tex_afterassignment:D\GAL_tracinggalleys:\l_tmpa_int}
%<-trace>\cs_set_eq:NN\GAL_tracinggalleys: \scan_stop:
%    \end{macrocode}
%
%    If we compile this module without tracing than |\tracinggalleys|
%    will scan away an integer assignment but otherwise does
%    nothing. But if we docstrip with tracing included then depending
%    on the integer values the following things happen:
%    \begin{description}
%    \item[0] No tracing.
%    \item[1] All tracing info is written to the log file only.
%    \item[2] All tracing info is written to the terminal.
%    \item[3 and higher] All tracing info is written to the terminal
%      and before it is presented a quick check for other internal
%      \TeX{}-tracing is undertaken. If it looks as if |\tracingall|
%      is currently used then various tracings are temporarily disable
%      to avoid getting the output of the tracing being traced as
%      well. This prevents getting many many uninteresting output
%      lines which would otherwise appear.
%
%      This value can only be used if e\TeX{} in extended mode is used
%      as the formatter, as it sets |\tracingassigns|\footnote{Really
%      useful that primitive, try it one day if you got stuck while
%      macro writing, that alone is worth using e\TeX{} for.} which is
%      not a primitive of \TeX.
%    \end{description}
%
%    \begin{macrocode}
%<*trace>
\cs_new_nopar:Npn \GAL_tracinggalleys:{
  \if_case:w \l_tmpa_int
    \cs_set_eq:NN\GAL_typeout:n\use_none:n
%    \end{macrocode}
%
% We can't let |\Gal@typout| simply to |\wlog| if we don't want to see
% tracing on the screen since that does expand its argument and
% produces havoc in some cases, so here is a slightly slower variant.
%    \begin{macrocode}
  \or:
    \cs_set:Npn \GAL_typeout:n ##1{
       \group_begin:
           \cs_set_eq:NN\protect\@unexpandable@protect
           \wlog {##1}
       \group_end:
    }
%    \end{macrocode}
%    If |\tracinggalleys| is set to 2 we show a lot of tracing data.
%    \begin{macrocode}
  \or:
    \cs_set_eq:NN\GAL_typeout:n\typeout
%    \end{macrocode}
%    And another variant when lowlevel tracing is called for. This
%    version does assume that e\TeX{} is being used as it tries to set
%    |\tracingassigns|, so it will fail if this assumption is incorrect.
%    \begin{macrocode}
  \else:
    \cs_set:Npn\GAL_typeout:n ##1{
       \int_compare:nNnTF \tex_tracingmacros:D > \c_zero
       {\group_begin:
         \etex_tracingassigns:D \c_zero
         \tex_tracingcommands:D\c_zero
         \tex_tracingrestores:D\c_zero
         \tex_tracingmacros:D\c_zero
         \typeout{##1}
       \group_end:
       }
       {
         \typeout{##1}
       }
    }
  \fi:
}
%</trace>
%    \end{macrocode}
% \end{macro}
% \end{macro}
%
%
% \begin{macro}{\GAL_typeout:n}
%    This macro is used below to display some tracing info. By default
%    no tracing happens.
%    \begin{macrocode}
\cs_new_eq:NN \GAL_typeout:n \use_none:n
%    \end{macrocode}
% \end{macro}
%
%
%
% \subsection{Taking away primitives from direct use}
%
% To make this mechanism work we have to shield the primitive \TeX{}
% parameters from direct access by the user or a package writer. We do
% this by giving them internal names of the type
% |\l_GAL_real_|\meta{param-name} and the allocating under the original
% parameter name a suitable register to trap any direct access.
%
% \begin{macro}{\l_GAL_real_club_penalty}
% \begin{macro}{\l_GAL_real_interline_penalty}
% We have to trap |\clubpenalty| and |\interlinepenalty|; both are used
% to prohibit page breaking in paragraphs.
%    \begin{macrocode}
\cs_set_eq:NN\l_GAL_real_club_penalty\tex_clubpenalty:D
\cs_undefine:N \clubpenalty
\int_new:N\clubpenalty
\cs_set_eq:NN\l_GAL_real_interline_penalty\tex_interlinepenalty:D
\cs_undefine:N \interlinepenalty
\int_new:N\interlinepenalty
%    \end{macrocode}
% \end{macro}
% \end{macro}
%
% See comments below why this is not needed.
%    \begin{macrocode}
%\let\GAL@@brokenpenalty\brokenpenalty
%\newcount\brokenpenalty
%    \end{macrocode}
%
% \begin{macro}{\l_GAL_real_everypar_toks}
% And of course we have to trap |\everypar| since this token register
% is one of the central bits of the algorithm. It is used to gain
% control at the start of a new paragraph and actually put the stored
% galley data structure for inter-paragraph material onto the page.
%    \begin{macrocode}
\cs_set_eq:NN\l_GAL_real_everypar_toks\tex_everypar:D
\cs_undefine:N \everypar
\toks_new:N\everypar
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\l_GAL_real_parindent_dim}
% Not sure if we really need to trap |\parindent|, anyway here it is:
%    \begin{macrocode}
\cs_set_eq:NN\l_GAL_real_parindent_dim\tex_parindent:D
\dim_zero:N\l_GAL_real_parindent_dim
\cs_undefine:N \parindent
\dim_new:N\parindent
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\l_GAL_real_interpar_skip}
% The |\parskip| parameter is a real nuisance, we really do not want
% it at all as we handle our inter-paragraph spaces ourself. However,
% we can't get rid of it, best we can do is to make it always zero.
%
% Setting the then allocated |\parskip| register will not have any
% effect at all.\footnote{Perhaps it should: i.e., at least produce a
% warning or error message.}
%    \begin{macrocode}
\cs_set_eq:NN\l_GAL_real_interpar_skip\tex_parskip:D
\skip_zero:N\l_GAL_real_interpar_skip
\cs_undefine:N \parskip
\skip_new:N\parskip
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\l_GAL_real_left_skip}
% \begin{macro}{\l_GAL_real_right_skip}
% \begin{macro}{\l_GAL_real_parfill_skip}
% The next block is trapping those parameters which are responsible
% for the justification, ie
%    \begin{macrocode}
\cs_set_eq:NN\l_GAL_real_left_skip\tex_leftskip:D
\cs_undefine:N \leftskip
\skip_new:N\leftskip
\cs_set_eq:NN\l_GAL_real_right_skip\tex_rightskip:D
\cs_undefine:N \rightskip
\skip_new:N\rightskip
\cs_set_eq:NN\l_GAL_real_parfill_skip\tex_parfillskip:D
\cs_undefine:N \parfillskip
\skip_new:N\parfillskip
\skip_set:Nn\parfillskip{0pt plus 1fil}
%    \end{macrocode}
% \end{macro}
% \end{macro}
% \end{macro}
%
% \begin{macro}{\l_GAL_start_skip}
% \begin{macro}{\l_GAL_linefill_skip}
% \begin{macro}{\l_GAL_parshape_firstline_indent_dim}
% And while we are at it, we might as well allocate two additional
% skips which are related to justification: |\l_GAL_start_skip| the
% counterpart to |\l_GAL_real_parfill_skip| at the beginning of the
% paragraph and |\l_GAL_linefill_skip| which will hold the space to be
% inserted before a forced newline (as in |\\|). Also get a |dim|
% register for the indentation of the first line.
%    \begin{macrocode}
\skip_new:N\l_GAL_start_skip
\skip_new:N\l_GAL_linefill_skip
\dim_new:N \l_GAL_parshape_firstline_indent_dim
%    \end{macrocode}
% \end{macro}
% \end{macro}
% \end{macro}
%
%
% \begin{macro}{\l_GAL_real_interword_skip}
% \begin{macro}{\l_GAL_real_xinterword_skip}
% |\spaceskip| and |\xspaceskip| are needed when doing proper ragged
% settings so they are part of the interface.
%    \begin{macrocode}
\cs_set_eq:NN\l_GAL_real_interword_skip\tex_spaceskip:D
\cs_undefine:N \spaceskip
\skip_new:N\spaceskip
\cs_set_eq:NN\l_GAL_real_xinterword_skip\tex_xspaceskip:D
\cs_undefine:N \xspaceskip
\skip_new:N\xspaceskip
%    \end{macrocode}
% \end{macro}
% \end{macro}
%
% \begin{macro}{\l_GAL_real_interline_skip}
% The next is not yet (but perhaps it should be as well).
%    \begin{macrocode}
\cs_set_eq:NN\l_GAL_real_interline_skip\tex_lineskip:D
\cs_undefine:N \lineskip
\skip_new:N\lineskip
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\GAL_real_par:}
% We better have a version of the real |\par| primitive.
%    \begin{macrocode}
\cs_set_eq:NN \GAL_real_par: \tex_par:D
%    \end{macrocode}
% \end{macro}
%
% \subsection{Some extra scratch registers}
%
% \begin{macro}{\l_GAL_tmpa_int}
% \begin{macro}{\l_GAL_tmpa_skip}
% \begin{macro}{\l_GAL_tmpb_skip}
% \begin{macro}{\g_GAL_tmpa_box}
% Those registers are needed by the mutator functions and we better
% not rely on general scratch registers (at least not for the
% moment). The box register is for the indentation box.
%    \begin{macrocode}
\int_new:N\l_GAL_tmpa_int
%    \end{macrocode}
%
%    \begin{macrocode}
\skip_new:N\l_GAL_tmpa_skip
\skip_new:N\l_GAL_tmpb_skip
%    \end{macrocode}
%
%    \begin{macrocode}
\box_new:N\g_GAL_tmpa_box
%    \end{macrocode}
%
%    \begin{macrocode}
\tl_new:N\g_GAL_b_static_tl
\tl_new:N\g_GAL_p_static_tl
\tl_new:N\g_GAL_v_static_tl
\tl_new:N\g_GAL_uv_static_tl
\tl_new:N\g_GAL_up_static_tl
\tl_new:N\g_GAL_pw_static_tl
\tl_new:N\g_GAL_j_static_tl
\tl_new:N\g_GAL_o_static_tl
\tl_new:N\g_GAL_ps_static_tl
\tl_new:N\g_GAL_i_static_tl
\tl_new:N\g_GAL_nw_static_tl
\tl_new:N\g_GAL_q_static_tl
\tl_new:N\g_GAL_b_current_tl
\tl_new:N\g_GAL_uv_current_tl
\tl_new:N\g_GAL_up_current_tl
\tl_new:N\g_GAL_pw_current_tl
\tl_new:N\g_GAL_o_current_tl
\tl_new:N\g_GAL_j_current_tl
\tl_new:N\g_GAL_ps_current_tl
\tl_new:N\g_GAL_nw_current_tl
\tl_new:N\g_GAL_q_current_tl

% next two are currently not really used (see comments above)
\tl_new:N\g_GAL_m_current_tl
\tl_new:N\g_GAL_h_current_tl
%    \end{macrocode}
% \end{macro}
% \end{macro}
% \end{macro}
% \end{macro}
%
%
%
% \subsection{Galley data structure}\label{sec:galley-concept-impl}
%
% \subsubsection{Original concepts}
%
% In earlier implementations of \texttt{galley2.dtx}, galley objects
% have been represented in the following fashion:
%
% \begin{itemize}
% \item the long range values are stored in a within one level in
%   global a plist with the name |\g_GAL_static_hmode_prop| which is a
%   property list keeping all individual galley values for hmode. The
%   keys in the property list are of the form
%   |\GAL@|\meta{letter(s)}|@|.
% \item a copy of this plist is saved away under the name
%   |\GAL@static@hmode@|\meta{level-num}|@plist| just before we start
%   a new level so that when returning to a level the previous state can
%   be reconstructed.\footnote{Instead of doing a global save under a
%    name associated with the level number we could probably simply
%    save the list locally and use the savestack since each new level
%    has to be always associated with a new group anyway!}
% \item the keys in the above plists are also used directly as global
%   variables holding the actual current values of the galley object
%   parameters which allows fast access.
% \item similar plists exists for vmode and perhaps we want even
%   more\footnote{but perhaps not, putting the parameters in different
%   plists is mainly a speed thing, we can use flags to reinit only
%   things that have changed; the lists are shorter which makes
%   property handling faster, etc, but it needs some careful studying
%   at a later stage whether this is really beneficial---in principle
%   there is no problem with keeping all parameters in a single plist.}
% \end{itemize}
% This means that to make a long-term change to some galley object
% parameter one has to change the property within the
% |\GAL@static@|\meta{h/v}|mode@plist|. Such a change is then
% propagated to both the saved version as well as the global key
% commands.
%
% \subsubsection{Current concepts}
%
% After some evaluation I decided to change this setup in favour of
% the following:
%
% \begin{itemize}
% \item Actual values are represented by global token list variables of
%   the form |\g_GAL_|\meta{letter(s)}|_current_tl|.
% \item If they are supposed to be reset after each usage their
%   long-term (static) value is recorded globally in
%   |\g_GAL_|\meta{letter(s)}|_static_tl|.
% \item When starting a new galley level saved versions of the dynamic
%   parameters are stored locally in
%   |\l_GAL_|\meta{letter(s)}|_current_tl| and those for the static
%   parameters are stored in
%   |\l_GAL_|\meta{letter(s)}|_static_tl|. When the level is popped
%   those values are used to restore the state of the parameters. A
%   consequence of this setup is that starting a new galley state
%   should always involve a new group level!
% \end{itemize}
% This means that to make a long-term change to some galley object
% parameter one has to change the
% |\g_GAL_|\meta{letter(s)}|_static_tl| parameter (if it exists) as
% well as the |\g_GAL_|\meta{letter(s)}|_current_tl| one.
%
% If a new parameter is added to this setup we have to modify the
% following functions below: |\GAL_init_static:|,
% |\GAL_save_galley_state:|, \\
% |\GAL_restore_galley_state:|, and
% |\GAL_init_dynamic_fully:|.
%
% \begin{macro}{\GAL_init_static:}
% The |\GAL_init_static:| function initialises the static and dynamic
% parameters with fixed defaults. This is, for example, used when
% starting a new level. At a later state one probably want to be able
% to globally set even those defaults for a whole document, but for
% now this is probably okay.
%
%    \begin{macrocode}
\cs_new_nopar:Npn\GAL_init_static: {
  \tl_gset:Nn \g_GAL_b_static_tl {\c_zero}
  \tl_gset:Nn \g_GAL_p_static_tl {\c_zero}
  \tl_gset:Nn \g_GAL_v_static_tl {-1sp}
  \tl_gset:Nn \g_GAL_uv_static_tl {\c_zero_skip}
  \tl_gclear:N \g_GAL_up_static_tl
  \tl_gclear:N \g_GAL_pw_static_tl
  \tl_gset:Nn \g_GAL_j_static_tl {
    \c_zero_skip\leftskip\rightskip\parfillskip
    \spaceskip\xspaceskip\parfillskip\parindent}
  \tl_gclear:N \g_GAL_o_static_tl
  \tl_gclear:N \g_GAL_ps_static_tl
  \tl_gset:Nn \g_GAL_i_static_tl {\c_zero}
  \tl_gclear:N \g_GAL_nw_static_tl
  \tl_gclear:N \g_GAL_q_static_tl
%    \end{macrocode}
%
%    The definition of |\par| is kind of static.\footnote{Do we need
%    to set the internal version of \texttt{\textbackslash everypar}
%    as well?}
%    \begin{macrocode}
   \GAL_set_normal_par:
%    \end{macrocode}
%
%    Having the static parameter updated we have to initialise the
%    dynamic ones as well.
%    \begin{macrocode}
   \GAL_init_dynamic_fully:
%    \end{macrocode}
%    The seldom used parameters for linebreaking and
%    hyphenation are not subject to the galley concept but are set for
%    the whole galley. For this reason the code below should be moved
%    outside this macro.
%
%    We interface to a default template instance so that the default
%    can be easily overwritten on the class level.\footnote{bad idea?
%    good idea?}
%    \begin{macrocode}
   \UseInstance{hj}{default}
%% alternative
%%   \UseInstance{hyphenation}{default}
%%   \UseInstance{linebreak}{default}
}
%    \end{macrocode}
% \end{macro}
%
%
%
%    \begin{macrocode}
\tl_new:N \l_GAL_b_current_tl
\tl_new:N \l_GAL_p_current_tl
\tl_new:N \l_GAL_v_current_tl
\tl_new:N \l_GAL_uv_current_tl
\tl_new:N \l_GAL_up_current_tl
\tl_new:N \l_GAL_pw_current_tl
\tl_new:N \l_GAL_o_current_tl
\tl_new:N \l_GAL_j_current_tl
\tl_new:N \l_GAL_ps_current_tl
\tl_new:N \l_GAL_i_current_tl
\tl_new:N \l_GAL_nw_current_tl
\tl_new:N \l_GAL_q_current_tl
%    \end{macrocode}
%
%    \begin{macrocode}
\tl_new:N \l_GAL_b_static_tl
\tl_new:N \l_GAL_p_static_tl
\tl_new:N \l_GAL_v_static_tl
\tl_new:N \l_GAL_uv_static_tl
\tl_new:N \l_GAL_up_static_tl
\tl_new:N \l_GAL_pw_static_tl
\tl_new:N \l_GAL_o_static_tl
\tl_new:N \l_GAL_j_static_tl
\tl_new:N \l_GAL_ps_static_tl
\tl_new:N \l_GAL_i_static_tl
\tl_new:N \l_GAL_nw_static_tl
\tl_new:N \l_GAL_q_static_tl
%    \end{macrocode}
%
% \begin{macro}{\GAL_save_galley_state:}
%   The |\GAL_save_galley_state:| function saves away a copy of the
%   current static plists in a way that it can be retrieved when
%   returning to the current level. In the new implementation this
%   means locally saving all the dynamic parameters to their local
%   counterparts (i.e., |\l_GAL_|\meta{letter}|_current_tl| to
%   |\g_GAL_|\meta{letter}|_current_tl|) and the same for the static
%   parameters.
%    \begin{macrocode}
\cs_new_nopar:Npn \GAL_save_galley_state: {
  \tl_set_eq:NN \l_GAL_b_current_tl \g_GAL_b_current_tl
  \tl_set_eq:NN \l_GAL_p_current_tl \g_GAL_p_current_tl
  \tl_set_eq:NN \l_GAL_v_current_tl \g_GAL_v_current_tl
  \tl_set_eq:NN \l_GAL_uv_current_tl \g_GAL_uv_current_tl
  \tl_set_eq:NN \l_GAL_up_current_tl \g_GAL_up_current_tl
  \tl_set_eq:NN \l_GAL_pw_current_tl \g_GAL_pw_current_tl
  \tl_set_eq:NN \l_GAL_o_current_tl \g_GAL_o_current_tl
  \tl_set_eq:NN \l_GAL_j_current_tl \g_GAL_j_current_tl
  \tl_set_eq:NN \l_GAL_ps_current_tl \g_GAL_ps_current_tl
  \tl_set_eq:NN \l_GAL_i_current_tl \g_GAL_i_current_tl
  \tl_set_eq:NN \l_GAL_nw_current_tl \g_GAL_nw_current_tl
  \tl_set_eq:NN \l_GAL_q_current_tl \g_GAL_q_current_tl
%    \end{macrocode}
%    \begin{macrocode}
  \tl_set_eq:NN \l_GAL_b_static_tl \g_GAL_b_static_tl
  \tl_set_eq:NN \l_GAL_p_static_tl \g_GAL_p_static_tl
  \tl_set_eq:NN \l_GAL_v_static_tl \g_GAL_v_static_tl
  \tl_set_eq:NN \l_GAL_uv_static_tl \g_GAL_uv_static_tl
  \tl_set_eq:NN \l_GAL_up_static_tl \g_GAL_up_static_tl
  \tl_set_eq:NN \l_GAL_pw_static_tl \g_GAL_pw_static_tl
  \tl_set_eq:NN \l_GAL_o_static_tl \g_GAL_o_static_tl
  \tl_set_eq:NN \l_GAL_j_static_tl \g_GAL_j_static_tl
  \tl_set_eq:NN \l_GAL_ps_static_tl \g_GAL_ps_static_tl
  \tl_set_eq:NN \l_GAL_i_static_tl \g_GAL_i_static_tl
  \tl_set_eq:NN \l_GAL_nw_static_tl \g_GAL_nw_static_tl
  \tl_set_eq:NN \l_GAL_q_static_tl \g_GAL_q_static_tl
%    \end{macrocode}
% The current definition of |\par| is handled manually (really
% manually)\footnote{Now this is pretty dangerous but i'm not sure
% this can be avoided: if \texttt{\textbackslash par} is being
% manually changed outside the control of these macros we might end up
% in deep shit. For example the old definition of tabular does this
% and the result is pretty bad, ie endless loop with
% \texttt{\textbackslash par} being a noop. any ideas?}
%    \begin{macrocode}
  \cs_set_eq:NN\GAL_saved_par:\par
%    \end{macrocode}
% We also have to track the state of the |\g_GAL_reassign_tl|:
%    \begin{macrocode}
  \tl_set_eq:NN\l_GAL_reassign_saved_tl\g_GAL_reassign_tl
}
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\GAL_restore_galley_state:}
% And here we have the reverse operation which is needed when we
% return to a previous level.
%    \begin{macrocode}
\cs_new_nopar:Npn \GAL_restore_galley_state: {
  \tl_gset_eq:NN \g_GAL_b_current_tl \l_GAL_b_current_tl
  \tl_gset_eq:NN \g_GAL_p_current_tl \l_GAL_p_current_tl
  \tl_gset_eq:NN \g_GAL_v_current_tl \l_GAL_v_current_tl
  \tl_gset_eq:NN \g_GAL_uv_current_tl \l_GAL_uv_current_tl
  \tl_gset_eq:NN \g_GAL_up_current_tl \l_GAL_up_current_tl
  \tl_gset_eq:NN \g_GAL_pw_current_tl \l_GAL_pw_current_tl
  \tl_gset_eq:NN \g_GAL_o_current_tl \l_GAL_o_current_tl
  \tl_gset_eq:NN \g_GAL_j_current_tl \l_GAL_j_current_tl
  \tl_gset_eq:NN \g_GAL_ps_current_tl \l_GAL_ps_current_tl
  \tl_gset_eq:NN \g_GAL_i_current_tl \l_GAL_i_current_tl
  \tl_gset_eq:NN \g_GAL_nw_current_tl \l_GAL_nw_current_tl
  \tl_gset_eq:NN \g_GAL_q_current_tl \l_GAL_q_current_tl
%    \end{macrocode}
%    \begin{macrocode}
  \tl_gset_eq:NN \g_GAL_b_static_tl \l_GAL_b_static_tl
  \tl_gset_eq:NN \g_GAL_p_static_tl \l_GAL_p_static_tl
  \tl_gset_eq:NN \g_GAL_v_static_tl \l_GAL_v_static_tl
  \tl_gset_eq:NN \g_GAL_uv_static_tl \l_GAL_uv_static_tl
  \tl_gset_eq:NN \g_GAL_up_static_tl \l_GAL_up_static_tl
  \tl_gset_eq:NN \g_GAL_pw_static_tl \l_GAL_pw_static_tl
  \tl_gset_eq:NN \g_GAL_o_static_tl \l_GAL_o_static_tl
  \tl_gset_eq:NN \g_GAL_j_static_tl \l_GAL_j_static_tl
  \tl_gset_eq:NN \g_GAL_ps_static_tl \l_GAL_ps_static_tl
  \tl_gset_eq:NN \g_GAL_i_static_tl \l_GAL_i_static_tl
  \tl_gset_eq:NN \g_GAL_nw_static_tl \l_GAL_nw_static_tl
  \tl_gset_eq:NN \g_GAL_q_static_tl \l_GAL_q_static_tl
%    \end{macrocode}
%    \begin{macrocode}
  \cs_gset_eq:NN\par\GAL_saved_par:
  \tl_gset_eq:NN\g_GAL_reassign_tl\l_GAL_reassign_saved_tl
%    \end{macrocode}
%    As long as we to not set up the individual paragraph shape
%    parameters each time (see comments in
%    |\GAL_set_horizontal_objects:|) we have to restore them at this
%    point as well.
%    \begin{macrocode}
  \exp_after:wN \GAL_setup_paragraph_justification:nnnnnnnn \g_GAL_j_current_tl
}
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\GAL_saved_par:}
% Recover from confusion: the top-level definition of |\GAL_saved_par:|
% should never get assigned to |\par| but in case it is (by getting
% the grouping wrong) we better try to recover
% gracefully\footnote{Gracefully meaning I haven't bothered with
% producing anything other than an undefined csname error :-)}, so
% instead of ending up with a |\par| being an undefined command we do
% the following:
%    \begin{macrocode}
\cs_new_nopar:Npn\GAL_saved_par:{\ERROR\GAL_normal_par:}
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\GAL_init_dynamic_as_necessary:}
%    Whenever parameters got changed for one paragraph the
%    |\g_GAL_reassign_tl| gets extended with an assignment that resets
%    the parameter back to its static value. The
%    |\GAL_init_dynamic_as_necessary:| then executes this list and afterwards
%    define it to be empty.
%    \begin{macrocode}
\cs_new_nopar:Npn\GAL_init_dynamic_as_necessary: {
%<*trace>
  \GAL_typeout:n{Reinit~ parameters \on@line}
  \GAL_typeout:n{\@spaces \meaning  \g_GAL_reassign_tl}
%</trace>
  \g_GAL_reassign_tl
  \tl_gclear:N\g_GAL_reassign_tl
}
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\GAL_init_dynamic_fully:}
%    Sometimes we want to ensure that all parameter are set to their
%    static values. This is done by the |\GAL_init_dynamic_fully:| macro.
%    \begin{macrocode}
\cs_new_nopar:Npn \GAL_init_dynamic_fully: {
%<*trace>
  \GAL_typeout:n{Reinit~ parameters \on@line}
%</trace>
  \tl_gset_eq:NN \g_GAL_b_current_tl \g_GAL_b_static_tl
  \tl_gset_eq:NN \g_GAL_p_current_tl \g_GAL_p_static_tl
  \tl_gset_eq:NN \g_GAL_v_current_tl \g_GAL_v_static_tl
  \tl_gset_eq:NN \g_GAL_uv_current_tl \g_GAL_uv_static_tl
  \tl_gset_eq:NN \g_GAL_up_current_tl \g_GAL_up_static_tl
  \tl_gset_eq:NN \g_GAL_pw_current_tl \g_GAL_pw_static_tl
  \tl_gset_eq:NN \g_GAL_o_current_tl \g_GAL_o_static_tl
  \tl_gset_eq:NN \g_GAL_j_current_tl \g_GAL_j_static_tl
  \tl_gset_eq:NN \g_GAL_ps_current_tl \g_GAL_ps_static_tl
  \tl_gset_eq:NN \g_GAL_i_current_tl \g_GAL_i_static_tl
  \tl_gset_eq:NN \g_GAL_nw_current_tl \g_GAL_nw_static_tl
  \tl_gset_eq:NN \g_GAL_q_current_tl \g_GAL_q_static_tl
%    \end{macrocode}
%    And since everything is as the static value there is nothing for
%    us to reassign so be make this list empty.
%    \begin{macrocode}
  \tl_gclear:N\g_GAL_reassign_tl
}
%    \end{macrocode}
%  \end{macro}
%
%
% \begin{macro}{\g_GAL_reassign_tl}
% \begin{macro}{\g_GAL_reassign_saved_tl}
%    The |\g_GAL_reassign_tl| holds the parameters that need to be
%    reset at the next paragraph or more exactly it holds the
%    assignments that do the resetting. So by default this is empty.
%    \begin{macrocode}
\tl_new:N \g_GAL_reassign_tl
\tl_new:N \l_GAL_reassign_saved_tl
%    \end{macrocode}
%  \end{macro}
%  \end{macro}
%
% \begin{macro}{\GAL_prepare_reassign:NN}
%   The |\GAL_prepare_reassign:NN| macro receives the internal names
%   of dynamic and static placeholder for a parameter and extends the
%   |\g_GAL_reassign_tl|.
%    \begin{macrocode}
\cs_new_nopar:Npn\GAL_prepare_reassign:NN #1#2{
%    \end{macrocode}
%    It might pay off to make a quick check whether or not the value
%    of the dynamic parameter really differs from those of the static
%    one. If not we can avoid updating the |\g_GAL_reassign_tl| which
%    takes some time and further more makes later updates of this list
%    slower.\footnote{This needs some empirical  testing: if most
%    of the time this test results in false then it might be better to
%    remove it though. One such test indicated that removal might be
%    better but this isn't far from being conclusive.}
%    \begin{macrocode}
  \if_meaning:w#1#2
  \else:
    \tl_gput_right:Nn \g_GAL_reassign_tl {\tl_gset_eq:NN #1 #2 }
  \fi:
}
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\GAL_prepare_reassign:n}
%   In contrast |\GAL_prepare_reassign:n| takes only the id for a
%   parameter, such as |v| or |up|. It also has some extra code to
%   check if the parameter is actually one that has both dynamic and
%   static incarnations.\footnote{In the current implementation this
%     is probably always the case but if we re-add \texttt{m} and
%     \texttt{h} we may not want to reset them on every paragraph but
%     handle them always as static for the whole galley.} If not we
%   don't need to reassign.\footnote{Furthermore, for speed
%     consideration it might be advisable to internally always
%     replaces the call to this command by
%     \texttt{\detokenize{GAL_prepare_reassign:NN}} since this will
%     always saves at least one extra csname parsing.}
%    \begin{macrocode}
\cs_new_nopar:Npn \GAL_prepare_reassign:n #1{
  \cs_if_free:cTF{g_GAL_#1_static_tl}{
%<*trace>
    \GAL_typeout:n{Not~ reassigning~ for~ #1!}
%</trace>
  }{
    \exp_args:Ncc
    \GAL_prepare_reassign:NN {g_GAL_#1_current_tl}{g_GAL_#1_static_tl}
  }
}
%    \end{macrocode}
% \end{macro}
%
%
%
%
%
% \subsubsection{Starting and ending a level}
%
% The |\GAL_start_level:| command first saves away the current state
% and then starts a new group. This group (|\c_group_begin_token|)
% will be matched by the closing brace of the current ``vbox'' either
% the explicit |}| or an |\c_group_end_token| equivalent of that. The
% |\GAL_cleanup_level:| which then gets into control is supposed to
% restore the state and finally issue and |\c_group_end_token| which
% will then actually end the box.
%
% \begin{macro}{\GAL_start_level:}
%    \begin{macrocode}
\cs_new_nopar:Npn\GAL_start_level:{
  \GAL_save_galley_state:
  \c_group_begin_token
%<*trace>
  \int_incr:N \l_GAL_level_int
  \GAL_typeout:n{Entering~ galley~ level:~
    \int_use:N\l_GAL_level_int~ \on@line
  }
%</trace>
  \GAL_init_static:
  \bool_set_true:N\l_GAL_first_on_level_bool     % temp solution!
                                                 % see below
  \group_insert_after:N\GAL_cleanup_level:}
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\l_GAL_level_int}
%    The counter is really only necessary if tracing is compiled in,
%    however we define it always just to ensure that the allocation
%    doesn't change if tracing is added.
%    \begin{macrocode}
\int_new:N \l_GAL_level_int
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\l_GAL_first_on_level_bool}
%    This belongs to some hack which needs some better
%    implementation. It signals that we are at the beginning of a galley.
%    \begin{macrocode}
\bool_new:N \l_GAL_first_on_level_bool
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\GAL_cleanup_level:}
%    \begin{macrocode}
\cs_new_nopar:Npn\GAL_cleanup_level:{
  \par
  \GAL_finish_typesetting:
%<*trace>
  \GAL_typeout:n{Returning~ to~ galley~ level:~
    \int_use:N\l_GAL_level_int~ \on@line
  }
%</trace>
  \GAL_restore_galley_state:
  \c_group_end_token
}
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\GAL_finish_typesetting:}
%  At the end of a galley (if in vmode) we have to ensure that we
%    don't have any dangling bits in the data structure (like
%    untypeset specials or writes that want to make their appearance
%    at the beginning of the next paragraph. This is what
%    |\GAL_finish_typesetting:| is supposed to take care
%    of\footnote{one day}.
%    \begin{macrocode}
\cs_new_nopar:Npn\GAL_finish_typesetting: {}
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\g_GAL_everyvbox_toks}
%    We start a new galley with every vbox.
%    \begin{macrocode}
\cs_set_eq:NN \g_GAL_everyvbox_toks \tex_everyvbox:D
\toks_set:Nn\g_GAL_everyvbox_toks{\GAL_start_level:}
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\insert}
%   Interestingly enough |\g_GAL_everyvbox_toks| is not triggered by
%   |\inserts| even though those are also vboxes so we have to do it
%   manually here (and that is a bit of a pain~\ldots).  There are
%   cases where after the |\insert| we have stuff like
%   |\csname...\endcsname| and to ensure that we don't fall over in
%   that case our redefinition has to be a bit elaborate. Of course
%   all this is only of interest if we stay with the current
%   implementation of always automatically starting a galley.
%    \begin{macrocode}
\cs_undefine:N \insert
\DeclareDocumentCommand\insert{+l +m}{
  \tex_insert:D#1{\GAL_start_level:#2\par}}
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\GAL_ignore_next_galley:}
% \begin{macro}{\GAL_ignore_next_galley_vbox:}
%    We may not need the next two commands at all if we change from
%    setting up a galley everywhere to setting up galleys only for
%    ``minipage'' like vboxes. And i think we should!
%    \begin{macrocode}
\cs_new_nopar:Npn\GAL_ignore_next_galley:{
  \g_GAL_everyvbox_toks{\toks_gset:Nn\g_GAL_everyvbox_toks{\GAL_start_level:}}
}
\cs_new_nopar:Npn\GAL_ignore_next_galley_vbox:{
  \g_GAL_everyvbox_toks{\toks_gset:Nn\g_GAL_everyvbox_toks{\GAL_start_level:}}
  \tex_vbox:D
}
%    \end{macrocode}
% \end{macro}
% \end{macro}
%
%
% \subsubsection{Using the galley data structure}
%
% \begin{macro}{\GAL_show_data_structure:n}
%    Some tracing to show the state of the data structure.
%    As some internal params take arbitrary content we have to be a bit careful
%    displaying them. Needs (some:-) improvement to be useful.
%    \begin{macrocode}
%<*trace>
\cs_new_nopar:Npn \GAL_show_data_structure:n #1{
  \GAL_typeout:n{#1^^J
    \@spaces nominal~ width~ =~ \dim_use:N\hsize ^^J
    \@spaces left~ indentation~ =~ \dim_use:N\@totalleftmargin ^^J
    \@spaces break~ switch~ (b)~ =~
    \g_GAL_b_current_tl \space (\g_GAL_b_static_tl) ^^J
    \@spaces v-penalty~ (p)~ =~
    \g_GAL_p_current_tl \space (\g_GAL_p_static_tl) ^^J
    \@spaces v-space~ (v)~ =~
    \g_GAL_v_current_tl \space (\g_GAL_v_static_tl) ^^J
    \@spaces user~ v-penalty~ (up)~ =~ \g_GAL_up_current_tl ^^J
    \@spaces user~v-space~ (uv)~ =~ \g_GAL_uv_current_tl ^^J
    \@spaces prev-whatits~ (pw)~ =~ \tl_to_str:N \g_GAL_pw_current_tl ^^J
    \@spaces next-whatits~ (nw)~ =~ \tl_to_str:N \g_GAL_nw_current_tl ^^J
    \@spaces parshape~spec~ (ps)~ =~
    \g_GAL_ps_current_tl \space (\g_GAL_ps_static_tl) ^^J
    \@spaces queries~ (q)~ =~ \tl_to_str:N \g_GAL_q_current_tl ^^J
    \@spaces indent~ flag~ (i)~ =~
    \g_GAL_i_current_tl  \space (\g_GAL_i_static_tl) ^^J
    \@spaces para~ object~ (o)~ =~ \tl_to_str:N \g_GAL_o_current_tl ^^J
    \@spaces para~ justification~ (j)~ =~ \tl_to_str:N \g_GAL_j_current_tl }
}
%</trace>
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\GAL_use_on_paragraph:}
% The next function is called when \TeX{} switches to horizontal mode,
% i.e., at the start of a paragraph.
%
%    \begin{macrocode}
\cs_new_nopar:Npn\GAL_use_on_paragraph:{
%<*trace>
  \GAL_show_data_structure:n{Para~ start~ for~ galley~
                          level~ \int_use:N\l_GAL_level_int \on@line}
%</trace>
%    \end{macrocode}
%    At the start of a new galley we do not want to have any vertical
%    space being inserted not even a zero |\parskip| since that would
%    mess up use of |\vtop| etc.  The below is a sort of crude fix for
%    the problem ie this is the old minipage switch.
%
%    What about a redesign???
%    \begin{macrocode}
  \bool_if:NTF \l_GAL_first_on_level_bool
    \GAL_handle_first_paragraph:
%    \end{macrocode}
%
%
%    We want to return to vmode without leaving too much trace. so we
%    remove the indentation box and call |\GAL_real_par:|. All this is done
%    in a group to keep an already setup |\parshape|, eg in a list. In
%    fact we might want to have this parshape setting as part of the
%    galley-objects but this is not done so far.\footnote{There is a
%    problem with code like this which was the result of a pr in
%    \LaTeXe. If the start of a paragraph is triggered by certain very
%    special commands (such as encoding-specific accents that involve
%    grouping) we might have the case that such a command already
%    started a group and then triggers the paragraph mechanism which
%    in turn triggers this macro. That may result in those groups to
%    overlap in a bad way---needs some clear instruction perhaps
%    \texttt{\textbackslash leavevmode} in all potential cases.}
%    \begin{macrocode}
  {
    \group_begin:
      \box_gset_to_last:N \g_GAL_tmpa_box
      \GAL_real_par:
      \GAL_set_vertical_objects:
%    \end{macrocode}
%    Before reentering h-mode we better clear the everypar register or
%    we end up in a loop:
%    \begin{macrocode}
      \toks_clear:N\l_GAL_real_everypar_toks
      \tex_noindent:D
    \group_end:
  }
%    \end{macrocode}
%    Instead of setting up the measure each time one could probably
%    move this to the template setting things up (or not?)
%    \begin{macrocode}
    \GAL_set_measure:
    \GAL_set_horizontal_objects:
%    \end{macrocode}
%    At this point during the processing the parameters are all
%    reinitialised, i.e., anything not yet used will be
%    lost!\footnote{This is important if you think about paragraph
%    ending stuff which is not yet implemented}
%    \begin{macrocode}
    \GAL_init_dynamic_as_necessary:
}
%    \end{macrocode}
% \end{macro}
%
%
%
% \begin{macro}{\GAL_handle_first_paragraph:}
% Since this part of the code from above is not used that often it was
% placed into a separate command (for faster skipping).
%
% What needs to be done always?
%    \begin{macrocode}
\cs_new_nopar:Npn\GAL_handle_first_paragraph: {
  \bool_set_false:N\l_GAL_first_on_level_bool
  \g_GAL_pw_current_tl
%    \end{macrocode}
%    \begin{macrocode}
    \skip_set:Nn\l_tmpa_skip \g_GAL_uv_current_tl
    \dim_compare:nNnF \l_tmpa_skip =\c_zero_dim {
%    \end{macrocode}
%    \begin{macrocode}
      \mode_if_horizontal:TF
      {
        \group_begin:
          \box_gset_to_last:N\g_GAL_tmpa_box
          \GAL_real_par:
          \skip_vertical:n {\l_tmpa_skip}
          \toks_clear:N\l_GAL_real_everypar_toks
          \tex_noindent:D
        \group_end:
      }{ \skip_vertical:n {\l_tmpa_skip} }
    }
}
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\GAL_use_on_vobject:}
% The other case where (part of) the galley data structure is going to
% be used is the case when we are already in vertical mode but want to
% append some vertical mode material (e.g., a rule, an inline float)
% or start some environment that likes to look like a paragraph even
% though it doesn't actually uses \TeX's low-level mechanisms (e.g.,
% longtable?, tabbing, \ldots).
%    \begin{macrocode}
\cs_new_nopar:Npn\GAL_use_on_vobject:{
%<*trace>
  \GAL_show_data_structure:n{V-object~ for~ galley~
                          level~ \int_use:N\l_GAL_level_int \on@line}
%</trace>
  \bool_if:NTF\l_GAL_first_on_level_bool
    \GAL_handle_first_paragraph:
    \GAL_set_vertical_objects:
  \GAL_init_dynamic_as_necessary:
}
%    \end{macrocode}
% The use of this command should be followed by a |\nobreak| after the
% v-object or else we introduce an unwanted breakpoint due to the next
% |\parskip| being inserted.
%
% \end{macro}
%
%
% \begin{macro}{\GAL_set_vertical_objects:}
%    When setting the vertical components of the galley structure the
%    following happens:
%    \begin{itemize}
%    \item First any whatsits for the previous para are
%      inserted\footnote{A nobreak is probably not necessary at this
%      point as the
%      parskip should by now already be inserted so that the next
%      thing happening is an explicit penalty anyway.}
%    \item
%      If a document user command for penalties as been used (i.e., when
%      \PARM{user penalty} is none-empty) it take precedence and the internal
%      penalty value is ignored.
%    \item
%      Otherwise the \PARM{break switch} is checked. If this greater
%      zero a nobreak penalty is issued and \PARM{penalty} is ignored.
%    \item
%      Otherwise the \PARM{penalty} value is used.
%    \end{itemize}
%
%    \begin{macrocode}
\cs_new_nopar:Npn \GAL_set_vertical_objects: {
  \g_GAL_pw_current_tl
  \tl_if_empty:NTF \g_GAL_up_current_tl
  {
    \int_compare:nNnTF \g_GAL_b_current_tl > \c_zero
    {\penalty_set:n \c_ten_thousand}
    {\penalty_set:n \g_GAL_p_current_tl}
  }
  {\penalty_set:n\g_GAL_up_current_tl}
%    \end{macrocode}
%    A user skip as supplied by |\vspace| etc.\ is going into a
%    separate register to ensure that it will always have the effect
%    of adding extra space independent of what surrounding
%    environments do.
%
%    The |\parskip| below is not the \TeX{} primitive (which is always
%    zero) but a user level register which is only applied at this
%    point if ever.
%    \begin{macrocode}
   \skip_set:Nn\l_GAL_tmpa_skip {\g_GAL_v_current_tl}
%    \end{macrocode}
% |\parskip| gets applied if we are between two paragraphs without any
% further space requests; this is signalled by |\g_GAL_v_current_tl|
% having a value of |-1sp| (its default). Of course it is in theory
% possible that this value is the result to modification of
% |\g_GAL_v_current_tl| but allowing for this saves us an extra flag
% or register that would otherwise be needed and checked every time.
%    \begin{macrocode}
   \dim_compare:nNnTF \l_GAL_tmpa_skip = {-1sp}
   {\skip_vertical:n\parskip
%<*trace>
    \GAL_typeout:n{\parskip=\skip_use:N\parskip\space applied}
%</trace>
   }
   {\skip_vertical:n \l_GAL_tmpa_skip }
  \skip_vertical:n \g_GAL_uv_current_tl
}
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\GAL_set_measure:}
%   Some comments on the next macro: not sure: do we better set
%   parshape global? (can we?); of course it could and perhaps should
%   be run inline, also we might instead add |\parshape| to the
%   required content of |\g_GAL_ps_current_tl| so that we avoid the
%   test and simply execute it always.
%
%    \begin{macrocode}
\cs_new_nopar:Npn \GAL_set_measure: {
  \tl_if_empty:NTF \g_GAL_ps_current_tl
  { \tex_parshape:D \c_zero}
  { \tex_parshape:D \g_GAL_ps_current_tl}
}
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\GAL_set_horizontal_objects:}
% Once we are back in hmode we first output any waiting whatsits, then
% run any query setups, then
% look at the saved indentation box: if it is void we know that we had
% a paragraph started with |\noindent| otherwise we typeset some
% indentation then the galley object and finally a horizontal skip
% (might also want a break penalty there or even more stuff).
%
%    \begin{macrocode}
\cs_new_nopar:Npn \GAL_set_horizontal_objects: {
  \g_GAL_nw_current_tl
  \g_GAL_q_current_tl
%    \end{macrocode}
% The shape is now a multi-valued parameter so we pass it expanded and
% let |\GAL_setup_paragraph_justification:nnnnnnnn| do the assignments
% if necessary.
%
%    As a speedup measure we are comparing |\g_GAL_j_current_tl| to
%    the saved version |\g_GAL_j_static_tl|, if they are identical we
%    assume that all components of the multi-valued parameter are
%    already properly set up. This saves doing 8 assignments at every
%    paragraph. The catch is, that a change to the static parameter
%    (via |\GAL_set_SGPV_thing:nn| |s|) needs to be manually followed by
%    running |\GAL_setup_paragraph_justification:nnnnnnnn| (see
%    definition of \texttt{justification}
%    template).\footnote{Actually, that shortcut does not work
%      correctly! Needs thought! So commented out for the moment!}
%    \begin{macrocode}
%  \ifx \GAL@j@ \GAL@j@s % what is the right test to suppress?
%     \GAL_typeout:n{Not~ setting~ up~ paragraph~ shape}
%  \else
     \exp_after:wN \GAL_setup_paragraph_justification:nnnnnnnn
     \g_GAL_j_current_tl
%  \fi
  \int_compare:nNnT \g_GAL_i_current_tl = \c_zero
  {
    \box_if_empty:NF \g_GAL_tmpa_box {\hbox_to_wd:nn \l_GAL_real_parindent_dim{} }
  }
  \g_GAL_o_current_tl \scan_stop:
  \skip_horizontal:n \l_GAL_start_skip
  \GAL_setup_page_breaking_penalties:n \g_GAL_b_current_tl
}
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\GAL_setup_page_breaking_penalties:n}
% The way the following code is written (at the moment)
% |\clubpenalty|, |\interlinepenalty|, and |\brokenpenalty| are still
% available as user level registers so that setting up, say, the
% broken penalty default for the whole document is done via setting
% that particular register.
%
% Another observation is that we most likely do not have to set
%    |\GAL@@brokenpenalty| at all (and if |\l_GAL_real_interline_penalty| is
%    set to `nobreak' we can also leave |\l_GAL_real_club_penalty| alone)
%    since if i read it right these penalties are additive so one
%    large one should be sufficient.
%
%    \begin{macrocode}
\cs_new_nopar:Npn \GAL_setup_page_breaking_penalties:n #1{
  \int_set:Nn\l_GAL_real_club_penalty \clubpenalty
  \int_set:Nn\l_GAL_real_interline_penalty \interlinepenalty
%  \GAL@@brokenpenalty \brokenpenalty
  \if_case:w \int_eval:n{#1}
% 0
  \or:
% 1
  \or:
%2
    \int_set:Nn\l_GAL_real_club_penalty \c_ten_thousand
%    \GAL@@brokenpenalty \c_ten_thousand
  \or:
%3
    \int_set:Nn\l_GAL_real_interline_penalty \c_ten_thousand
%    \GAL@@brokenpenalty \c_ten_thousand
  \else:
% assume negative: this loops if called with a value greater than 3! so
% probably can't stay this way.
    \GAL_setup_page_breaking_penalties:n {-#1}
  \fi:
}
%    \end{macrocode}
% \end{macro}
%
%
%
% \begin{macro}{\GAL_setup_paragraph_justification:nnnnnnnn}
%    Setting up the inner paragraph shape, e.g., the justification is
%    done by breaking up the multi-value parameter |s| into its 8
%    components.\footnote{Do one has to make those settings global? Check!}
%    \begin{macrocode}
\cs_new_nopar:Npn \GAL_setup_paragraph_justification:nnnnnnnn #1#2#3#4#5#6#7#8{
  \skip_gset:Nn\l_GAL_start_skip {#1}
  \skip_gset:Nn\l_GAL_real_left_skip {#2}
  \skip_gset:Nn\l_GAL_real_right_skip {#3}
  \skip_gset:Nn\l_GAL_real_parfill_skip {#4}
  \skip_gset:Nn\l_GAL_real_interword_skip {#5}
  \skip_gset:Nn\l_GAL_real_xinterword_skip {#6}
  \skip_gset:Nn\l_GAL_linefill_skip {#7}
  \dim_gset:Nn\l_GAL_real_parindent_dim {#8}
}
%    \end{macrocode}
% \end{macro}
%
%
% \subsection{Handling of \texttt{\textbackslash par}}
%
% Depending on the state of the machinery |\par| might a get different
% definition.
%
% \begin{macro}{\GAL_normal_par:}
%    In most cases |\par| will be |\let| to |\GAL_normal_par:|.
%    \begin{macrocode}
\cs_new_nopar:Npn \GAL_normal_par: {
  \group_begin:
  \mode_if_vertical:TF
  { \GAL_real_par: }
  {                    %% For error-trapping needs
                       %%   \ifinner \ifhmode etc cases
%    \end{macrocode}
% At this point we might want to add and end par hook (not done);
% if we are not adding one then this definition can be optimised a lot
% (moving |\GAL_real_par:| up and using |\ifhmode| instead of the above).
%    \begin{macrocode}
        \GAL_real_par:
        %%%% NOTE: this puts us into vmode with the para on the galley
        %%%%       AND right here we have stuff that has migrated
        %%%%       (eg vadjust stuff) from the last line!!!
        \nobreak
  }
  \group_end:
}
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\@@par}
%    \LaTeX's saved version of the original |\par| primitive now needs
%    actually run |\GAL_normal_par:| to trick \LaTeX{} into accepting
%    this redefinition. This is needed at least as long as if we run
%    with a mixture of old and new code.
%    \begin{macrocode}
\cs_set_eq:NN\@@par\GAL_normal_par:
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\GAL_endlist_par:}
%
%    Another potential definition of |\par| comes into play when we
%    are at the end of a list environment and want to take different
%    actions depending on getting a continuation of the paragraph or a
%    real end. This code is not functional!
%
%    ATTENTION: most likely either have to set those locally or have
%    to save the state of |\par| as well! And anyway it is not
%    finished code yet!!!!
%
%    \begin{macrocode}
%<*unfinished>
\cs_new_nopar:Npn \GAL_endlist_par: {
  \group_begin:
  \mode_if_vertical:TF{
    \GAL_add_DGPV_dimension:nn v \GAL@v@X
    \GAL_add_DGPV_dimension:nn i \GAL@i@X
    \GAL_add_penalty:n       \GAL@p@X
    \GAL_set_normal_par:
  }{
    \GAL_real_par:
    \nobreak
  }
  \group_end:
}
%</unfinished>
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\GAL_set_normal_par:}
%    The |\GAL_set_normal_par:| states that we are in normal operation.
%    \begin{macrocode}
\cs_new_nopar:Npn\GAL_set_normal_par:{
  \cs_gset_eq:NN\par\GAL_normal_par:
}
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\GAL_set_endlist_par:}
%    The |\GAL_set_endlist_par:| states that we want to handle the end
%    of list case.
%    \begin{macrocode}
%<*unfinished>
\cs_new_nopar:Npn\GAL_set_endlist_par:{
  \cs_gset_eq:NN\par\GAL_endlist_par:
}
%</unfinished>
%    \end{macrocode}
% \end{macro}
%
%
%  \begin{macro}{\g_GAL_ignored_par_error_tl}
%
%    \begin{macrocode}
 \tl_new:N\g_GAL_ignored_par_error_tl
%    \end{macrocode}
%  \end{macro}
%
%
% For ignoring |\par| commands we currently have two functions.
%
% \begin{macro}{\GAL_set_ignored_par:n}
%    The |\GAL_set_ignored_par:n| command disables |\par| altogether and
%    hopes that the beginning of another paragraph shows up soon
%    (three |\par|s are allowed). If not it issues an error message
%    (arg 1) and redefines |\par| to be |\GAL_normal_par:|.
%    \begin{macrocode}
\cs_new_nopar:Npn \GAL_set_ignored_par:n #1 {
  \mode_if_vertical:TF
  {
    \int_gzero:N \par@deathcycles
    \cs_gset_eq:NN\par\GAL_ignored_par:
    \tl_gset:Nn\g_GAL_ignored_par_error_tl{#1}
    \GAL_appendto_DGPV_thing:nn q \GAL_set_normal_par:
%    \end{macrocode}
%    Not sure what should be done if this gets executed in hmode: a)
%    ignore the request b) output an error message c) run it and with
%    it have the rest of the document being typeset into a single
%    paragraph :-)?  Since c) isn't really an option we have to take
%    some precaution, for the moment i have added an error but perhaps
%    this should be restricted to appear really only in hmode as an
%    error not in a |\write|, say, so maybe the test should be for
%    hmode --- or perhaps the whole commands should be removed in
%    favour of the one below.
%    \begin{macrocode}
  }{
    \ERROR \GAL_set_normal_par: \par
  }
}
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\GAL_ignored_par:}
%    Helper function for |\GAL_set_ignored_par:n|.
%    \begin{macrocode}
\cs_new_nopar:Npn\GAL_ignored_par:{
  \int_gincr:N \par@deathcycles
  \int_compare:nNnT \par@deathcycles > \c_three
  {
    \PackageError{galley2}\g_GAL_ignored_par_error_tl\@ehd
    \GAL_set_normal_par:
    \par
  }
}
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\GAL_ignore_pars:n}
%    An alternative is to explicitly look out for |\par| and spaces
%    (the point being that this immediately set the definition of
%    |\par| back to its normal value if anything else is encountered).
%    Again up to three |\par|s are accepted otherwise we get an error
%    message.
%    \begin{macrocode}
\cs_new_nopar:Npn \GAL_ignore_pars:n #1 {
  \int_gzero:N \par@deathcycles
  \cs_gset_eq:NN\par\GAL_ignore_next_pars:
  \tl_gset:Nn\g_GAL_ignored_par_error_tl{#1}
  \GAL_ignore_next_pars:
}
%    \end{macrocode}
% \end{macro}
%
%
%
%
% \begin{macro}{\GAL_ignore_next_pars:}
%    And here is a helper for |\GAL_ignore_pars:n|.
%    \begin{macrocode}
\cs_new_nopar:Npn\GAL_ignore_next_pars: {
  \int_gincr:N \par@deathcycles
  \int_compare:nNnT \par@deathcycles > \c_three
  {
    \PackageError{galley2}\g_GAL_ignored_par_error_tl\@ehd
    \GAL_set_normal_par:
    \par
  }
  \peek_meaning:NTF\par{}{\GAL_set_normal_par:}
}
%    \end{macrocode}
% \end{macro}
%
%
%
%
%  \subsection{Support for paragraph shapes}
%
%
%
%
%
% \begin{macro}{\GAL_parshape_setup:nnnnnn}
%    The |\GAL_parshape_setup:nnnnnn| macro provides a low-level interface for
%    declaring special parshapes for the upcoming paragraph. It is
%    especially tuned to deal with the more common cases like
%    providing space for an initial or for an inline figure. It takes
%    six arguments with the following meaning:
%    \begin{itemize}
%    \item If a hole is to be cut on the left of the paragraph the
%      first argument should be
%      |{\dim_use:N\l_GAL_parshape_lineindent_dim}| otherwise
%      |\@totalleftmargin| (hole on the right). At the moment there is
%      no provision for special shapes on both sides of the
%      paragraph.\footnote{This is low-level but still more than
%        awkward so probably should be replaced by something nicer one
%        day.}
%    \item
%    The second argument gives the indentation to be used for all
%    lines following the last special line. Typical value would be
%    |\@totalleftmargin|, or in case of setting up hanging paragraphs,
%    |\@totalleftmargin+<amount of hang>|. More exactly this indentation
%    is assumed to be what is needed if this would have been a normal
%    paragraph. It is therefore also added to the special lines.
%    \item
%    The third argument gives the line width for all lines following
%    the last special line. Typical argument might be |\linewidth| or
%    in case of hanging paragraphs
%      |\linewidth+<amount of hang>|.\footnote{rewrite
%      description of this and previous item}
%    \item
%    The forth argument gives the number of lines before the first special
%    line (in case of an initial this would be 0 typically).
%    \item
%    The fifth argument gives an initial amount to be left free on all
%    special lines.
%    \item
%    Finally the sixth argument specifies the special lines as a comma
%    separated lists of dimensions. These dimensions are deltas to the
%    space specified in the forth argument.
%    \end{itemize}
%
%    Running this command has several effects:
%    \begin{itemize}
%    \item The |\g_GAL_ps_current_tl| parameter is getting updated,
%      ie it receives the area parshape spec.
%    \item In the |dim| register
%      |\l_GAL_parshape_firstline_indent_dim|, the indent of the first
%      special line (not taking into account the standard line
%      indentation) is made available for use by an application. This
%      can be used to get to the left point on the line to insert an
%      initial character or a figure.
%    \end{itemize}
%
%    \begin{macrocode}
\cs_new_nopar:Npn \GAL_parshape_setup:nnnnnn #1 #2 #3 #4 #5 #6{
%    \end{macrocode}
%
%    \begin{macrocode}
  \setlength\l_tmpa_dim{#2}
  \setlength\l_tmpb_dim{#3}
%    \end{macrocode}
%
%    \begin{macrocode}
  \int_zero:N \l_GAL_parshape_linecount_int
  \tl_gclear:N \g_GAL_ps_current_tl
  \int_while_do:nNnn \l_GAL_parshape_linecount_int < {#4} {
    \tl_gput_right:Nx\g_GAL_ps_current_tl{
      \space\dim_use:N\l_tmpa_dim\space \dim_use:N\l_tmpb_dim
    }
    \int_incr:N \l_GAL_parshape_linecount_int
  }
%    \end{macrocode}
%
%    \begin{macrocode}
  \clist_map_variable:NNn{#6}\l_GAL_parshape_next_tl{
    \int_incr:N\l_GAL_parshape_linecount_int
    \setlength\l_GAL_parshape_lineindent_dim{
      \l_tmpa_dim+#5+\l_GAL_parshape_next_tl
    }
    \dim_set:Nn\l_GAL_parshape_linewidth_dim {
      \l_tmpa_dim+\l_tmpb_dim-\l_GAL_parshape_lineindent_dim
    }
%    \end{macrocode}
%
%    \begin{macrocode}
%      \setlength\l_GAL_parshape_linewidth_dim
%                {\l_tmpb_dim-#5-(\l_GAL_parshape_next_tl)}
%      \setlength\l_GAL_parshape_lineindent_dim
%                {\l_tmpa_dim+\l_tmpb_dim-\l_GAL_parshape_linewidth_dim}
%    \end{macrocode}
%
%    If we setting up the first special line we record the indentation
%    used compared to a normal paragraph at this point. The
%    |\l_GAL_parshape_firstline_indent_dim| is not part of the galley structure
%    thus we store it locally.
%    \begin{macrocode}
    \int_compare:nNnT \l_GAL_parshape_linecount_int=\c_one
    {
      \dim_set:Nn \l_GAL_parshape_firstline_indent_dim{
        \l_GAL_parshape_lineindent_dim -\l_tmpa_dim
      }
    }
%    \end{macrocode}
%
%    \begin{macrocode}
    \tl_gput_right:Nx\g_GAL_ps_current_tl{
      \space #1\space\dim_use:N\l_GAL_parshape_linewidth_dim
    }
  }
%    \end{macrocode}
%
%    \begin{macrocode}
  \int_incr:N\l_GAL_parshape_linecount_int
  \tl_gput_left:Nx\g_GAL_ps_current_tl{
    \int_use:N\l_GAL_parshape_linecount_int
  }
  \tl_gput_right:Nx\g_GAL_ps_current_tl{
    \space\dim_use:N\l_tmpa_dim\space \dim_use:N\l_tmpb_dim
  }
%<*trace>
  \GAL_typeout:n{\space\space set~ ps = \g_GAL_ps_current_tl}%
%</trace>
%    \end{macrocode}
%
%    \begin{macrocode}
  \GAL_prepare_reassign:NN \g_GAL_ps_current_tl \g_GAL_ps_static_tl
}
%    \end{macrocode}
% \end{macro}
%
%
%    \begin{macrocode}
\int_new:N\l_GAL_parshape_linecount_int
\dim_new:N\l_GAL_parshape_lineindent_dim
\dim_new:N\l_GAL_parshape_linewidth_dim
%    \end{macrocode}
%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%  \subsection{Short-term mutators}
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%  All these functions only modify the DGPV, i.e., the one that gets
%  reset after use.
%
%
%  \subsubsection{Dimensions (skips and dimens)}
%
%
%  For setting galley parameters of type skip or dimen we provide
%  functions which take as their first argument an identifier
%  (typically a single character) that identifies the parameter to
%  change, e.g., `v' for vertical skip or `i' for indentation and as
%  second argument a dimension (for setting the parameter to this
%  value or adding this value or using the maximum of the old and the
%  new value, etc).\footnote{They currently work using skip registers
%  internally which means that it is up to the programmer to ensure
%  that a dimen parameter gets passed only dimen values without plus
%  or minus parts.}
%
%
%
% \begin{macro}{\GAL_set_DGPV_dimension:nn}
%    |\GAL_set_DGPV_dimension:nn| sets the parameter specified by the first
%    argument to the value given as the second argument.
%    \begin{macrocode}
\cs_new_nopar:Npn\GAL_set_DGPV_dimension:nn #1#2{%  #1=v/h #2=value
  \calc_skip_set:Nn\l_GAL_tmpb_skip{#2}
%<*trace>
  \GAL_typeout:n{\space\space set~ #1 = #2 = \skip_use:N\l_GAL_tmpb_skip}%
%</trace>
  \tl_gset:cx{g_GAL_#1_current_tl} {\skip_use:N\l_GAL_tmpb_skip}
  \GAL_prepare_reassign:n{#1}
}
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\GAL_add_DGPV_dimension:nn}
%
%    |\GAL_add_DGPV_dimension:nn| add to the parameter specified by the first
%    argument the value given as the second argument.
%    \begin{macrocode}
\cs_new_nopar:Npn \GAL_add_DGPV_dimension:nn #1#2{%  #1=v/h/... #2=value
  \skip_set:Nn\l_GAL_tmpb_skip{\use:c{g_GAL_#1_current_tl}}
%    \end{macrocode}
%    Since the value of -1sp is (at least for the v parameter) used as
%    a special flag we are a bit careful when adding so that we are
%    not off by -1sp: this is not visible but in certain situations
%    \TeX{} might be upset even by this tiny amount.\footnote{Really
%    necessary?}
%    \begin{macrocode}
  \dim_compare:nNnTF\l_GAL_tmpb_skip={-1sp}
  {  \calc_skip_set:Nn\l_GAL_tmpb_skip{#2} }
  {  \calc_skip_add:Nn\l_GAL_tmpb_skip{#2} }
%<*trace>
  \GAL_typeout:n{\space\space set~ #1 =+ #2 = \skip_use:N\l_GAL_tmpb_skip}
%</trace>
  \tl_gset:cx{g_GAL_#1_current_tl}{\skip_use:N\l_GAL_tmpb_skip}
  \GAL_prepare_reassign:n{#1}
}
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\GAL_max_DGPV_dimension:nn}
%    |\GAL_max_DGPV_dimension:nn| compares the current value of the
%    parameter specified by the first argument with the value given as
%    the second argument and stores the maximum of
%    them.\footnote{Current \LaTeX's \texttt{\textbackslash addvspace}
%    works quite differently and we may have to provide something else
%    here (or in addition)}
%    \begin{macrocode}
\cs_new_nopar:Npn\GAL_max_DGPV_dimension:nn #1#2{
  \skip_set:Nn\l_GAL_tmpa_skip{\tl_use:c{g_GAL_#1_current_tl}}
  \calc_skip_set:Nn\l_GAL_tmpb_skip{#2}
  \dim_compare:nNnT \l_GAL_tmpa_skip<\l_GAL_tmpb_skip
  {
    \tl_gset:cx{g_GAL_#1_current_tl}{\skip_use:N\l_GAL_tmpb_skip}
    \GAL_prepare_reassign:n{#1}
  }
%<*trace>
  \GAL_typeout:n{\space\space set~ #1 =
       max(\skip_use:N\l_GAL_tmpa_skip,\skip_use:N\l_GAL_tmpb_skip) ^^J\@spaces\@spaces
            = \tl_use:c{g_GAL_#1_current_tl}}
%</trace>
}
%    \end{macrocode}
% \end{macro}
%
%
%
% \subsubsection{Integers}
%
% From previous coding we still have things like |\GAL_set_penalty:n| ---
% i guess one could normalise this to an interface like
% |\setG@ALinteger| \ldots
%
% \begin{macro}{\GAL_set_penalty:n}
% we can either set the `penalty' object or add to it. To speed things
% up we use a mixture of calc and low-level \TeX{} conventions
%
%    \begin{macrocode}
\cs_new_nopar:Npn\GAL_set_penalty:n #1{%
  \calc_int_set:Nn\l_GAL_tmpa_int{#1}
  \tl_gset:Nn \g_GAL_p_current_tl \l_GAL_tmpa_int
%<*trace>
  \GAL_typeout:n{\space\space set~ p = #1 = \int_use:N\l_GAL_tmpa_int}
%</trace>
  \GAL_prepare_reassign:NN \g_GAL_p_current_tl \g_GAL_p_static_tl
}
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\GAL_add_penalty:n}
%
%    \begin{macrocode}
\cs_new_nopar:Npn\GAL_add_penalty:n #1{%
  \int_set:Nn\l_GAL_tmpa_int \g_GAL_p_current_tl
  \calc_int_add:Nn\l_GAL_tmpa_int{#1}
  \tl_gset:Nn \g_GAL_p_current_tl { \int_use:N\l_GAL_tmpa_int }
%<*trace>
  \GAL_typeout:n{\space\space set~ p += #1 = \int_use:N\l_GAL_tmpa_int}
%</trace>
  \GAL_prepare_reassign:NN \g_GAL_p_current_tl \g_GAL_p_static_tl
}
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\GAL_set_break:n}
%    The |\GAL_set_break:n| sets the switch that controls page breaking
%    \begin{macrocode}
\cs_new_nopar:Npn\GAL_set_break:n #1{%  values 0, 1, 2, or 3
%<*trace>
   \GAL_typeout:n{\space\space set~ b = #1 }
%</trace>
   \tl_gset:Nn \g_GAL_b_current_tl {#1}
   \GAL_prepare_reassign:NN \g_GAL_b_current_tl \g_GAL_b_static_tl
}
%    \end{macrocode}
% \end{macro}
%
%
%
%
% \subsubsection{Objects and thingies in general}
%
% \begin{macro}{\GAL_set_object:n}
%
% For the `o' object i've implemented only a `set' command so far
% (have to see what kind of usage this gets first)
%
%    \begin{macrocode}
\cs_new_nopar:Npn\GAL_set_object:n #1{
  \tl_gset:Nn \g_GAL_o_current_tl {#1}
  \GAL_prepare_reassign:NN \g_GAL_o_current_tl \g_GAL_o_static_tl
}
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\GAL_set_DGPV_thing:nn}
%    A generalised version of that is |\GAL_set_DGPV_thing:nn|.
%    \begin{macrocode}
\cs_new_nopar:Npn\GAL_set_DGPV_thing:nn #1 #2{
  \tl_gset:cn{g_GAL_#1_current_tl}{#2}
  \GAL_prepare_reassign:n{#1}
}
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\GAL_appendto_DGPV_thing:nn}
% \begin{macro}{\GAL_appendto_DGPV_thing:no}
%    And here is another one which appends code to the right of the
%    parameter:
%    \begin{macrocode}
\cs_new_nopar:Npn \GAL_appendto_DGPV_thing:nn #1#2{
  \tl_gput_right:cn{g_GAL_#1_current_tl}{#2}
  \GAL_prepare_reassign:n{#1}
}
\cs_generate_variant:Nn \GAL_appendto_DGPV_thing:nn {no}
%    \end{macrocode}
% \end{macro}
% \end{macro}
%
%
%
% \subsubsection{Paragraph shapes}
%
% \begin{macro}{\GAL_set_left_parshape:nnn}
% \begin{macro}{\GAL_set_right_parshape:nnn}
%    Setting a parshape on the left or the right for the next
%    paragraph, e.g., an initial. Not implemented so far is doing
%    something special on both sides.
%    \begin{macrocode}
\cs_new_nopar:Npn \GAL_set_left_parshape:nnn {
 \GAL_parshape_setup:nnnnnn {\dim_use:N\l_GAL_parshape_lineindent_dim}
 \@totalleftmargin
 \linewidth  }
\cs_new_nopar:Npn \GAL_set_right_parshape:nnn {
 \GAL_parshape_setup:nnnnnn \@totalleftmargin \@totalleftmargin \linewidth
}
%    \end{macrocode}
% \end{macro}
% \end{macro}
%
%
% \begin{macro}{\GALhangfrom:n}
%     And here a reimplementation of |\@hangfrom| but obeying
%    |\@totalleftmargin| indentation.
%    \begin{macrocode}
\cs_new_nopar:Npn \GALhangfrom:n #1 {
  \hbox_set:Nn \l_tmpa_box{{#1}}
  \GAL_parshape_setup:nnnnnn {\dim_use:N\l_GAL_parshape_lineindent_dim}
  {\@totalleftmargin+\box_wd:N\l_tmpa_box}
  {\linewidth-\box_wd:N\l_tmpa_box}
  \c_zero
  \c_zero_dim
  {-\box_wd:N\l_tmpa_box}
    \tex_noindent:D\box_use_clear:N\l_tmpa_box}
\let \@hangfrom \GALhangfrom:n
%    \end{macrocode}
% \end{macro}
%
%
%
%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%  \subsection{Long-term mutators}
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%  The following functions now modify the SGPV, i.e., modify the
%  values that are used as defaults unless overwritten for an
%  individual paragraph. Right now I don't see any purpose in providing
%  computation support at this level other than something like calc
%  expansion; so need one function per parameter type. Otherwise a
%  single function would be sufficient.
%
% \subsubsection{Objects and thingies in general}
%
% \begin{macro}{\GAL_set_SGPV_thing:nn}
%  So here is one that simply stores away the value in the right plist
%  under the right key. In addition we also directly update the key
%  command itself to avoid having to run something like
%  |\GAL@init@hmode| afterwards.
%    \begin{macrocode}
\cs_new_nopar:Npn\GAL_set_SGPV_thing:nn #1 #2 {
  \GAL_set_DGPV_thing:nn {#1} {#2}
  \tl_gset_eq:cc{g_GAL_#1_static_tl}{g_GAL_#1_current_tl}
}
%    \end{macrocode}
% \end{macro}
%
%
%  \subsubsection{Dimensions (skips and dimens)}
%
% \begin{macro}{\GAL_set_SGPV_dimension:nn}
%    The |\GAL_set_SGPV_dimension:nn| first sets the dynamic part of the
%    parameter (which is done using calc expansion) followed by
%    updating the static part of the parameter.
%    \begin{macrocode}
\cs_new_nopar:Npn\GAL_set_SGPV_dimension:nn #1 #2 {
  \GAL_set_DGPV_dimension:nn {#1} {#2}
  \tl_gset_eq:cc{g_GAL_#1_static_tl}{g_GAL_#1_current_tl}
}
%    \end{macrocode}
% \end{macro}
%
%
% \subsubsection{Paragraph shapes}
%
% \begin{macro}{\GAL_set_SGPV_measure:nn}
% Dealing with the parshape: the long term modification is essentially
% setting the measure and to support old \LaTeX{}  code also sets
% |\linewidth| and |\@totalleftmargin| (but see comments on this somewhere!)
%
%    \begin{macrocode}
\cs_new_nopar:Npn \GAL_set_SGPV_measure:nn #1 #2 {
  \setlength\@totalleftmargin{#1}
  \setlength\linewidth{#2}
  \tl_gset:Nx\g_GAL_ps_static_tl{\c_one\space
                 \dim_use:N\@totalleftmargin\space \dim_use:N\linewidth}
  \tl_gset_eq:NN\g_GAL_ps_current_tl\g_GAL_ps_static_tl
}
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\GAL_add_SGPV_measure:nn}
%    This is a variant modifies the measure (the name is
%    horrible) by adding to |\@totalleftmargin| and |\linewidth|. Note
%    that you normally need to subtract from |\linewidth| if
%    |\@totalleftmargin| is enlarged!
%    \begin{macrocode}
\cs_new_nopar:Npn \GAL_add_SGPV_measure:nn #1 #2 {
  \addtolength\@totalleftmargin{#1}
  \addtolength\linewidth{#2}
  \tl_gset:Nx\g_GAL_ps_static_tl{\c_one\space
    \dim_use:N\@totalleftmargin\space \dim_use:N\linewidth
  }
  \tl_gset_eq:NN\g_GAL_ps_current_tl\g_GAL_ps_static_tl
}
%    \end{macrocode}
% \end{macro}
%
%
%
% \subsubsection{Integers}
%
% No functions provided. For consistency reasons there probably should
% some in the end.
%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%  \subsection{Higher level commands}
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%
% \begin{macro}{\vspace}
%    The |*| of |\vspace| is parsed but not handled in this
%    implementation yet!
%    \begin{macrocode}
\DeclareDocumentCommand \vspace {s m }
 {
   \GAL_add_DGPV_dimension:nn{uv}{#2}
 }
%    \end{macrocode}
% \end{macro}
%
%
%
% \begin{macro}{\addvspace}
%    |\addvspace| is quite a bit different to the latex original, this
%    needs changing!
%    \begin{macrocode}
\cs_set:Npn\addvspace#1{
  \GAL_max_DGPV_dimension:nn{v}{#1}
}
%    \end{macrocode}
% \end{macro}
%
%
%
% \begin{macro}{\addpenalty}
%    \begin{macrocode}
\cs_set:Npn\addpenalty#1{
  \GAL_add_penalty:n{#1}
}
%    \end{macrocode}
% \end{macro}
%
%
%
%
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%  \subsection{Templates (first ideas)}
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Code in this section is essentially left over from previous
% versions. Most templates have been moved to different files already.
%
% The endlist template is rubbish and just for testing the concept
% itself! and not finished either!
%
%    \begin{macrocode}
\RequirePackage{xtemplate}
\RequirePackage{xparse}
%    \end{macrocode}
%
%    \begin{macrocode}
\DeclareObjectType{endlist}{0}

\tl_new:N  \g_GAL_p_current_tl
\tl_new:N \g_GAL_v_current_tl
\tl_new:N  \g_GAL_i_current_tl
\tl_new:N  \GAL@p@X
\tl_new:N \GAL@v@X
\tl_new:N  \GAL@i@X


\DeclareTemplateInterface{endlist}{std}{0}{
  penalty       : tokenlist  ,       % should be int
  vspace        : tokenlist  ,       % should be dim
  parindent     : tokenlist  ,       % should be dim
  par-penalty   : tokenlist = 0             ,
  par-vspace    : tokenlist = \c_zero_skip  ,
  par-parindent : tokenlist = \c_zero_dim   ,
 }

\DeclareTemplateCode{endlist}{std}{0}{
  penalty       = global \g_GAL_p_current_tl ,
  vspace        = global \g_GAL_v_current_tl ,
  parindent     = global \g_GAL_i_current_tl ,
  par-penalty   = global \GAL@p@X ,
  par-vspace    = global \GAL@v@X ,
  par-parindent = global \GAL@i@X ,
 }
 {\AssignTemplateKeys
  \GAL_set_endlist_par:}

\DeclareInstance{endlist}{list}{std}{
  penalty     = 999 ,
  vspace      = 10pt ,
  parindent   = 0pt ,
  par-penalty     = -1000 ,
  par-vspace      = 5pt ,
  par-parindent   = 10pt ,
 }
%    \end{macrocode}
%
%
%
%
% \subsection{Initialisation}
%
%    \begin{macrocode}
\GAL_init_static:  % this is to be after the templates by now
\l_GAL_real_everypar_toks{\GAL_use_on_paragraph:\toks_use:N\everypar}

%    \end{macrocode}
%
% We need to initialize again at start of document i fear to ensure
% that stuff like the hyphenation is set up properly (this needs some
% further thoughts!)
%    \begin{macrocode}
\AtBeginDocument {
  \GAL_init_static:  % this is to be after the templates by now
}
%    \end{macrocode}
%
% \section{Updated code from \texttt{latex.ltx}}
%
% There are a bunch of additional code lines which are originally from
% \texttt{latex.ltx} and have been updated (in part) to use the new
% mechanism. This isn't really worth printing as most of that is not
% fully done or obsolete by redefinition of, say, code for lists,
% etc. But one might want to have a look at it at some stage. For this
% reason the code contains an |\end{document}| at this point. which
% you may or may not want to remove.
%
% \PrintIndex
%
% \end{document}
%
%    \begin{macrocode}
\def\@@line#1{\GAL_use_on_vobject:\hb@xt@\hsize{#1}\nobreak}

\long\def \@savemarbox #1#2{%
  \global\setbox #1%
    \color@vbox
      \vtop{%
        \hsize\marginparwidth
        \@parboxrestore
        \@marginparreset
        #2%
        \par                       % needed nowadays!
        \@minipagefalse
        \outer@nobreak
        }%
    \color@endbox
}

\long\def\@footnotetext#1{\insert\footins{%
    \reset@font\footnotesize
    \interlinepenalty\interfootnotelinepenalty
    \splittopskip\footnotesep
    \splitmaxdepth \dp\strutbox \floatingpenalty \@MM
    \hsize\columnwidth \@parboxrestore
    \protected@edef\@currentlabel{%
       \csname p@footnote\endcsname\@thefnmark
    }%
    \color@begingroup
      \@makefntext{%
        \rule\z@\footnotesep\ignorespaces#1\@finalstrut\strutbox\par}%  %ditto!!!
    \color@endgroup}}%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% all latex.ltx commands that involved the @nobreak flag
%
% most of them have been modified to use the new structure but not all
% and not all correctly (see comments within the code

%<*trace>
\def\showGALcmd#1{\GAL_typeout:n{In~#1: \int_use:N\l_GAL_level_int~ \on@line}}
%</trace>

\def\@afterheading{
%<*trace>
  \showGALcmd{@afterheading}
%</trace>
  \if@afterindent \else
    \GAL_set_DGPV_thing:nn i \c_one
  \fi
  \GAL_set_break:n 2
}

\def\nofiles{%
%<*trace>
  \showGALcmd{}
%</trace>
  \@fileswfalse
  \typeout{No auxiliary output files.^^J}%
  \long\def\protected@write##1##2##3%
    {\write\m@ne{}%
%
% i think that the following code can simply vanish since if we are in
% vmode and the \PARM{break flag} is set then the GAL mechanism will
% automatically add a penalty 10000 at the right point; correct?
%
%\if@nobreak\ifvmode\nobreak\fi\fi}%
  }
  \let\makeindex\relax
  \let\makeglossary\relax}

\long\def \protected@write#1#2#3{%
%<*trace>
  \showGALcmd{protected@write}
%</trace>
      \group_begin:
       \let\thepage\relax
       #2%
       \let\protect\@unexpandable@protect
       \edef\reserved@a{\write#1{#3}}%
       \GAL_appendto_DGPV_thing:no {nw} \reserved@a
      \group_end:
%
% see above
%
%      \if@nobreak\ifvmode\nobreak\fi\fi
}

\def\markboth#1#2{\gdef\@themark{{#1}{#2}}{%
%<*trace>
  \showGALcmd{}
%</trace>
     \let\protect\@unexpandable@protect
     \let\label\relax \let\index\relax \let\glossary\relax
     \mark{\@themark}}%
%
%\if@nobreak\ifvmode\nobreak\fi\fi
}

\def\markright#1{{\let\protect\@unexpandable@protect
%<*trace>
  \showGALcmd{}
%</trace>
     \let\label\relax \let\index\relax \let\glossary\relax
     \expandafter\@markright\@themark
     {#1}\mark{\@themark}}%
%
%\if@nobreak\ifvmode\nobreak\fi\fi
}

\def \newpage {%
%<*trace>
  \showGALcmd{newpage}
%</trace>
  \if@noskipsec
    \ifx \@nodocument\relax
      \leavevmode
      \global \@noskipsecfalse
    \fi
  \fi
  \if@inlabel
    \leavevmode
    \global \@inlabelfalse
  \fi
%
% newpage is supposed to stop any \PARM{nobreak flag}, so the right
% approach is probably something like
%
  \ifnum \g_GAL_b_current_tl > \c_zero
     \GAL_set_break:n 0
  \fi
%
%  \if@nobreak \@nobreakfalse \everypar{}\fi
%
  \par
  \vfil
  \penalty -\c_ten_thousand}
%
%
% the |\@arrayparboxrestore| nothing else than initialising a new
% galley level (in the old \LaTeX) so most of what is there needs
% either to vanish or to get integrated into the startup code of a new
% galley (not done yet)
%
\def\@arrayparboxrestore{%
%<*trace>
  \showGALcmd{@arrayparboxrestore}
%</trace>
%
% again nothing to do (i think): if used as part of a minipage or
% parbox we are at a new level, otherwise we are probably not supposed
% to change that value
%
%  \let\if@nobreak\iffalse
  \let\if@noskipsec\iffalse
  \let\par\@@par
  \let\-\@dischyph
  \let\'\@acci\let\`\@accii\let\=\@acciii
  \parindent\z@ \parskip\z@skip
  \everypar{}%
  \linewidth\hsize
  \@totalleftmargin\z@
  \leftskip\z@skip \rightskip\z@skip \@rightskip\z@skip
  \parfillskip\@flushglue \lineskip\normallineskip
  \baselineskip\normalbaselineskip
  \sloppy}

\def\@startsection#1#2#3#4#5#6{%
%<*trace>
  \showGALcmd{@startsection}
%</trace>
  \if@noskipsec \leavevmode \fi
  \par
  \l_tmpa_skip #4\relax
  \@afterindenttrue
  \ifdim \l_tmpa_skip <\z@
    \l_tmpa_skip -\l_tmpa_skip \@afterindentfalse
  \fi
%
% the section case is interesting since the @nobreak flag is used for
% two things: a) to suppress a penalty if heading follow each other
% and be to suppress a skip in this case. This works because in latex
% the @nobreak switch is only set in the heading context (so is
% actually something like ``heading just seen flag''
%
% not sure how to model something like this in general, for the moment
% i look at the \PARM{nobreak flag} but this is not correct!
%
%  \if@nobreak
%    \everypar{}%
%  \else
%    \addpenalty\@secpenalty\addvspace\l_tmpa_skip
%  \fi
  \ifnum \g_GAL_b_current_tl = \c_zero
     \addpenalty\@secpenalty\addvspace\l_tmpa_skip
  \fi
  \@ifstar
    {\@ssect{#3}{#4}{#5}{#6}}%
    {\@dblarg{\@sect{#1}{#2}{#3}{#4}{#5}{#6}}}}

\def\@xsect#1{%
%<*trace>
  \showGALcmd{@xsect}
%</trace>
  \l_tmpa_skip #1\relax
  \ifdim \l_tmpa_skip>\z@
    \par \nobreak
    \vskip \l_tmpa_skip
    \@afterheading
  \else
    \global\@noskipsectrue
%    \@nobreakfalse
%    \everypar{%
%      \if@noskipsec
%        \global\@noskipsecfalse
%       {\setbox\z@\lastbox}%
%        \clubpenalty\c_ten_thousand
%        \group_begin: \@svsechd \group_end:
%        \unskip
%        \l_tmpa_skip #1\relax
%        \hskip -\l_tmpa_skip
%      \else
%        \clubpenalty \@clubpenalty
%        \everypar{}%
%      \fi}%
    \GAL_set_DGPV_thing:nn i \c_one
    \GAL_set_break:n 2
    \GAL_set_object:n { \group_begin: \@svsechd \group_end:
                       \unskip }
% obey stupid latex startsection interface with negative numbers ...
% setting this dimension is actually ignored at the moment as the value is
% not  used anywhere\FIX

    \skip_set:Nn\l_tmpa_skip {#1}
    \GAL_set_DGPV_dimension:nn h {-\l_tmpa_skip}
%
% the noskipsec flag is probably needed in interaction with lists as
% long as this is only a partial conversion so i do set it (maybe not)
%
    \everypar{%
      \if@noskipsec
        \global\@noskipsecfalse
      \else
        \everypar{}%
      \fi}%
  \fi
  \ignorespaces}

\gdef\@specialoutput{%
%<*trace>
  \showGALcmd{@specialoutput}
%</trace>
   \ifnum \outputpenalty>-\c_ten_thousand_two
     \@doclearpage
   \else
     \GAL_ignore_next_galley:
     \ifnum \outputpenalty<-\c_ten_thousand_three
       \ifnum \outputpenalty<-\@MM \deadcycles \z@ \fi
       \global \setbox\@holdpg \vbox {\unvbox\@cclv}%
     \else
       \global \setbox\@holdpg \vbox{%
                      \unvbox\@holdpg
                      \unvbox\@cclv
                      \setbox\@tempboxa \lastbox
                      \unskip
                                     }%
       \@pagedp \dp\@holdpg
       \@pageht \ht\@holdpg
       \unvbox \@holdpg
       \@next\@currbox\@currlist{%
         \ifnum \count\@currbox>\z@
           \advance \@pageht \@pagedp
           \ifvoid\footins \else
             \advance \@pageht \ht\footins
             \advance \@pageht \skip\footins
             \advance \@pageht \dp\footins
           \fi
           \ifvbox \@kludgeins
             \ifdim \wd\@kludgeins=\z@
               \advance \@pageht \ht\@kludgeins
             \fi
           \fi
           \@reinserts
           \@addtocurcol
         \else
           \@reinserts
           \@addmarginpar
         \fi
         }\@latexbug
%
% with the same argument as before we can always add the penalty, right?
%
       \ifnum \outputpenalty<\z@
%         \if@nobreak
%           \nobreak
%         \else
           \addpenalty \interlinepenalty
%         \fi
       \fi
     \fi
   \fi
}

\def \@addtocurcol {%
%<*trace>
  \showGALcmd{@addtocurcol}
%</trace>
   \@insertfalse
   \@setfloattypecounts
   \ifnum \@fpstype=8
   \else
     \ifnum \@fpstype=24
     \else
       \@flsettextmin
       \advance \@textmin \@textfloatsheight
       \@reqcolroom \@pageht
       \ifdim \@textmin>\@reqcolroom
         \@reqcolroom \@textmin
       \fi
       \advance \@reqcolroom \ht\@currbox
       \ifdim \@colroom>\@reqcolroom
         \@flsetnum \@colnum
         \ifnum \@colnum>\z@
           \@bitor\@currtype\@deferlist
           \if@test
           \else
             \@bitor\@currtype\@botlist
             \if@test
               \@addtobot
             \else
               \ifodd \count\@currbox
                 \advance \@reqcolroom \intextsep
                 \ifdim \@colroom>\@reqcolroom
                   \global \advance \@colnum \m@ne
                   \global \advance \@textfloatsheight \ht\@currbox
                   \global \advance \@textfloatsheight 2\intextsep
                   \@cons \@midlist \@currbox
%
% same argument as before (perhaps incorrect here?)
%
%                   \if@nobreak
%                     \nobreak
%                     \@nobreakfalse
%                     \everypar{}%
%                   \else
                     \addpenalty \interlinepenalty
%                   \fi
%
% at least it seems to me that we should not use \vskip here
%
%
% however we should then also have a way to trigger the use of the
% GAL structure without actually starting hmode (note done so all
% this is incorrect)
%
                   \vskip \intextsep
                   \box\@currbox
%
% and neither here ...
%
                   \penalty\interlinepenalty
                   \vskip\intextsep
                   \ifnum\outputpenalty <-\c_ten_thousand_two \vskip -\parskip\fi
                   \outputpenalty \z@
                   \@inserttrue
                 \fi
               \fi
               \if@insert
               \else
                 \@addtotoporbot
               \fi
             \fi
           \fi
         \fi
       \fi
     \fi
   \fi
   \if@insert
   \else
     \@resethfps
     \@cons\@deferlist\@currbox
   \fi
}

% and the whole item stuff is too complicated for me to really think
% about it tonight ...

\def\@item[#1]{%
%<*trace>
  \showGALcmd{@item}
%</trace>
  \if@noparitem
    \@donoparitem
  \else
    \if@inlabel
      \indent \par
    \fi
    \ifhmode
      \unskip\unskip \par
    \fi
    \if@newlist
      \if@nobreak
        \@nbitem
      \else
        \addpenalty\@beginparpenalty
        \addvspace\@topsep
        \addvspace{-\parskip}%
      \fi
    \else
      \addpenalty\@itempenalty
      \addvspace\itemsep
    \fi
    \global\@inlabeltrue
  \fi
  \everypar{%
    \@minipagefalse
    \global\@newlistfalse
    \if@inlabel
      \global\@inlabelfalse
      {\setbox\z@\lastbox
       \ifvoid\z@
         \kern-\itemindent
       \fi}%
      \box\@labels
      \penalty\z@
    \fi
    \if@nobreak
      \@nobreakfalse
      \clubpenalty \c_ten_thousand
    \else
      \clubpenalty \@clubpenalty
      \everypar{}%
    \fi}%
  \if@noitemarg
    \@noitemargfalse
    \if@nmbrlist
      \refstepcounter\@listctr
    \fi
  \fi
  \sbox\@tempboxa{\makelabel{#1}}%
  \global\setbox\@labels\hbox{%
    \unhbox\@labels
    \hskip \itemindent
    \hskip -\labelwidth
    \hskip -\labelsep
    \ifdim \wd\@tempboxa >\labelwidth
      \box\@tempboxa
    \else
      \hbox to\labelwidth {\unhbox\@tempboxa}%
    \fi
    \hskip \labelsep}%
  \ignorespaces}


%    \end{macrocode}
%
%
%    \section{Fixing non-galley vboxes}
%
%    \begin{macrocode}
\DeclareRobustCommand{\LaTeX}{L\kern-.36em%
        {\sbox\z@ T%
         \GAL_ignore_next_galley_vbox: to\ht\z@{\hbox{\check@mathfonts
                              \fontsize\sf@size\z@
                              \math@fontsfalse\selectfont
                              A}%
                        \vss}%
        }%
        \kern-.15em%
        \TeX}
\DeclareTextCommandDefault{\textunderscore}{%
  \leavevmode \kern.06em\GAL_ignore_next_galley_vbox:{\hrule\@width.3em}}
\DeclareTextCommandDefault{\textvisiblespace}{%
   \mbox{\kern.06em\vrule \@height.3ex}%
   \GAL_ignore_next_galley_vbox:{\hrule \@width.3em}%
   \hbox{\vrule \@height.3ex}}
\gdef\showhyphens#1{%
  \setbox0\vbox{%
    \color@begingroup
    \everypar{}%
    \parfillskip\z@skip\hsize\maxdimen
    \normalfont
    \pretolerance\m@ne\tolerance\m@ne\hbadness\z@\showboxdepth\z@\ #1%
    \color@endgroup}}
\long\def\@imakepicbox(#1,#2)[#3]#4{%
  \GAL_ignore_next_galley_vbox: to#2\unitlength
   {\let\mb@b\vss \let\mb@l\hss\let\mb@r\hss
    \let\mb@t\vss
    \tl_map_variable:nNn {#3}\reserved@a{%
      \if s\reserved@a
        \let\mb@l\relax\let\mb@r\relax
      \else
        \expandafter\let\csname mb@\reserved@a\endcsname\relax
      \fi}%
    \mb@t
    \hb@xt@ #1\unitlength{\mb@l #4\mb@r}%
    \mb@b
    \kern\z@}}

\long\def\frame#1{%
  \leavevmode
  \hbox{%
    \hskip-\@wholewidth
    \GAL_ignore_next_galley_vbox:{%
      \vskip-\@wholewidth
      \hrule \@height\@wholewidth
      \hbox{%
        \vrule\@width\@wholewidth
        #1%
        \vrule\@width\@wholewidth}%
      \hrule\@height\@wholewidth
      \vskip-\@wholewidth}%
    \hskip-\@wholewidth}}
\def\@frameb@x#1{%
  \l_tmpa_dim\fboxrule
  \advance\l_tmpa_dim\fboxsep
  \advance\l_tmpa_dim\dp\@tempboxa
  \hbox{%
    \lower\l_tmpa_dim\hbox{%
      \GAL_ignore_next_galley_vbox:{%
        \hrule\@height\fboxrule
        \hbox{%
          \vrule\@width\fboxrule
          #1%
          \GAL_ignore_next_galley_vbox:{%
            \vskip\fboxsep
            \box\@tempboxa
            \vskip\fboxsep}%
          #1%
          \vrule\@width\fboxrule}%
        \hrule\@height\fboxrule}%
                          }%
        }%
}
\typeout{****~ Careful:~ there~ is~ another~ rewrite~ for~ iiiparbox~ in~ coffins!}

\long\def\@iiiparbox#1#2[#3]#4#5{%
  \leavevmode
  \@pboxswfalse
  \setlength\l_tmpa_dim{#4}%
  \@begin@tempboxa\vbox{\hsize\l_tmpa_dim\@parboxrestore#5\@@par}%
    \ifx\relax#2\else
      \setlength\l_tmpb_dim{#2}%
      \edef\@parboxto{to\dim_use:N\l_tmpb_dim}%
    \fi
    \GAL_ignore_next_galley:
    \if#1b\vbox
    \else\if #1t\vtop
    \else\ifmmode\vcenter
    \else\@pboxswtrue $\vcenter
    \fi\fi\fi
    \@parboxto{\let\hss\vss\let\unhbox\unvbox
       \csname bm@#3\endcsname}%
    \if@pboxsw \m@th$\fi
  \@end@tempboxa}
\def\@iiiminipage#1#2[#3]#4{%
  \leavevmode
  \@pboxswfalse
  \setlength\l_tmpa_dim{#4}%
  \def\@mpargs{{#1}{#2}[#3]{#4}}%
  \setbox\@tempboxa\vbox\bgroup
    \color@begingroup
      \hsize\l_tmpa_dim
      \textwidth\hsize \columnwidth\hsize
      \@parboxrestore
      \def\@mpfn{mpfootnote}\def\thempfn{\thempfootnote}\c@mpfootnote\z@
      \let\@footnotetext\@mpfootnotetext
      \let\@listdepth\@mplistdepth \@mplistdepth\z@
      \@minipagerestore
      \@setminipage}
\long\def\@mpfootnotetext#1{%
  \global\setbox\@mpfootins\vbox{%
    \unvbox\@mpfootins
    \reset@font\footnotesize
    \hsize\columnwidth
    \@parboxrestore
    \protected@edef\@currentlabel
         {\csname p@mpfootnote\endcsname\@thefnmark}%
    \color@begingroup
      \@makefntext{%
        \rule\z@\footnotesep\ignorespaces#1\@finalstrut\strutbox}%
    \color@endgroup}}
\def\@array[#1]#2{%
  \GAL_ignore_next_galley:
  \if #1t\vtop \else \if#1b\vbox \else \vcenter \fi\fi
  \bgroup
  \setbox\@arstrutbox\hbox{%
    \vrule \@height\arraystretch\ht\strutbox
           \@depth\arraystretch \dp\strutbox
           \@width\z@}%
  \@mkpream{#2}%
  \edef\@preamble{%
    \ialign \noexpand\@halignto
      \bgroup \@arstrut \@preamble \tabskip\z@skip \cr}%
  \let\@startpbox\@@startpbox \let\@endpbox\@@endpbox
  \let\tabularnewline\\%
%
% we can't allow uncontrolled changes of \par
%
%%%%    \let\par\@empty
    \let\@sharp##%
    \set@typeset@protect
    \lineskip\z@skip\baselineskip\z@skip
    \ifhmode \@preamerr\z@ \@@par\fi
    \@preamble}
\gdef\@shortstack[#1]{%
  \leavevmode
  \GAL_ignore_next_galley_vbox:\bgroup
    \baselineskip-\p@\lineskip 3\p@
    \let\mb@l\hss\let\mb@r\hss
    \expandafter\let\csname mb@#1\endcsname\relax
    \let\\\@stackcr
    \@ishortstack}
\gdef\@ishortstack#1{\ialign{\mb@l {##}\unskip\mb@r\cr #1\crcr}\egroup}
\gdef\@stackcr{\@ifstar\@ixstackcr\@ixstackcr}
\gdef\@ixstackcr{\@ifnextchar[\@istackcr{\cr\ignorespaces}}
\gdef\@istackcr[#1]{\cr\noalign{\vskip #1}\ignorespaces}
\newif\if@negarg
\gdef\line(#1,#2)#3{\@xarg #1\relax \@yarg #2\relax
  \@linelen #3\unitlength
  \ifdim\@linelen<\z@\@badlinearg\else
    \ifnum\@xarg =\z@ \@vline
      \else \ifnum\@yarg =\z@ \@hline \else \@sline\fi
    \fi
  \fi}
\gdef\@sline{%
  \ifnum\@xarg<\z@ \@negargtrue \@xarg -\@xarg \@yyarg -\@yarg
  \else \@negargfalse \@yyarg \@yarg \fi
\ifnum \@yyarg >\z@ \@tempcnta\@yyarg \else \@tempcnta -\@yyarg \fi
\ifnum\@tempcnta>6 \@badlinearg\@tempcnta\z@ \fi
\ifnum\@xarg>6 \@badlinearg\@xarg \@ne \fi
\setbox\@linechar\hbox{\@linefnt\@getlinechar(\@xarg,\@yyarg)}%
\ifnum \@yarg >\z@ \let\@upordown\raise \@clnht\z@
   \else\let\@upordown\lower \@clnht \ht\@linechar\fi
\@clnwd \wd\@linechar
\if@negarg
  \hskip -\wd\@linechar \def\reserved@a{\hskip -2\wd\@linechar}%
\else
     \let\reserved@a\relax
\fi
\@whiledim \@clnwd <\@linelen \do
  {\@upordown\@clnht\copy\@linechar
   \reserved@a
   \advance\@clnht \ht\@linechar
   \advance\@clnwd \wd\@linechar}%
\advance\@clnht -\ht\@linechar
\advance\@clnwd -\wd\@linechar
\l_tmpa_dim\@linelen\advance\l_tmpa_dim -\@clnwd
\l_tmpb_dim\l_tmpa_dim\advance\l_tmpb_dim -\wd\@linechar
\if@negarg \hskip -\l_tmpb_dim \else \hskip \l_tmpb_dim \fi
\multiply\l_tmpa_dim \@m
\@tempcnta \l_tmpa_dim
\l_tmpa_dim \wd\@linechar \divide\@tempcnta \l_tmpa_dim
\l_tmpa_dim \ht\@linechar \multiply\l_tmpa_dim \@tempcnta
\divide\l_tmpa_dim \@m
\advance\@clnht \l_tmpa_dim
\ifdim \@linelen <\wd\@linechar
   \hskip \wd\@linechar
   \@picture@warn
   \else\@upordown\@clnht\copy\@linechar\fi}
\gdef\@hline{\ifnum \@xarg <\z@ \hskip -\@linelen \fi
\vrule \@height \@halfwidth \@depth \@halfwidth \@width \@linelen
\ifnum \@xarg <\z@ \hskip -\@linelen \fi}
\gdef\@getlinechar(#1,#2){\@tempcnta#1\relax\multiply\@tempcnta 8%
  \advance\@tempcnta -9\ifnum #2>\z@ \advance\@tempcnta #2\relax\else
  \advance\@tempcnta -#2\relax\advance\@tempcnta 64 \fi
  \char\@tempcnta}
\gdef\vector(#1,#2)#3{\@xarg #1\relax \@yarg #2\relax
  \@tempcnta \ifnum\@xarg<\z@ -\@xarg\else\@xarg\fi
  \ifnum\@tempcnta<5\relax
  \@linelen #3\unitlength
  \ifdim\@linelen<\z@\@badlinearg\else
    \ifnum\@xarg =\z@ \@vvector
      \else \ifnum\@yarg =\z@ \@hvector \else \@svector\fi
    \fi
  \fi
  \else\@badlinearg\fi}
\gdef\@hvector{\@hline\hb@xt@\z@{\@linefnt
 \ifnum \@xarg <\z@ \@getlarrow(1,0)\hss\else
    \hss\@getrarrow(1,0)\fi}}
\gdef\@vvector{\ifnum \@yarg <\z@ \@downvector \else \@upvector \fi}
\gdef\@svector{\@sline
  \@tempcnta\@yarg \ifnum\@tempcnta <\z@ \@tempcnta -\@tempcnta\fi
  \ifnum\@tempcnta <5%
    \hskip -\wd\@linechar
    \@upordown\@clnht \hbox{\@linefnt  \if@negarg
    \@getlarrow(\@xarg,\@yyarg)\else \@getrarrow(\@xarg,\@yyarg)\fi}%
  \else\@badlinearg\fi}
\gdef\@getlarrow(#1,#2){\ifnum #2=\z@ \@tempcnta'33 \else
  \@tempcnta #1\relax\multiply\@tempcnta \sixt@@n \advance\@tempcnta
  -9 \@tempcntb #2\relax\multiply\@tempcntb \tw@
  \ifnum \@tempcntb >\z@ \advance\@tempcnta \@tempcntb
  \else\advance\@tempcnta -\@tempcntb\advance\@tempcnta 64
  \fi\fi\char\@tempcnta}
\gdef\@getrarrow(#1,#2){\@tempcntb #2\relax
\ifnum\@tempcntb <\z@ \@tempcntb -\@tempcntb\relax\fi
\ifcase \@tempcntb\relax \@tempcnta'55 \or
\ifnum #1<\c_three \@tempcnta #1\relax\multiply\@tempcnta
24\advance\@tempcnta -6 \else \ifnum #1=\c_three \@tempcnta 49
\else\@tempcnta 58 \fi\fi\or
\ifnum #1<\c_three \@tempcnta=#1\relax\multiply\@tempcnta
24\advance\@tempcnta -\c_three \else \@tempcnta 51 \fi\or
\@tempcnta #1\relax\multiply\@tempcnta
\sixt@@n \advance\@tempcnta -\tw@ \else
\@tempcnta #1\relax\multiply\@tempcnta
\sixt@@n \advance\@tempcnta 7 \fi\ifnum #2<\z@ \advance\@tempcnta 64 \fi
\char\@tempcnta}
\gdef\@vline{\ifnum \@yarg <\z@ \@downline \else \@upline\fi}
\gdef\@upline{%
  \hb@xt@\z@{\hskip -\@halfwidth \vrule \@width \@wholewidth
   \@height \@linelen \@depth \z@\hss}}
\gdef\@downline{%
  \hb@xt@\z@{\hskip -\@halfwidth \vrule \@width \@wholewidth
   \@height \z@ \@depth \@linelen \hss}}
\gdef\@upvector{\@upline\setbox\@tempboxa\hbox{\@linefnt\char'66}\raise
     \@linelen \hb@xt@\z@{\lower \ht\@tempboxa\box\@tempboxa\hss}}
\gdef\@downvector{\@downline\lower \@linelen
      \hb@xt@\z@{\@linefnt\char'77\hss}}
\gdef\dashbox#1(#2,#3){\leavevmode\hb@xt@\z@{\baselineskip \z@skip
\lineskip \z@skip
\@dashdim #2\unitlength
\@dashcnt \@dashdim \advance\@dashcnt 200
\@dashdim #1\unitlength\divide\@dashcnt \@dashdim
\ifodd\@dashcnt\@dashdim \z@
\advance\@dashcnt \@ne \divide\@dashcnt \tw@
\else \divide\@dashdim \tw@ \divide\@dashcnt \tw@
\advance\@dashcnt \m@ne
\setbox\@dashbox \hbox{\vrule \@height \@halfwidth \@depth \@halfwidth
\@width \@dashdim}\put(0,0){\copy\@dashbox}%
\put(0,#3){\copy\@dashbox}%
\put(#2,0){\hskip-\@dashdim\copy\@dashbox}%
\put(#2,#3){\hskip-\@dashdim\box\@dashbox}%
\multiply\@dashdim \c_three
\fi
\setbox\@dashbox \hbox{\vrule \@height \@halfwidth \@depth \@halfwidth
\@width #1\unitlength\hskip #1\unitlength}\@tempcnta\z@
\put(0,0){\hskip\@dashdim \@whilenum \@tempcnta <\@dashcnt
\do{\copy\@dashbox\advance\@tempcnta \@ne }}\@tempcnta\z@
\put(0,#3){\hskip\@dashdim \@whilenum \@tempcnta <\@dashcnt
\do{\copy\@dashbox\advance\@tempcnta \@ne }}%
\@dashdim #3\unitlength
\@dashcnt \@dashdim \advance\@dashcnt 200
\@dashdim #1\unitlength\divide\@dashcnt \@dashdim
\ifodd\@dashcnt \@dashdim \z@
\advance\@dashcnt \@ne \divide\@dashcnt \tw@
\else
\divide\@dashdim \tw@ \divide\@dashcnt \tw@
\advance\@dashcnt \m@ne
\setbox\@dashbox\hbox{\hskip -\@halfwidth
\vrule \@width \@wholewidth
\@height \@dashdim}\put(0,0){\copy\@dashbox}%
\put(#2,0){\copy\@dashbox}%
\put(0,#3){\lower\@dashdim\copy\@dashbox}%
\put(#2,#3){\lower\@dashdim\copy\@dashbox}%
\multiply\@dashdim \c_three
\fi
\setbox\@dashbox\hbox{\vrule \@width \@wholewidth
\@height #1\unitlength}\@tempcnta\z@
\put(0,0){\hskip -\@halfwidth \GAL_ignore_next_galley_vbox:{\@whilenum \@tempcnta <\@dashcnt
\do{\vskip #1\unitlength\copy\@dashbox\advance\@tempcnta \@ne }%
\vskip\@dashdim}}\@tempcnta\z@
\put(#2,0){\hskip -\@halfwidth \GAL_ignore_next_galley_vbox:{\@whilenum \@tempcnta<\@dashcnt
\do{\vskip #1\unitlength\copy\@dashbox\advance\@tempcnta \@ne }%
\vskip\@dashdim}}}\@makepicbox(#2,#3)}
\gdef\@ovvert#1#2{\GAL_ignore_next_galley_vbox: to\@ovyy{%
    \if@ovb \@tempcntb \@tempcnta \advance \@tempcntb #1\relax
      \kern -\@ovro \hbox{\char \@tempcntb}\nointerlineskip
    \else \kern \@ovri \kern \@ovdy \fi
    \leaders\vrule \@width \@wholewidth\vfil \nointerlineskip
    \if@ovt \@tempcntb \@tempcnta \advance \@tempcntb #2\relax
      \hbox{\char \@tempcntb}%
    \else \kern \@ovdy \kern \@ovro \fi}}
\def\@xfloat #1[#2]{%
  \@nodocument
  \def \@captype {#1}%
   \def \@fps {#2}%
   \@onelevel@sanitize \@fps
   \def \reserved@b {!}%
   \ifx \reserved@b \@fps
     \@fpsadddefault
   \else
     \ifx \@fps \@empty
       \@fpsadddefault
     \fi
   \fi
   \ifhmode
     \@bsphack
     \@floatpenalty -\c_ten_thousand_two
   \else
     \@floatpenalty-\c_ten_thousand_three
   \fi
  \ifinner
     \@parmoderr\@floatpenalty\z@
  \else
    \@next\@currbox\@freelist
      {%
       \@tempcnta \sixt@@n
       \tl_map_variable:NNn \@fps\reserved@a
          {%
           \if \reserved@a h%
             \ifodd \@tempcnta
             \else
               \advance \@tempcnta \@ne
             \fi
           \fi
           \if \reserved@a t%
             \@setfpsbit \tw@
           \fi
           \if \reserved@a b%
             \@setfpsbit 4%
           \fi
           \if \reserved@a p%
             \@setfpsbit 8%
           \fi
           \if \reserved@a !%
             \ifnum \@tempcnta>15
               \advance\@tempcnta -\sixt@@n\relax
             \fi
           \fi
           }%
       \@tempcntb \csname ftype@\@captype \endcsname
       \multiply \@tempcntb \@xxxii
       \advance \@tempcnta \@tempcntb
       \global \count\@currbox \@tempcnta
       }%
    \@fltovf
  \fi
  \global \setbox\@currbox
    \color@vbox
      \normalcolor
      \vbox \bgroup
        \hsize\columnwidth
        \@parboxrestore
        \@floatboxreset
}
\def\end@float{%
  \@endfloatbox
  \ifnum\@floatpenalty <\z@
    \@largefloatcheck
    \@cons\@currlist\@currbox
    \ifnum\@floatpenalty <-\c_ten_thousand_two
      \penalty -\@Miv
      \l_tmpa_dim\prevdepth
      \GAL_ignore_next_galley_vbox:{}%
      \prevdepth\l_tmpa_dim
      \penalty\@floatpenalty
    \else
      \vadjust{\penalty -\@Miv \GAL_ignore_next_galley_vbox:{}\penalty\@floatpenalty}\@Esphack
    \fi
  \fi
}
\def \@xympar{%
  \ifnum\@floatpenalty <\z@\@cons\@currlist\@marbox\fi
  \setbox\@tempboxa
    \color@vbox
      \vbox \bgroup
  \end@float
  \@ignorefalse
  \@esphack
}
\def \AtBeginDvi #1{%
  \global \setbox \@begindvibox
    \vbox{\unvbox \@begindvibox #1}%
}
\def\clearpage{%
  \ifvmode
    \ifnum \@dbltopnum =\m@ne
      \ifdim \pagetotal <\topskip
        \hbox{}%
      \fi
    \fi
  \fi
  \newpage
  \write\m@ne{}%
  \GAL_ignore_next_galley_vbox:{}%
  \penalty -\@Mi
}
\def \@emptycol {\GAL_ignore_next_galley_vbox:{}\penalty -\c_ten_thousand}
\long\def \@topnewpage [#1]{%
  \@nodocument
  \@next\@currbox\@freelist{}{}%
  \global \setbox\@currbox
    \color@vbox
      \normalcolor
      \vbox {%
        \hsize\textwidth
        \@parboxrestore
        \col@number \@ne
        #1%
        \vskip -\dbltextfloatsep
             }%
    \color@endbox
  \ifdim \ht\@currbox>\textheight
    \ht\@currbox \textheight
  \fi
  \global \count\@currbox \tw@
  \l_tmpa_dim -\ht\@currbox
  \advance \l_tmpa_dim -\dbltextfloatsep
  \global \advance \@colht \l_tmpa_dim
  \ifx \@dbltoplist \@empty
  \else
    \@latexerr{Float(s) lost}\@ehb
    \let \@dbltoplist \@empty
  \fi
  \@cons \@dbltoplist \@currbox
  \global \@dbltopnum \m@ne
  \ifdim \@colht<2.5\baselineskip
    \@latex@warning@no@line {Optional\space argument\space of\space \noexpand\twocolumn
                too\space tall\space on\space page\space \thepage}%
    \@emptycol
    \if@firstcolumn
    \else
      \@emptycol
    \fi
  \else
    \global \vsize \@colht
    \global \@colroom \@colht
    \@floatplacement
  \fi
}
\gdef\@specialoutput{%
   \ifnum \outputpenalty>-\c_ten_thousand_two
     \@doclearpage
   \else
     \ifnum \outputpenalty<-\c_ten_thousand_three
       \ifnum \outputpenalty<-\@MM \deadcycles \z@ \fi
       \global \setbox\@holdpg \vbox {\unvbox\@cclv}%
     \else
       \global \setbox\@holdpg \vbox{%
                      \unvbox\@holdpg
                      \unvbox\@cclv
                      \setbox\@tempboxa \lastbox
                      \unskip
                                     }%
       \@pagedp \dp\@holdpg
       \@pageht \ht\@holdpg
       \unvbox \@holdpg
       \@next\@currbox\@currlist{%
         \ifnum \count\@currbox>\z@
           \advance \@pageht \@pagedp
           \ifvoid\footins \else
             \advance \@pageht \ht\footins
             \advance \@pageht \skip\footins
             \advance \@pageht \dp\footins
           \fi
           \ifvbox \@kludgeins
             \ifdim \wd\@kludgeins=\z@
               \advance \@pageht \ht\@kludgeins
             \fi
           \fi
           \@reinserts
           \@addtocurcol
         \else
           \@reinserts
           \@addmarginpar
         \fi
         }\@latexbug
       \ifnum \outputpenalty<\z@
         \if@nobreak
           \nobreak
         \else
           \addpenalty \interlinepenalty
         \fi
       \fi
     \fi
   \fi
}
\def \@doclearpage {%
     \ifvoid\footins
       \setbox\@tempboxa\vsplit\@cclv to\z@ \unvbox\@tempboxa
       \setbox\@tempboxa\box\@cclv
       \xdef\@deferlist{\@toplist\@botlist\@deferlist}%
       \global \let \@toplist \@empty
       \global \let \@botlist \@empty
       \global \@colroom \@colht
       \ifx \@currlist\@empty
       \else
          \@latexerr{Float(s) lost}\@ehb
          \global \let \@currlist \@empty
       \fi
       \@makefcolumn\@deferlist
       \@whilesw\if@fcolmade \fi{\@opcol\@makefcolumn\@deferlist}%
       \if@twocolumn
         \if@firstcolumn
           \xdef\@dbldeferlist{\@dbltoplist\@dbldeferlist}%
           \global \let \@dbltoplist \@empty
           \global \@colht \textheight
           \group_begin:
              \@dblfloatplacement
              \@makefcolumn\@dbldeferlist
              \@whilesw\if@fcolmade \fi{\@outputpage
                                        \@makefcolumn\@dbldeferlist}%
           \group_end:
         \else
           \GAL_ignore_next_galley_vbox:{}\clearpage
         \fi
       \fi
     \else
       \setbox\@cclv\vbox{\box\@cclv\vfil}%
       \@makecol\@opcol
       \clearpage
     \fi
}
\gdef \@makecol {%
   \ifvoid\footins
     \setbox\@outputbox \box\@cclv
   \else
     \setbox\@outputbox \vbox {%
       \boxmaxdepth \@maxdepth
       \l_tmpa_dim\dp\@cclv
       \unvbox \@cclv
       \vskip-\l_tmpa_dim
       \vskip \skip\footins
       \color@begingroup
         \normalcolor
         \footnoterule
         \unvbox \footins
       \color@endgroup
       }%
   \fi
   \xdef\@freelist{\@freelist\@midlist}%
   \global \let \@midlist \@empty
   \@combinefloats
   \ifvbox\@kludgeins
     \@makespecialcolbox
   \else
     \setbox\@outputbox \vbox to\@colht {%
       \@texttop
       \dimen@ \dp\@outputbox
       \unvbox \@outputbox
       \vskip -\dimen@
       \@textbottom
       }%
   \fi
   \global \maxdepth \@maxdepth
}
\gdef \@makespecialcolbox {%
   \setbox\@outputbox \vbox {%
     \@texttop
     \dimen@ \dp\@outputbox
     \unvbox\@outputbox
     \vskip-\dimen@
     }%
   \l_tmpa_dim \@colht
   \ifdim \wd\@kludgeins>\z@
     \advance \l_tmpa_dim -\ht\@outputbox
     \advance \l_tmpa_dim \pageshrink
     \setbox\@outputbox \vbox to \@colht {%
       \unvbox\@outputbox
       \vskip \l_tmpa_dim
       \@textbottom
       }%
   \else
     \advance \l_tmpa_dim -\ht\@kludgeins
     \setbox \@outputbox \vbox to \@colht {%
       \GAL_ignore_next_galley_vbox: to \l_tmpa_dim {%
         \unvbox\@outputbox
         \@textbottom}%
       \vss}%
   \fi
   {\setbox \@tempboxa \box \@kludgeins}%
}
\def\@outputpage{%
\group_begin:           % the \group_end: is put in by \aftergroup
  \@resetactivechars
  \@parboxrestore
  \let \protect \noexpand   % <- this moved after parboxrestore!!!!
  \shipout \vbox{%
    \set@typeset@protect
    \aftergroup \group_end:
    \aftergroup \set@typeset@protect
                                % correct? or just restore by ending
                                % the group?
  \if@specialpage
    \global\@specialpagefalse\@nameuse{ps@\@specialstyle}%
  \fi
  \if@twoside
    \ifodd\count\z@ \let\@thehead\@oddhead \let\@thefoot\@oddfoot
         \let\@themargin\oddsidemargin
    \else \let\@thehead\@evenhead
       \let\@thefoot\@evenfoot \let\@themargin\evensidemargin
    \fi
  \fi
  \reset@font
  \normalsize
  \normalsfcodes
  \let\label\use_none:n
  \let\index\use_none:n
  \let\glossary\use_none:n
  \baselineskip\z@skip \lineskip\z@skip \lineskiplimit\z@
    \@begindvi
    \vskip \topmargin
    \moveright\@themargin \vbox {%
      \setbox\@tempboxa \vbox to\headheight{%
        \vfil
        \color@hbox
          \normalcolor
          \hb@xt@\textwidth{\@thehead}%
        \color@endbox
        }%                        %% 22 Feb 87
      \dp\@tempboxa \z@
      \box\@tempboxa
      \vskip \headsep
      \box\@outputbox
      \baselineskip \footskip
      \color@hbox
        \normalcolor
        \hb@xt@\textwidth{\@thefoot}%
      \color@endbox
      }%
    }%
  \global \@colht \textheight
  \stepcounter{page}%
  \let\firstmark\botmark
}
\def \@cflt{%
    \let \@elt \@comflelt
    \setbox\@tempboxa \vbox{}%
    \@toplist
    \setbox\@outputbox \vbox{%
                             \boxmaxdepth \maxdepth
                             \unvbox\@tempboxa
                             \vskip -\floatsep
                             \topfigrule
                             \vskip \textfloatsep
                             \unvbox\@outputbox
                             }%
    \let\@elt\relax
    \xdef\@freelist{\@freelist\@toplist}%
    \cs_gset_eq:NN\@toplist\@empty
}
\def\@comflelt#1{\setbox\@tempboxa
      \vbox{\unvbox\@tempboxa\box #1\vskip\floatsep}}
\def \@combinedblfloats{%
  \ifx \@dbltoplist \@empty
  \else
    \setbox\@tempboxa \vbox{}%
    \let \@elt \@comdblflelt
    \@dbltoplist
    \let \@elt \relax
    \xdef \@freelist {\@freelist\@dbltoplist}%
    \cs_gset_eq:NN \@dbltoplist \@empty
    \setbox\@outputbox \vbox to\textheight
      {%\boxmaxdepth\maxdepth   %% probably not needed, CAR
       \unvbox\@tempboxa\vskip-\dblfloatsep
       \ifnum \@dbltopnum>\m@ne
         \dblfigrule
       \fi
       \vskip \dbltextfloatsep
       \box\@outputbox
       }%
  \fi
}
\def\@vtryfc #1{%
  \global\setbox\@outputbox\vbox{}%
  \let\@elt\@wtryfc
  \@flsucceed
  \global\setbox\@outputbox \vbox to\@colht{%
    \vskip \@fptop
    \vskip -\@fpsep
    \unvbox \@outputbox
    \vskip \@fpbot}%
  \let\@elt\relax
  \xdef #1{\@failedlist\@flfail}%
  \xdef\@freelist{\@freelist\@flsucceed}}
\def\@wtryfc #1{%
  \global\setbox\@outputbox\vbox{%
    \unvbox\@outputbox
    \vskip\@fpsep
    \box #1}}
\def\@addmarginpar{\@next\@marbox\@currlist{\@cons\@freelist\@marbox
    \@cons\@freelist\@currbox}\@latexbug\@tempcnta\@ne
    \if@twocolumn
        \if@firstcolumn \@tempcnta\m@ne \fi
    \else
      \if@mparswitch
         \ifodd\c@page \else\@tempcnta\m@ne \fi
      \fi
      \if@reversemargin \@tempcnta -\@tempcnta \fi
    \fi
    \ifnum\@tempcnta <\z@  \global\setbox\@marbox\box\@currbox \fi
    \l_tmpa_dim\@mparbottom
    \advance\l_tmpa_dim -\@pageht
    \advance\l_tmpa_dim\ht\@marbox
    \ifdim\l_tmpa_dim >\z@
      \@latex@warning@no@line {Marginpar\space on\space page\space \thepage\space moved}%
    \else
      \l_tmpa_dim\z@
    \fi
    \global\@mparbottom\@pageht
    \global\advance\@mparbottom\l_tmpa_dim
    \global\advance\@mparbottom\dp\@marbox
    \global\advance\@mparbottom\marginparpush
    \advance\l_tmpa_dim -\ht\@marbox
    \global\setbox \@marbox
                   \vbox {\vskip \l_tmpa_dim
                          \box \@marbox}%
    \global \ht\@marbox \z@
    \global \dp\@marbox \z@
    \kern -\@pagedp
    \nointerlineskip
    \hb@xt@\columnwidth
      {\ifnum \@tempcnta >\z@
          \hskip\columnwidth \hskip\marginparsep
       \else
          \hskip -\marginparsep \hskip -\marginparwidth
       \fi
       \box\@marbox \hss}%
    \nointerlineskip
    \hbox{\vrule \@height\z@ \@width\z@ \@depth\@pagedp}}
\def\@outputdblcol{%
  \if@firstcolumn
    \global \@firstcolumnfalse
    \global \setbox\@leftcolumn \box\@outputbox
  \else
    \global \@firstcolumntrue
    \setbox\@outputbox \vbox {%
                         \hb@xt@\textwidth {%
                           \hb@xt@\columnwidth {%
                             \box\@leftcolumn \hss}%
                           \hfil
                           \vrule \@width\columnseprule
                           \hfil
                           \hb@xt@\columnwidth {%
                             \box\@outputbox \hss}%
                                             }%
                              }%
    \@combinedblfloats
    \@outputpage
    \group_begin:
      \@dblfloatplacement
      \@startdblcolumn
      \@whilesw\if@fcolmade \fi
        {\@outputpage
         \@startdblcolumn}%
    \group_end:
  \fi
}



%    \end{macrocode}
%
%    \begin{macrocode}
%\catcode`\:=12\relax
\endinput
%    \end{macrocode}
%
%    \begin{macrocode}
%</package>
%    \end{macrocode}
%
%
% \Finale
%
