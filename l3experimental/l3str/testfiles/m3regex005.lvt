%
% Copyright (C) 2011-2012 LaTeX3 Project
%

\documentclass{minimal}
\input{regression-test}

\RequirePackage{l3regex}

\begin{document}
\START
\AUTHOR{Bruno Le Floch}
\ExplSyntaxOn

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\cs_set_protected:Npn \test:nn #1#2
  {
    \regex_extract_all:nnN {#1} {#2} \l_foo_seq
    \seq_map_function:NN \l_foo_seq \tl_show_analysis:n
  }
\TEST{on~token~lists}{
  \test:nn { \cB. \cL.* \cE. } { {abc} def { gh {ijk}lm } }
  \test:nn { [\w\cC.]+ } { ab\undef{c}d\foobar def }
  \test:nn { \c{..\:}+ }
    { abc\de: g\hi: \jk:\mno: \:::p \\a: {\qrs t\uv:\xy:A } }
  \test:nn { [\c{.*}X]+ } { A \ab X\cd Y \deX \f \ XX\O ; }
  \test:nn { .. } { \abc { bcd } { e } }
}

\TEST{with~somewhat~unbalanced~braces}{
  \tl_set:Nn \l_tmpa_tl { ab {cd{\e}f}\gh }
  \regex_replace_all:nnN { \c[^L]. } { \0\0 } \l_tmpa_tl
  \regex_replace_all:nnN { \cL. } { \cB[ \0 \cE] } \l_tmpa_tl
  \tl_show_analysis:N \l_tmpa_tl
}

\TEST{Unbalanced~things}{
  \tl_set:Nn \l_tmpa_tl { a{}b }
  \regex_replace_once:nnN { . } { \cE> } \l_tmpa_tl
  \regex_replace_once:nnN { \cB. } { \0\0 } \l_tmpa_tl
  \regex_replace_all:nnN { .. } { \0 \c{\0} } \l_tmpa_tl
  \tl_show_analysis:N \l_tmpa_tl
}

\TEST{Macro~parameters}{
  \tl_set:Nn \l_tmpa_tl { aab }
  \regex_replace_all:nnN { a } { \cP\# } \l_tmpa_tl
  \regex_replace_once:nnN { . } { \c{\0} } \l_tmpa_tl
  \tl_show_analysis:N \l_tmpa_tl
  % Wrong:
  % \regex_replace_once:nnN { b } { \c{\cP\#} } \l_tmpa_tl
}

\TEST{Nested~classes}{
  \regex_extract_all:nnN
    { [ \cL[A-Z0-9{}] \c[^BE][z-\~] ]+ } { 0ABYZz|{zA0} } \l_foo_seq
  \seq_show:N \l_foo_seq
  \regex_extract_all:nnN
    { \cB. \c[^BE].+ \cE. } { abc {def{ghi}jkl} m{}no {p{q}r} } \l_foo_seq
  \seq_show:N \l_foo_seq
}

\TEST{Escaped~u}{
  \tl_set:Nn \l_tmpa_tl { x#|\c_empty_tl }
  \tl_set:Nn \l_tmpb_tl { y\c_space_tl # }
  \tl_set:Nn \l_tmpc_tl { Ax#|\c_empty_tl B { x#|\c_empty_tl } }
  \regex_extract_all:nnN
    { \u{l_tmpa_tl} | x } { xx#|\c_empty_tl x } \l_foo_seq
  \seq_show:N \l_foo_seq
  \regex_replace_all:nnN
    { (.) \u{l_tmpa_tl} (.) }
    { \1\2 \u{l_tmpb_tl} }
    \l_tmpc_tl
  \tl_show_analysis:N \l_tmpc_tl
}

\TEST{Catcodes~shouldn't~"stick"}{
  \regex_extract_all:nnN
    { [ \cL[A-Z] * 0-2 \s \cO[\+\-] ] + } { aA*0123~+AZ-~x } \l_foo_seq
  \seq_show:N \l_foo_seq
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\END
