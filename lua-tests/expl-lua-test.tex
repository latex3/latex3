%%%%%%%%%%%%%%%%%%%%%%
%%% Initialization %%%
%%%%%%%%%%%%%%%%%%%%%%

%% Basic Loading
\ExplSyntaxOn

%% Required Packages
\RequirePackage { l3benchmark }

%% End the document at the end of the file
\str_const:NV \c__example_this_file_str \g_file_curr_name_str
\everyeof={
    \str_if_eq:VVT \c__example_this_file_str \g_file_curr_name_str {
        \cs_if_exist_use:c { @@end }
    }
}

%% Set the testing mode
\lua_now:n {
    local~ mode = arg[rawlen(arg)]

    if~ mode:lower() == "tex" then~
        luatexbase.add_to_callback("process_input_buffer", function (line)
            return~ line:gsub("lprop", "prop")
        end, "fix_names")
    elseif~ mode:lower() == "lua" then~
        % Do nothing
    else~
        print()
        print("!~ Unknown~ mode:~ " .. mode .. ".")
        print("(Must~ be~ either~ 'tex'~ or~ 'lua')")
        os.exit(-1)
    end
}

%% Show the "\show..." messages without pausing
\tex_scrollmode:D
\cs_undefine:N \tex_interactionmode:D
\int_new:N \tex_interactionmode:D

%% Hide the error context, and exit if we encounter a real error
\lua_now:n {
    luatexbase.add_to_callback("show_error_hook", function ()
        if~ status.lasterrorstring~ then~
            print(status.lasterrorcontext)
            tex.finish()
        end~
        print()
    end, "fix_show")
}

%% Section titles
\str_new:N \l__example_section_str
\cs_new:Nn \__example_section:n {
    \iow_term:e {
        \iow_newline:
        === \tl_use:N \c_space_tl
        \str_use:N \l__example_section_str :~
        \exp_not:n { #1 }
        \tl_use:N \c_space_tl ===
    }
}

%% Load the implementation
\str_if_eq:nnT { lprop } { l p r o p } {
    \file_input:n { expl-lua }
}

%% Variants
\cs_generate_variant:Nn \tl_analysis_show:n { e, o }


%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Property List Tests %%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%

\str_set:Nn \l__example_section_str { prop }

%% Test creating a property list
\__example_section:n { new }
\lprop_new:N \g__example_A_lprop

%% Test setting a property
\__example_section:n { gput }
\lprop_gput:Nnn \g__example_A_lprop { key1 } { value1 }
\lprop_gput:Nnn \g__example_A_lprop { key2 } { value2 }
\lprop_gput:Nnn \g__example_A_lprop { key3 } { value3 }

%% Test getting a property
\__example_section:n { item }
\tl_analysis_show:e { \lprop_item:Nn \g__example_A_lprop { key3 } }

%% Test clearing the list
\__example_section:n { clear }
\lprop_gclear:N \g__example_A_lprop

%% Test getting a property that doesn't exist
\__example_section:n { not-exist }
\tl_analysis_show:e { \lprop_item:Nn \g__example_A_lprop { key1 } }

%% Test setting weird catcodes
\__example_section:n { weird-catcodes }
\lprop_new:N \g__example_B_lprop
\lprop_gput:Nne \g__example_B_lprop { key2 } {
    \char_generate:nn { `s  } { 1  }
    \char_generate:nn { `e  } { 2  }
    \char_generate:nn { `c  } { 3  }
    \char_generate:nn { `o  } { 4  }
    \char_generate:nn { `n  } { 6  }
    \char_generate:nn { `d  } { 7  }
    \char_generate:nn { `\  } { 8  }
    \char_generate:nn { `v  } { 10 }
    \char_generate:nn { `a  } { 11 }
    \char_generate:nn { `l  } { 12 }
    \char_generate:nn { `u  } { 1  }
    \char_generate:nn { `e  } { 2  }
    \exp_not:N \scan_stop:
}

%% Test setting two property lists equal to each other
\__example_section:n { gset_eq }
\lprop_gset_eq:NN \g__example_A_lprop \g__example_B_lprop
\tl_analysis_show:e { \lprop_item:Nn \g__example_A_lprop { key2 } }

%% Test scanning key--value input
\__example_section:n { gput_from_keyval }
\lprop_gclear:N \g__example_A_lprop
\lprop_gput_from_keyval:Nn \g__example_A_lprop {
    key1 = ~value1~,
    key2 = ~{ ~value2~ }~,
    key3 = { \c_group_begin_token }
}
\tl_analysis_show:e { \lprop_item:Nn \g__example_A_lprop { key1 } }
\tl_analysis_show:e { \lprop_item:Nn \g__example_A_lprop { key2 } }
\tl_analysis_show:e { \lprop_item:Nn \g__example_A_lprop { key3 } }

%% Test concatenating two property lists
\__example_section:n { gconcat }
\lprop_new:N \g__example_C_lprop
\lprop_gconcat:NNN \g__example_C_lprop \g__example_A_lprop \g__example_B_lprop

%% Test mapping over the property list
\__example_section:n { map_function }
\cs_new:Nn \__example_test:nn {
    \tl_analysis_show:n { #1 = #2 }
}
\lprop_map_function:NN \g__example_C_lprop \__example_test:nn

%% Test getting an item
\__example_section:n { get }
\lprop_get:NnN \g__example_C_lprop { key2 } \l_tmpa_tl
\tl_analysis_show:N \l_tmpa_tl

%% Test popping an item
\__example_section:n { gpop }
\lprop_gpop:NnN \g__example_C_lprop { key1 } \l_tmpa_tl
\tl_analysis_show:N \l_tmpa_tl
\tl_analysis_show:e { \lprop_item:Nn \g__example_C_lprop { key1 } }

%% Test counting the number of items
\__example_section:n { count }
\tl_analysis_show:e { \int_eval:w \lprop_count:N \g__example_C_lprop }

%% Test mapping inline
\__example_section:n { map_inline }
\lprop_map_inline:Nn \g__example_C_lprop {
    \tl_analysis_show:n { #1 = #2 }
}
