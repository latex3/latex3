%%%%%%%%%%%%%%%%%%%%%%
%%% Initialization %%%
%%%%%%%%%%%%%%%%%%%%%%

%% Basic Loading
\ExplSyntaxOn

%% Required Packages
\RequirePackage { l3benchmark }

%% End the document at the end of the file
\str_const:NV \c__example_this_file_str \g_file_curr_name_str
\cs_set_eq:Nc \end_document: { @@end }
\everyeof={
    \str_if_eq:VVT \c__example_this_file_str \g_file_curr_name_str {
        \end_document:
    }
}

%% Always show messages without waiting for a response
\tex_scrollmode:D
\cs_undefine:N \tex_interactionmode:D
\int_new:N \tex_interactionmode:D

%% Load the implementation
\file_input:n { lua-prop }

%% Variants
\cs_generate_variant:Nn \tl_analysis_show:n { e, o }


%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Property List Tests %%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% Test creating a property list
\lprop_new:N \g__example_A_lprop

%% Test setting a property
\lprop_gput:Nnn \g__example_A_lprop { key1 } { value1 }
\lprop_gput:Nnn \g__example_A_lprop { key2 } { value2 }
\lprop_gput:Nnn \g__example_A_lprop { key3 } { value3 }

%% Test getting a property
\tl_analysis_show:e { \lprop_item:Nn \g__example_A_lprop { key3 } }

%% Test clearing the list
\lprop_gclear:N \g__example_A_lprop

%% Test getting a property that doesn't exist
\tl_analysis_show:e { \lprop_item:Nn \g__example_A_lprop { key1 } }

%% Test setting weird catcodes
\lprop_new:N \g__example_B_lprop
\lprop_gput:Nne \g__example_B_lprop { key2 } {
    \char_generate:nn { `s  } { 1  }
    \char_generate:nn { `e  } { 2  }
    \char_generate:nn { `c  } { 3  }
    \char_generate:nn { `o  } { 4  }
    \char_generate:nn { `n  } { 6  }
    \char_generate:nn { `d  } { 7  }
    \char_generate:nn { `\  } { 8  }
    \char_generate:nn { `v  } { 10 }
    \char_generate:nn { `a  } { 11 }
    \char_generate:nn { `l  } { 12 }
    \char_generate:nn { `u  } { 1  }
    \char_generate:nn { `e  } { 2  }
    \exp_not:N \g__example_B_lprop
}

%% Test setting two property lists equal to each other
\lprop_gset_eq:NN \g__example_A_lprop \g__example_B_lprop
\tl_analysis_show:e { \lprop_item:Nn \g__example_A_lprop { key2 } }

%% Test scanning key--value input
\lprop_gclear:N \g__example_A_lprop
\lprop_gput_from_keyval:Nn \g__example_A_lprop {
    key1 = ~value1~,
    key2 = ~{ ~value2~ }~,
    key3 = { \bgroup }
}
\tl_analysis_show:e { \lprop_item:Nn \g__example_A_lprop { key1 } }
\tl_analysis_show:e { \lprop_item:Nn \g__example_A_lprop { key2 } }
\tl_analysis_show:e { \lprop_item:Nn \g__example_A_lprop { key3 } }

%% Test concatenating two property lists
\lprop_new:N \g__example_C_lprop
\lprop_gconcat:NNN \g__example_A_lprop \g__example_B_lprop \g__example_C_lprop

%% Test mapping over the property list
\cs_new:Nn \__example_test:nn {
    \tl_analysis_show:n { #1 = #2 }
}
\lprop_map_function:NN \g__example_C_lprop \__example_test:nn

%% Test getting an item
\lprop_get:NnN \g__example_C_lprop { key2 } \l_tmpa_tl
\tl_analysis_show:N \l_tmpa_tl

%% Test popping an item
\lprop_gpop:NnN \g__example_C_lprop { key1 } \l_tmpa_tl
\tl_analysis_show:N \l_tmpa_tl
\tl_analysis_show:o { \lprop_item:Nn \g__example_C_lprop { key1 } }

%% Test counting the number of items
\tl_analysis_show:e { \int_use:N \lprop_count:N \g__example_C_lprop }

%% Test mapping inline
\lprop_map_inline:Nn \g__example_C_lprop {
    \tl_analysis_show:n { #1 = #2 }
}
