%
% Copyright (C) The LaTeX Project
%

\documentclass{minimal}
\input{regression-test}
\ExplSyntaxOn
\debug_on:n { check-declarations , deprecation , log-functions }
\ExplSyntaxOff
\begin{document}
\START
\AUTHOR{Jonathan P. Spratte}
\ExplSyntaxOn

\OMIT
\cs_set:Npn \test_type_k:n #1
  { \TYPE { KEY~NO~VAL:~"\tl_to_str:n {#1}" } }
\cs_set:Npn \test_type_kv:nn #1#2
  { \TYPE { KEY:~"\tl_to_str:n {#1}"~ VAL:~"\tl_to_str:n {#2}" } }
\TIMO

\TEST{simple~ map}
  {
    \keyval_map_inline:nnn { a, b=c, , d, e={f,g} }
      { \test_type_k:n {#1} }
      { \test_type_kv:nn {#1} {#2} }
  }

\TEST{break~ on~ d}
  {
    \keyval_map_inline:nnn { a, b=c, , d, e={f,g} }
      {
        \str_if_eq:nnTF {#1} { d }
          { \keyval_map_break: }
          { \test_type_k:n {#1} }
      }
      { \test_type_kv:nn {#1} {#2} }
    \keyval_map_inline:nnn { a, b=c, , d, e={f,g} }
      {
        \str_if_eq:nnTF {#1} { d }
          { \keyval_map_break:n { \TYPE { Broken~ on~ d } } }
          { \test_type_k:n {#1} }
      }
      { \test_type_kv:nn {#1} {#2} }
  }

\TEST{nested~ use}
  {
    \keyval_map_inline:nnn { a = {b,c=d,e}, f, g={h,i=j}, k, l=m }
      { \test_type_k:n {#1} }
      {
        \TYPE { KEY:~"\tl_to_str:n {#1}" }
        \keyval_map_inline:nnn {#2}
          {
            \str_if_eq:nnTF {##1} { h }
              { \keyval_map_break:n { \TYPE { Broken~ on~ nested~ h } } }
              { \test_type_k:n {##1~ (nested)} }
          }
          { \test_type_kv:nn {##1~ (nested)} {##2} }
      }
  }

\END
