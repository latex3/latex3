%
% Copyright (C) 2009 The LaTeX Project
% 

\documentclass{minimal}
\input{regression-test}

\RequirePackage[log-functions]{expl3}


\begin{document}
\START
\AUTHOR{Will Robertson}
\ExplSyntaxOn

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\TEST{catcodes~generic~functions}{
  \char_set_catcode:nn {`\!} {14}
  \TYPE { \char_value_catcode:n {`\!} }
  \char_show_value_catcode:n {`\!}
  \char_set_catcode:nn {`\!} { (14+3-1)/2 }
  \TYPE { \char_value_catcode:n {`\!} }
}

\TEST{catcodes~explicit~functions}{
  \char_make_escape:n {`\!} \char_make_escape:N   \?
  \TYPE { \char_value_catcode:n {`\!} / \char_value_catcode:n {`\?} }
  \char_make_group_begin:n {`\!} \char_make_group_begin:N   \?
  \TYPE { \char_value_catcode:n {`\!} / \char_value_catcode:n {`\?} }
  \char_make_group_end:n {`\!} \char_make_group_end:N   \?
  \TYPE { \char_value_catcode:n {`\!} / \char_value_catcode:n {`\?} }
  \char_make_math_shift:n {`\!} \char_make_math_shift:N   \?
  \TYPE { \char_value_catcode:n {`\!} / \char_value_catcode:n {`\?} }
  \char_make_alignment:n {`\!} \char_make_alignment:N   \?
  \TYPE { \char_value_catcode:n {`\!} / \char_value_catcode:n {`\?} }
  \char_make_end_line:n {`\!} \char_make_end_line:N   \?
  \TYPE { \char_value_catcode:n {`\!} / \char_value_catcode:n {`\?} }
  \char_make_parameter:n {`\!} \char_make_parameter:N   \?
  \TYPE { \char_value_catcode:n {`\!} / \char_value_catcode:n {`\?} }
  \char_make_superscript:n {`\!} \char_make_superscript:N   \?
  \TYPE { \char_value_catcode:n {`\!} / \char_value_catcode:n {`\?} }
  \char_make_subscript:n {`\!} \char_make_subscript:N   \?
  \TYPE { \char_value_catcode:n {`\!} / \char_value_catcode:n {`\?} }
  \char_make_ignore:n {`\!} \char_make_ignore:N   \?
  \TYPE { \char_value_catcode:n {`\!} / \char_value_catcode:n {`\?} }
  \char_make_space:n {`\!} \char_make_space:N   \?
  \TYPE { \char_value_catcode:n {`\!} / \char_value_catcode:n {`\?} }
  \char_make_letter:n {`\!} \char_make_letter:N   \?
  \TYPE { \char_value_catcode:n {`\!} / \char_value_catcode:n {`\?} }
  \char_make_other:n {`\!} \char_make_other:N   \?
  \TYPE { \char_value_catcode:n {`\!} / \char_value_catcode:n {`\?} }
  \char_make_active:n {`\!} \char_make_active:N   \?
  \TYPE { \char_value_catcode:n {`\!} / \char_value_catcode:n {`\?} }
  \char_make_comment:n {`\!} \char_make_comment:N   \?
  \TYPE { \char_value_catcode:n {`\!} / \char_value_catcode:n {`\?} }
  \char_make_invalid:n {`\!} \char_make_invalid:N   \?
  \TYPE { \char_value_catcode:n {`\!} / \char_value_catcode:n {`\?} }
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\TEST{lccode~generic~functions}{
  \TYPE { orig:~\char_value_lccode:n {`\!} }
  \char_set_lccode:nn {`\!} {14}
  \TYPE { new:~\char_value_lccode:n {`\!} }
  \char_show_value_lccode:n {`\!}
  \char_set_lccode:nn {`\!} { (14+3-1)/2 }
  \TYPE { new:~\char_value_lccode:n {`\!} }
}

\TEST{uccode~generic~functions}{
  \TYPE { orig:~\char_value_uccode:n {`\!} }
  \char_set_uccode:nn {`\!} {14}
  \TYPE { new:~\char_value_uccode:n {`\!} }
  \char_show_value_uccode:n {`\!}
  \char_set_uccode:nn {`\!} { (14+3-1)/2 }
  \TYPE { new:~\char_value_uccode:n {`\!} }
}

\TEST{sfcode~generic~functions}{
  \TYPE { orig:~\char_value_sfcode:n {`\!} }
  \char_set_sfcode:nn {`\!} {14}
  \TYPE { new:~\char_value_sfcode:n {`\!} }
  \char_show_value_sfcode:n {`\!}
  \char_set_sfcode:nn {`\!} { (14+3-1)/2 }
  \TYPE { new:~\char_value_sfcode:n {`\!} }
}

\TEST{mathcode~generic~functions}{
  \TYPE { orig:~\char_value_mathcode:n {`\!} }
  \char_set_mathcode:nn {`\!} {14}
  \TYPE { new:~\char_value_mathcode:n {`\!} }
  \char_show_value_mathcode:n {`\!}
  \char_set_mathcode:nn {`\!} { (14+3-1)/2 }
  \TYPE { new:~\char_value_mathcode:n {`\!} }
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\TESTEXP{token~constants}{
  \meaning \c_group_begin_token      \NEWLINE
  \meaning \c_group_end_token        \NEWLINE
  \meaning \c_math_shift_token       \NEWLINE
  \meaning \c_alignment_token    \NEWLINE
  \meaning \c_parameter_token        \NEWLINE
  \meaning \c_superscript_token \NEWLINE
  \meaning \c_subscript_token   \NEWLINE
  \meaning \c_space_token            \NEWLINE
  \meaning \c_letter_token           \NEWLINE
  \meaning \c_other_token       \NEWLINE
  \meaning \c_active_char_tl 
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\TEST{token~if~group~begin}{
  \TYPE { \token_if_group_begin:NTF \bgroup {TRUE}{FALSE} }
  \exp_after:wN \token_if_group_begin:NTF \bgroup {\TRUE}{\FALSE}
  \token_if_group_begin:NTF \begingroup {\TRUE}{\FALSE}
  \token_if_group_begin:NTF ? {\TRUE}{\FALSE}
  \token_if_group_begin:NTF # {\TRUE}{\FALSE}
  \token_if_group_begin:NTF \par {\TRUE}{\FALSE}
}

\TEST{token~if~group~end}{
  \TYPE { \token_if_group_end:NTF \egroup {TRUE}{FALSE} }
  \exp_after:wN \token_if_group_end:NTF \egroup {\TRUE}{\FALSE}
  \token_if_group_end:NTF \endgroup {\TRUE}{\FALSE}
  \token_if_group_end:NTF ? {\TRUE}{\FALSE}
  \token_if_group_end:NTF # {\TRUE}{\FALSE}
  \token_if_group_end:NTF \par {\TRUE}{\FALSE}
}

\cs_set_nopar:Npn \tmp {$}
\TEST{token~if~math~shift}{
  \TYPE {\token_if_math_shift:NTF $ {TRUE}{FALSE} }
  \exp_after:wN \token_if_math_shift:NTF \tmp {\TRUE}{\FALSE}
  \token_if_math_shift:NTF \tmp {\TRUE}{\FALSE}
  \token_if_math_shift:NTF ! {\TRUE}{\FALSE}
  \token_if_math_shift:NTF # {\TRUE}{\FALSE}
  \token_if_math_shift:NTF \par {\TRUE}{\FALSE}
}

\cs_set_nopar:Npn \tmp {&}
\TEST{token~if~alignment}{
  \TYPE { \token_if_alignment:NTF & {TRUE}{FALSE} }
  \exp_after:wN \token_if_alignment:NTF \tmp {\TRUE}{\FALSE}
  \token_if_alignment:NTF \tmp {\TRUE}{\FALSE}
  \token_if_alignment:NTF ! {\TRUE}{\FALSE}
  \token_if_alignment:NTF # {\TRUE}{\FALSE}
  \token_if_alignment:NTF \par {\TRUE}{\FALSE}
}

\cs_set_nopar:Npn \tmp {##}
\TEST{token~if~parameter}{
  \TYPE { \token_if_parameter:NTF # {TRUE}{FALSE} }
  \exp_after:wN \token_if_parameter:NTF \tmp {\TRUE}{\FALSE}
  \token_if_parameter:NTF \tmp {\TRUE}{\FALSE}
  \token_if_parameter:NTF ! {\TRUE}{\FALSE}
  \token_if_parameter:NTF \par {\TRUE}{\FALSE}
}

\cs_set_nopar:Npn \tmp {^}
\TEST{token~if~superscript}{
  \TYPE { \token_if_superscript:NTF ^ {TRUE}{FALSE} }
  \exp_after:wN \token_if_superscript:NTF \tmp {\TRUE}{\FALSE}
  \token_if_superscript:NTF \tmp {\TRUE}{\FALSE}
  \token_if_superscript:NTF ! {\TRUE}{\FALSE}
  \token_if_superscript:NTF # {\TRUE}{\FALSE}
  \token_if_superscript:NTF \par {\TRUE}{\FALSE}
}

\char_make_subscript:N \-
\cs_set_nopar:Npn \tmp {-}
\TEST{token~if~subscript}{
  \TYPE { \token_if_subscript:NTF - {TRUE}{FALSE} }
  \exp_after:wN \token_if_subscript:NTF \tmp {\TRUE}{\FALSE}
  \token_if_subscript:NTF \tmp {\TRUE}{\FALSE}
  \token_if_subscript:NTF ! {\TRUE}{\FALSE}
  \token_if_subscript:NTF # {\TRUE}{\FALSE}
  \token_if_subscript:NTF \par {\TRUE}{\FALSE}
}
\char_make_other:N \-

\cs_set_nopar:Npn \tmp {~}
\TEST{token~if~space~TODO~BROKEN!!!!}{
  \TYPE { \token_if_space:NTF ~ {TRUE}{FALSE} }
  \exp_after:wN \token_if_space:NTF \tmp {\TRUE}{\FALSE}
  \token_if_space:NTF \tmp {\TRUE}{\FALSE}
  \token_if_space:NTF \  {\TRUE}{\FALSE}
  \token_if_space:NTF \space {\TRUE}{\FALSE}
  \token_if_space:NTF # {\TRUE}{\FALSE}
  \token_if_space:NTF \par {\TRUE}{\FALSE}
}

\cs_set_nopar:Npn \tmp {x}
\TEST{token~if~letter}{
  \TYPE { \token_if_letter:NTF y {TRUE}{FALSE} }
  \exp_after:wN \token_if_letter:NTF \tmp {\TRUE}{\FALSE}
  \token_if_letter:NTF \tmp {\TRUE}{\FALSE}
  \token_if_letter:NTF ! {\TRUE}{\FALSE}
  \token_if_letter:NTF # {\TRUE}{\FALSE}
  \token_if_letter:NTF \par {\TRUE}{\FALSE}
}

\cs_set_nopar:Npn \tmp {-}
\TEST{token~if~other}{
  \TYPE { \token_if_other:NTF ! {TRUE}{FALSE} }
  \exp_after:wN \token_if_other:NTF \tmp {\TRUE}{\FALSE}
  \token_if_other:NTF \tmp {\TRUE}{\FALSE}
  \token_if_other:NTF x {\TRUE}{\FALSE}
  \token_if_other:NTF # {\TRUE}{\FALSE}
  \token_if_other:NTF \par {\TRUE}{\FALSE}
}

\char_make_active:N \!
\def ! {hello}
\TEST{token~if~active~char}{
  \TYPE { \token_if_active:NTF ! {TRUE}{FALSE} }
  \token_if_active:NTF \c_active_char_tl {\TRUE}{\FALSE} 
  \token_if_active:NTF # {\TRUE}{\FALSE}
  \token_if_active:NTF \par {\TRUE}{\FALSE}
}
\char_make_other:N \!

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\def\A{A}
\def\B{\A}
\TESTEXP{if_eq_meaning~(also~see~\cs_if_eq)}{
  \token_if_eq_meaning:NNTF \undefined \@undefined {\TRUE}{\FALSE} \NEWLINE
  \token_if_eq_meaning:NNTF A B   {\TRUE}{\FALSE} \NEWLINE
  \token_if_eq_meaning:NNTF \A \B {\TRUE}{\FALSE}
}

\TESTEXP{if_eq_catcode}{
  \token_if_eq_catcode:NNTF  A B  {\TRUE} {\FALSE} \NEWLINE
  \token_if_eq_catcode:NNTF  : _  {\TRUE} {\FALSE} \NEWLINE
  \token_if_eq_catcode:NNTF  ! _  {\TRUE} {\FALSE} \NEWLINE
  \token_if_eq_catcode:NNTF  # _  {\TRUE} {\FALSE}
}

\TESTEXP{if_eq_charcode}{
  \token_if_eq_charcode:NNTF  A B  {\TRUE} {\FALSE} \NEWLINE
  \token_if_eq_charcode:NNTF  A a  {\TRUE} {\FALSE} \NEWLINE
  \token_if_eq_charcode:NNTF  a a  {\TRUE} {\FALSE}
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\def \macr {}
\catcode`\!=13
\def ! {}
\TESTEXP{cs~vs~macro~(T/F/T~T/T/F)}{
  \token_if_cs:NTF    \macr {\TRUE}{\FALSE} \NEWLINE
  \token_if_cs:NTF    ! {\TRUE}{\FALSE} \NEWLINE
  \token_if_cs:NTF    \the {\TRUE}{\FALSE} \NEWLINE\NEWLINE
  \token_if_macro:NTF \macr {\TRUE}{\FALSE} \NEWLINE
  \token_if_macro:NTF ! {\TRUE}{\FALSE} \NEWLINE
  \token_if_macro:NTF \the {\TRUE}{\FALSE} 
}
\catcode`\!=12

\cs_set_nopar:Npn \A {}
\cs_set:Npn \B {}
\cs_set_protected_nopar:Npn \C {}
\cs_set_protected:Npn \D {}

\TESTEXP{if~macro}{
  \token_if_macro:NTF \undefined {\TRUE}{\FALSE} \NEWLINE
  \token_if_macro:NTF \write {\TRUE}{\FALSE} \NEWLINE
  \token_if_macro:NTF \A {\TRUE}{\FALSE} \NEWLINE
  \token_if_macro:NTF \B {\TRUE}{\FALSE} \NEWLINE
  \token_if_macro:NTF \C {\TRUE}{\FALSE} \NEWLINE
  \token_if_macro:NTF \D {\TRUE}{\FALSE}
} 

\TESTEXP{if~long_macro}{
  \token_if_long_macro:NTF \undefined {\TRUE}{\FALSE} \NEWLINE
  \token_if_long_macro:NTF \write {\TRUE}{\FALSE} \NEWLINE
  \token_if_long_macro:NTF \A {\TRUE}{\FALSE} \NEWLINE
  \token_if_long_macro:NTF \B {\TRUE}{\FALSE} \NEWLINE
  \token_if_long_macro:NTF \C {\TRUE}{\FALSE} \NEWLINE
  \token_if_long_macro:NTF \D {\TRUE}{\FALSE}
}

\TESTEXP{if~protected_macro}{
  \token_if_protected_macro:NTF \undefined {\TRUE}{\FALSE} \NEWLINE
  \token_if_protected_macro:NTF \write {\TRUE}{\FALSE} \NEWLINE
  \token_if_protected_macro:NTF \A {\TRUE}{\FALSE} \NEWLINE
  \token_if_protected_macro:NTF \B {\TRUE}{\FALSE} \NEWLINE
  \token_if_protected_macro:NTF \C {\TRUE}{\FALSE} \NEWLINE
  \token_if_protected_macro:NTF \D {\TRUE}{\FALSE}
}

\TESTEXP{if~protected_long_macro}{
  \token_if_protected_long_macro:NTF \undefined {\TRUE}{\FALSE} \NEWLINE
  \token_if_protected_long_macro:NTF \write {\TRUE}{\FALSE} \NEWLINE
  \token_if_protected_long_macro:NTF \A {\TRUE}{\FALSE} \NEWLINE
  \token_if_protected_long_macro:NTF \B {\TRUE}{\FALSE} \NEWLINE
  \token_if_protected_long_macro:NTF \C {\TRUE}{\FALSE} \NEWLINE
  \token_if_protected_long_macro:NTF \D {\TRUE}{\FALSE}
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\TESTEXP{token_if_expandable}{
  \token_if_expandable:NTF \A {\TRUE}{\FALSE}         \NEWLINE
  \token_if_expandable:NTF \the {\TRUE}{\FALSE}       \NEWLINE
  \token_if_expandable:NTF A {\TRUE}{\FALSE}          \NEWLINE
  \token_if_expandable:NTF \undefined {\TRUE}{\FALSE} \NEWLINE
  \token_if_expandable:NTF \write {\TRUE}{\FALSE}     \NEWLINE
  \token_if_expandable:NTF \relax {\TRUE}{\FALSE}
}

\let\primitivegdef\gdef
\def\gdef{\global\def}
\TESTEXP{token_if_primitive}{
  \token_if_primitive:NTF A          {\TRUE}{\FALSE} \NEWLINE
  \token_if_primitive:NTF \A         {\TRUE}{\FALSE} \NEWLINE
  \token_if_primitive:NTF \the       {\TRUE}{\FALSE} \NEWLINE
  \token_if_primitive:NTF \undefined {\TRUE}{\FALSE} \NEWLINE
  \token_if_primitive:NTF \write     {\TRUE}{\FALSE} \NEWLINE
  \token_if_primitive:NTF \def       {\TRUE}{\FALSE} \NEWLINE
  \token_if_primitive:NTF \relax     {\TRUE}{\FALSE}
}
\let\gdef\primitivegdef

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\cs_set_nopar:Npn \tmpA #1 <-> #2 { #1 ## #2 }
\cs_set_protected:Npn \tmpB #1 / #2 { #1 ## #2 }
\TESTEXP{token_get_~_spec}{
  \token_get_prefix_spec:N      \tmpA \NEWLINE
  \token_get_arg_spec:N         \tmpA \NEWLINE
  \token_get_replacement_spec:N \tmpA \NEWLINE \NEWLINE
  \token_get_prefix_spec:N      \tmpB \NEWLINE
  \token_get_arg_spec:N         \tmpB \NEWLINE
  \token_get_replacement_spec:N \tmpB \NEWLINE
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\END
