%
% Copyright (C) 2012 The LaTeX3 Project
%

\documentclass{minimal}

\input{regression-test}

\RequirePackage[check-declarations,log-functions]{expl3}
\RequirePackage{l3bigint}


% Everything before this is ignored by the test system.
\START

\AUTHOR{Bruno Le Floch}


% don't display stuff from executing \begin{document}
\OMIT
\begin{document}
\TIMO

\ExplSyntaxOn

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% allocating new bigints:
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\TEST { allocating~new~registers;~no~worries }
  {
    \bigint_new:N \l_testa_bigint
    \bigint_new:N \g_testa_bigint
    \bigint_new:N \g_testb_bigint
  }

\TEST { allocating~same~name:~errors~expected }
  {
    \bigint_new:N \l_testa_bigint        % define second time
    \bigint_new:N \g_testa_bigint        % gives error
  }

\TEST { allocate~or~clear }
  {
    \OMIT
      \bigint_set:Nn \l_testa_bigint { 10 }
      \bigint_gset:Nn \g_testa_bigint { 10 }
    \TIMO
    \group_begin:
      \bigint_zero_new:N \l_testa_bigint
      \bigint_zero_new:N \l_testb_bigint
      \bigint_gzero_new:N \g_testa_bigint
      \bigint_gzero_new:N \g_testb_bigint
      \TYPE { \bigint_use:N \l_testa_bigint }
      \TYPE { \bigint_use:N \l_testb_bigint }
      \TYPE { \bigint_use:N \g_testa_bigint }
      \TYPE { \bigint_use:N \g_testb_bigint }
    \group_end:
    \TYPE { \bigint_use:N \l_testa_bigint }
    \TYPE { \bigint_use:N \l_testb_bigint }
    \TYPE { \bigint_use:N \g_testa_bigint }
    \TYPE { \bigint_use:N \g_testb_bigint }
  }

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% incrementing + decrementing
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\TEST{incrementing~and~decrementing:~expect~3,~-1}
  {
    \bigint_gincr:N \g_testa_bigint
    \bigint_gincr:N \g_testa_bigint
    \bigint_gincr:N \g_testa_bigint
    \TYPE { \bigint_use:N  \g_testa_bigint }
    \bigint_gzero:N \g_testa_bigint
    \bigint_gdecr:N \g_testa_bigint
    \TYPE { \bigint_use:N  \g_testa_bigint }
  }

\TEST { generating~overflow:~expect~2147483647,~-2147483648,~2147483647 }
  {
    \bigint_set:Nn \l_testa_bigint { \int_use:N \c_max_int }
    \TYPE { \bigint_use:N \l_testa_bigint }
    \bigint_incr:N \l_testa_bigint
    \TYPE { \bigint_use:N \l_testa_bigint }
    \bigint_decr:N \l_testa_bigint
    \TYPE { \bigint_use:N \l_testa_bigint }
  }

\TEST { incrementing~and~decrementing:~expect~-2 }
  {
    \bigint_zero:N \l_testa_bigint
    \bigint_decr:N \l_testa_bigint
    \bigint_decr:N \l_testa_bigint
    \TYPE { \bigint_use:N \l_testa_bigint }
  }

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% using invalid variables
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% \TEST { trying~invalid~variables:~expect~errors }
%   {
%     \bigint_decr:N \l_testb_bigint          % ok
%     \cs_set_nopar:Npn \l_testb_bigint {} % causes bad error below
%     \bigint_decr:N \l_testb_bigint
%   }

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% using num expr ...
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% \TEST { using~num~expr }
%   {
%     \bigint_set:Nn \l_testa_bigint { 200 - 15  }
%     \TYPE { \bigint_use:N \l_testa_bigint } % we hope for a value of 185
%     \bigint_set:Nn \l_testa_bigint { 30 / \g_testa_bigint  }
%     \TYPE { \bigint_use:N \l_testa_bigint } % we hope for a value of -30
%     \bigint_set:Nn \l_testa_bigint { 27 + 3 / \g_testa_bigint  }
%     \TYPE { \bigint_use:N \l_testa_bigint } % we hope for a value of 24
%     \bigint_set:Nn \l_testa_bigint { (27 + 3 ) / \g_testa_bigint  }
%     \TYPE { \bigint_use:N \l_testa_bigint } % we hope for a value of -30
%     \bigint_gzero:N \g_testa_bigint
%     \bigint_set:Nn \l_testa_bigint { 5 / \g_testa_bigint  } % that's division by zero
%     \TYPE { \bigint_use:N \l_testa_bigint } % no idea what TeX does here ...
%   }

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% adding and substracting
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\TEST { adding~and~subtracting }
  {
    \bigint_zero:N \l_testa_bigint
    \bigint_add:Nn \l_testa_bigint { 35 }
    \bigint_add:Nn \l_testa_bigint { 15 }
    \TYPE { \bigint_use:N \l_testa_bigint } % we hope for a value of 50
    \bigint_sub:Nn \l_testa_bigint { 15 }
    \TYPE { \bigint_use:N \l_testa_bigint } % we hope for a value of 35
    \bigint_gzero:N \g_testa_bigint
    {
      \bigint_gadd:Nn \g_testa_bigint { 3 }
      \bigint_gadd:Nn \g_testa_bigint { 3 }
      \TYPE { \bigint_use:N \g_testa_bigint } % we hope for a value of 6
      \bigint_gsub:Nn \g_testa_bigint { 25 }
    }
    \TYPE { \bigint_use:N \g_testa_bigint } % we hope for a value of -19
  }


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% evaluating biginteger expressions
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\TESTEXP { evaluating~biginteger~expressions }
  {
    \bigint_value:n { 505 } \space
    \bigint_compare:nNnTF { 17 } < { 205 } \YES \NO         \space
    \bigint_compare:nNnF  { 17 } < { 205 } \NO              \space
    \bigint_compare:nNnTF { \g_testa_bigint } = { -19 } \YES \NO  \space
    \bigint_compare:nNnT  { \g_testa_bigint } = { -19 } \YES      \space
    \bigint_compare:nNnTF
      { \bigint_max:nn { 1 } { 7 } }
      = { \bigint_add:nn { \bigint_min:nn { 5 } { 8 } } { 2 } }
      \YES \NO
  }

\TESTEXP { Case~statements }
  {
    \bigint_case:nnn
      { -00000000 }
      {
        { -1 } { \NO }
        { 0 } { \YES }
      }
    { \NO }
  \NEWLINE
  \bigint_case:nnn
    { 0 }
    {
      {      0 }   { \YES }
      { \ERROR } { \ERROR }
    }
    { \NO }
  \NEWLINE
  \bigint_case:nnn
    { 2 }
    { { ---2 } { \NO } }
    { \YES }
  }

\TYPE { Addition~and~subtraction }
  {
    \TYPE { \bigint_add:nn { 1111111} { 2222222 } } % expect +3333333
    \TYPE { \bigint_add:nn { 123456 } { 345 } } % expect +123801
    \TYPE { \bigint_add:nn { -123456 } { 345 } } % expect -123111
    \TYPE { \bigint_sub:nn { 1234 } { 2345678 } } % expect -2344444
    \TYPE { \bigint_sub:nn { 1 } { -12345678901234567890 } }
    % +12345678901234567891
  }


\END
